<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeHub v6 - Integrated Terminal</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Memuat Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Memuat jsPDF & AutoTable untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Memuat html2canvas untuk konversi HTML ke gambar (diperlukan untuk PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Memuat PDF.js & JSZip untuk fitur ekspor gambar dan backup ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <!-- PENTING: Memuat Google Identity Services (GSI) untuk otentikasi -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="https://apis.google.com/js/api.js" async defer></script>


    <!-- Gaya Kustom -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Anton&family=Bebas+Neue&family=Bitter&family=Caveat&family=Cormorant+Garamond&family=Dancing+Script&family=EB+Garamond&family=Fira+Code&family=Indie+Flower&family=Inconsolata&family=JetBrains+Mono&family=Lato&family=Lobster&family=Lora&family=Merriweather&family=Montserrat&family=Nunito+Sans&family=Open+Sans&family=Orbitron&family=Oswald&family=Pacifico&family=Playfair+Display&family=Poppins&family=Raleway&family=Roboto&family=Shadows+Into+Light+Two&family=Source+Code+Pro&family=Space+Mono&family=Ubuntu&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');
        
        :root {
            /* [DEFAULT] Dark Purple Theme */
            --bg-gradient: linear-gradient(135deg, #0F0A20, #1A1033, #2E0B4D, #4A148C);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --card-bg: rgba(15, 10, 32, 0.4);
            --card-border: rgba(255, 255, 255, 0.05);
            --sidebar-bg: rgba(26, 16, 51, 0.8);
            --sidebar-border: rgba(192, 132, 252, 0.1);
            --input-bg: rgba(15, 10, 32, 0.5);
            --input-border: rgba(192, 132, 252, 0.2);
            --input-focus-border: #c084fc;
            --active-nav-bg: rgba(192, 132, 252, 0.2);
            --active-nav-border: #c084fc;
            --hover-nav-bg: rgba(192, 132, 252, 0.1);
            --hover-nav-border: #a855f7;
            --primary-brand: #c084fc;
            --danger-brand: #f472b6;
            --button-bg: linear-gradient(90deg, #9333ea, #7e22ce);
            --button-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
            --tab-active-bg: rgba(192, 132, 252, 0.2);
            --tab-active-border: #c084fc;
            --tab-hover-bg: rgba(192, 132, 252, 0.1);
        }

        body.light-mode {
            /* Light Theme */
            --bg-gradient: linear-gradient(135deg, #f3e8ff, #faf5ff, #f5f3ff);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.1);
            --sidebar-bg: #ffffff;
            --sidebar-border: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --input-focus-border: #9333ea;
            --active-nav-bg: rgba(147, 51, 234, 0.1);
            --active-nav-border: #9333ea;
            --hover-nav-bg: rgba(147, 51, 234, 0.05);
            --hover-nav-border: #a855f7;
            --primary-brand: #9333ea;
            --danger-brand: #ec4899;
        }

        body.black-mode {
            --bg-gradient: linear-gradient(135deg, #111, #000);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --card-bg: rgba(20, 20, 20, 0.6);
            --card-border: rgba(255, 255, 255, 0.1);
            --sidebar-bg: rgba(10, 10, 10, 0.85);
            --sidebar-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(25, 25, 25, 0.7);
            --input-border: rgba(255, 255, 255, 0.15);
            --input-focus-border: #00f0ff; /* Cyan glow */
            --active-nav-bg: rgba(0, 240, 255, 0.15);
            --active-nav-border: #00f0ff;
            --hover-nav-bg: rgba(0, 240, 255, 0.1);
            --hover-nav-border: #00f0ff;
            --primary-brand: #00f0ff; /* Cyan as primary brand */
            --danger-brand: #ff2a6d; /* Neon Pink for danger */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            transition: background 0.5s, color 0.5s;
            overflow-x: hidden;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-bg {
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
        }
        body.light-mode .gradient-bg,
        body.black-mode .gradient-bg {
            animation: none;
        }
        
        .glass-effect {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        body.light-mode .glass-effect {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .glass-effect:hover {
            border-color: rgba(192, 132, 252, 0.2);
        }
        .black-mode .glass-effect:hover {
            border-color: var(--hover-nav-border);
        }

        .custom-input, .custom-select, .code-textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        .custom-input:focus, .custom-select:focus, .code-textarea:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 10px var(--input-focus-border, 0.3);
        }
        .custom-input::placeholder {
            color: var(--text-secondary);
        }

        .custom-button {
            background: var(--button-bg);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: var(--button-shadow);
            border: none;
            cursor: pointer;
        }
        .custom-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(147, 51, 234, 0.5);
        }
        .custom-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .custom-button-danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .custom-button-danger:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }
        .custom-button-secondary {
            background: linear-gradient(90deg, #374151, #1f2937);
            box-shadow: 0 4px 15px rgba(55, 65, 81, 0.3);
        }
        .custom-button-secondary:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(55, 65, 81, 0.5);
        }

        .black-mode .custom-button {
            background: linear-gradient(90deg, #00c3ff, #008cff);
            box-shadow: 0 4px 15px rgba(0, 200, 255, 0.3);
        }
        .black-mode .custom-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(0, 200, 255, 0.5);
        }
        .black-mode .custom-button-danger {
            background: linear-gradient(90deg, #ff4d4d, #ff0000);
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        }
        .black-mode .custom-button-danger:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }

        .nav-item {
            transition: all 0.3s ease;  
            cursor: pointer;  
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;  
            border-radius: 0.5rem;  
            border-left: 3px solid transparent;
        }
        .nav-item:hover {  
            background-color: var(--hover-nav-bg);  
            border-left-color: var(--hover-nav-border);  
        }
        .nav-item.active {  
            background-color: var(--active-nav-bg);  
            border-left-color: var(--active-nav-border);  
            color: var(--primary-brand);  
            font-weight: 500;
        }
        body.light-mode .nav-item.active {
            color: var(--primary-brand);
        }

        .black-mode h1,
        .black-mode h2,
        .black-mode h3,
        .black-mode .font-bold,
        .black-mode .nav-item.active {
            text-shadow: 0 0 8px rgba(0, 240, 255, 0.4);
        }
        .black-mode #logo-icon {
            background: linear-gradient(to br, #00f0ff, #00a2ff);
        }
        .black-mode #logo-icon i {
            color: #002d3c;
        }
        .black-mode h1.text-purple-300,
        .black-mode h2.text-purple-300,
        .black-mode h3.text-purple-300,
        .black-mode .text-purple-300,
        .black-mode .text-purple-400 {
            color: var(--primary-brand);
        }
        .black-mode .text-pink-400 {
            color: #ff80c0;
        }
        .black-mode .text-blue-400 {
            color: #80bfff;
        }


        .modal {  
            display: none;  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background-color: rgba(0, 0, 0, 0.7);  
            backdrop-filter: blur(5px);
            z-index: 1000;  
            animation: fadeIn 0.3s ease;  
        }
        .modal.show {  
            display: flex;  
            align-items: center;  
            justify-content: center;  
        }
        .modal-content {
            max-width: 90vw;  
            max-height: 90vh;  
            overflow-y: auto;  
            animation: modalAppear 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalAppear { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .income { border-left: 4px solid #4ade80; }
        .expense { border-left: 4px solid #f472b6; }
        
        .task-item.completed { opacity: 0.6; text-decoration: line-through; }

        .hidden { display: none !important; }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            height: 100vh;  
            overflow-y: auto;  
            position: fixed;  
            left: -250px;  
            top: 0;  
            width: 250px;
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--sidebar-border);  
            z-index: 100;  
            transition: left 0.3s ease, opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .sidebar.open { left: 0; }
        
        .overlay {  
            display: none;  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background-color: rgba(0, 0, 0, 0.5);  
            z-index: 99;  
        }
        .overlay.show { display: block; }
        
        .main-content {  
            flex-grow: 1;
            width: 100%;
            transition: margin-left 0.3s ease;  
        }
        
        .main-content > .p-6 {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        @media (min-width: 768px) {  
            .sidebar {  
                position: relative;
                left: 0;  
                flex-shrink: 0;
                height: auto; 
            }
            .main-content {
                width: calc(100% - 250px);
            }
            #mobileMenuBtn, .overlay, .main-header {
                display: none;
            }
        }
        
        @media (max-width: 767px) {
            .app-container {
                display: block;
            }
             .main-content {
                padding-top: 70px;
            }
        }

        #bg-video, #bg-image-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
            display: none;
        }
        #bg-image-layer {
            background-size: cover;
            background-position: center;
        }

        #mobileMenuBtn {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        body.preview-mode .sidebar,
        body.preview-mode .main-content > .p-6,
        body.preview-mode #mobileMenuBtn,
        body.preview-mode .main-header {
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }

        .range-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .range-btn:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .range-btn.active {
            background-color: var(--primary-brand);
            color: white;
            box-shadow: 0 2px 10px rgba(192, 132, 252, 0.4);
        }
        body.light-mode .range-btn.active,
        body.black-mode .range-btn.active {
            color: white;
        }
        body.black-mode .range-btn.active {
             box-shadow: 0 2px 10px rgba(0, 240, 255, 0.4);
        }


        .chart-container {
            height: 350px;
            position: relative;
        }

        #notes-section .notes-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .note-item {
            border: 1px solid var(--card-border);
            transition: background-color 0.3s ease;
        }
        .note-item:hover {
            background-color: var(--hover-nav-bg);
        }
        .tag {
            background-color: var(--primary-brand);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        #hack-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: none;
            color: #0f0;
            font-family: 'Fira Code', monospace;
            padding: 2rem;
            overflow: hidden;
        }
        .hack-text {
            white-space: pre-wrap;
            font-size: 1.1rem;
            line-height: 1.5;
            text-shadow: 0 0 5px #0f0;
        }
        .hack-text.glitch {
            animation: glitch 0.1s infinite;
        }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .typewriter-cursor {
            display: inline-block;
            background-color: #0f0;
            width: 10px;
            height: 1.2em;
            animation: blink 1s step-end infinite;
            margin-left: 5px;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #0f0; }
        }

        .sidebar-portal-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            color: var(--text-secondary);
            background-color: transparent;
            border: 1px solid transparent;
        }

        .sidebar-portal-item:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
            border-color: var(--hover-nav-border);
        }

        .sidebar-portal-item .portal-icon {
            width: 1.5rem;
            height: 1.5rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .sidebar-portal-item .portal-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .sidebar-portal-item .portal-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.875rem;
        }

        .sidebar-portal-item .delete-portal-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            margin-left: 0.5rem;
            color: var(--danger-brand);
        }

        .sidebar-portal-item:hover .delete-portal-btn {
            opacity: 1;
        }

        .portal-modal-label {
            color: var(--primary-brand);
            text-shadow: 0 0 5px var(--primary-brand);
        }
        .portal-color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }
        .portal-color-option:hover {
            transform: scale(1.1);
        }
        .portal-color-option.selected {
            border-color: var(--primary-brand);
            transform: scale(1.1);
        }
        .portal-color-option.selected::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 2px white;
        }
        .portal-custom-color-input {
            width: 100%;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 8px;
        }

        #avatar-container {
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            position: relative;
            box-shadow: 0 0 15px rgba(192, 132, 252, 0.4);
        }
        #user-picture {
            object-fit: cover;
        }

        #user-email {
            transition: filter 0.3s ease-in-out;
        }
        .email-blur {
            filter: blur(5px);
            user-select: none;
        }

        .pro-editor-container {
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            transition: all 0.3s ease;
        }
        .pro-editor-container:focus-within {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 10px var(--input-focus-border, 0.3);
        }

        #editor-master-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #editor-master-btn:hover {
            color: var(--primary-brand);
            border-color: var(--primary-brand);
            transform: scale(1.1);
        }

        .pro-toolbar {
            display: none;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--input-border);
            background-color: var(--sidebar-bg);
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .pro-toolbar.visible {
            display: flex;
        }

        .pro-toolbar-group {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0 0.5rem;
            border-right: 1px solid var(--input-border);
        }
        .pro-toolbar-group:last-child {
            border-right: none;
        }
        @media (max-width: 768px) {
            .pro-toolbar-group {
                border-right: none;
                padding: 0.25rem;
                background: rgba(0,0,0,0.1);
                border-radius: 6px;
            }
        }


        .pro-toolbar-button, .pro-toolbar-select, .pro-toolbar-color-wrapper {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            min-width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.5rem;
            font-size: 0.9rem;
        }
        .pro-toolbar-button:hover, .pro-toolbar-select:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .pro-toolbar-button.active {
            background-color: var(--active-nav-bg);
            color: var(--primary-brand);
        }
        .pro-toolbar-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.25rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 1.5rem;
        }
        .pro-toolbar-color-wrapper {
            position: relative;
            padding: 0;
        }
        .pro-toolbar-color-wrapper input[type="color"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .paste-dropdown-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .paste-dropdown-menu {
            display: none;
            position: absolute;
            top: 110%;
            left: 0;
            z-index: 20;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 0.5rem;
            width: max-content;
        }
        .paste-dropdown-container:hover .paste-dropdown-menu {
            display: block;
        }
        .paste-dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .paste-dropdown-menu button:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }

        .pro-editor-content {
            min-height: 400px;
            max-height: 65vh;
            padding: 1.5rem;
            overflow-y: auto;
            outline: none;
            color: var(--text-primary);
            line-height: 1.7;
            caret-color: var(--primary-brand);
        }
        .pro-editor-content[contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: var(--text-secondary);
            pointer-events: none;
            display: block;
        }
        .pro-editor-content h1, .pro-editor-content h2, .pro-editor-content h3 { border-bottom: 1px solid var(--input-border); padding-bottom: 0.3em; margin-bottom: 0.5em; }
        .pro-editor-content blockquote { border-left: 3px solid var(--primary-brand); margin-left: 0; padding-left: 1rem; color: var(--text-secondary); font-style: italic; }
        .pro-editor-content code { background: var(--card-bg); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.9em; }
        .pro-editor-content pre { background: #000; color: #f8f8f2; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; font-family: 'Fira Code', monospace; }
        .pro-editor-content table { width: 100%; border-collapse: collapse; }
        .pro-editor-content th, .pro-editor-content td { border: 1px solid var(--input-border); padding: 0.5rem; }
        .pro-editor-content th { background-color: var(--card-bg); }
        .pro-editor-content img, .pro-editor-content video { max-width: 100%; height: auto; border-radius: 8px; }
        .pro-editor-content .embedded-zip {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            margin: 1rem 0;
            cursor: default;
        }
        .pro-editor-content .embedded-zip i {
            font-size: 2.5rem;
            color: var(--primary-brand);
        }
        .pro-editor-content .zip-info {
            flex-grow: 1;
        }
        .pro-editor-content .zip-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        .pro-editor-content .zip-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }


        .pro-editor-statusbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--input-border);
            background-color: var(--sidebar-bg);
            border-radius: 0 0 0.5rem 0.5rem;
            flex-wrap: wrap;
        }
        .pro-statusbar-segment {
            cursor: default;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .pro-statusbar-segment:hover {
            background-color: var(--hover-nav-bg);
        }
        .pro-statusbar-segment i {
            margin-right: 0.5em;
        }
        
        .upload-progress-item {
            background-color: var(--input-bg);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--input-border);
        }
        .upload-progress-bar-bg {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            overflow: hidden;
            height: 6px;
        }
        .upload-progress-bar-fg {
            background: linear-gradient(90deg, #9333ea, #7e22ce);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }
        .black-mode .upload-progress-bar-fg {
            background: linear-gradient(90deg, #00c3ff, #008cff);
        }

        #filePreviewModal .modal-content {
            height: 90vh;
            width: 90vw;
            max-width: 1200px;
        }
        #preview-content-container {
            position: relative;
        }
        #preview-content-container img,
        #preview-content-container video,
        #preview-content-container iframe,
        #preview-content-container canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            margin: auto;
        }
        #preview-content-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff; /* Latar belakang untuk dokumen */
        }
        #preview-content-container pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
            background-color: var(--input-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            height: 100%;
            width: 100%;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
        }
        
        /* Gaya untuk Editor HTML yang Diperbarui */
        .code-textarea {
            font-family: 'Fira Code', 'JetBrains Mono', monospace;
            min-height: 300px;
            height: 55vh; /* Tinggi yang disesuaikan */
            resize: vertical;
            line-height: 1.6;
            font-size: 14px;
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: transparent;
        }
        .tab-btn:hover {
            background-color: var(--tab-hover-bg);
        }
        .tab-btn.active {
            color: var(--primary-brand);
            border-color: var(--input-border);
            background-color: var(--input-bg);
        }
        #html-preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
            border-radius: 0.5rem;
        }
        #preview-panel {
            position: relative;
        }
        #preview-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
            display: flex;
            gap: 0.5rem;
        }
        .control-btn {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .control-btn:hover {
            color: var(--primary-brand);
            border-color: var(--primary-brand);
        }
        .html-note-item {
            border: 1px solid var(--card-border);
            transition: background-color 0.3s ease;
        }
        .html-note-item:hover {
            background-color: var(--hover-nav-bg);
        }
        .html-note-item.active {
            background-color: var(--active-nav-bg);
            border-left: 3px solid var(--active-nav-border);
        }

        #html-editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--input-border);
        }
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0 0.5rem;
        }
        .toolbar-separator {
            width: 1px;
            height: 20px;
            background-color: var(--input-border);
            margin: 0 0.5rem;
        }
        .toolbar-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .toolbar-btn:hover:not(:disabled) {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .toolbar-search-wrapper {
            position: relative;
            display: none;
        }
        .toolbar-search-wrapper input {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            width: 150px;
            font-size: 0.875rem;
        }

        /* --- WATERMARK CSS START --- */
         :root {
            --glow-color: hsl(186, 100%, 50%);
            --background-color: rgba(10, 25, 40, 0.85);
            --border-color: rgba(127, 255, 212, 0.3);
            --text-color: rgba(230, 255, 255, 0.95);
            --particle-base-hue: 186;
            --particle-base-lightness: 60;
         }

         @keyframes slideUpFadeIn {
             from { opacity: 0; transform: translateY(15px); }
             to { opacity: 1; transform: translateY(0); }
         }

         @keyframes logo3DFlip {
             0% { transform: rotateY(0deg); filter: brightness(1); }
             50% { transform: rotateY(180deg); filter: brightness(2) drop-shadow(0 0 8px var(--glow-color)); }
             100% { transform: rotateY(360deg); filter: brightness(1); }
         }
        
         #futuristic-watermark {
             position: fixed;
             bottom: 25px;
             left: 25px;
             padding: 8px 15px;
             min-width: 212px;
             background: var(--background-color);
             color: var(--text-color);
             font-family: 'Roboto Mono', monospace;
             font-weight: 500;
             backdrop-filter: blur(18px);
             -webkit-backdrop-filter: blur(18px);
             border: 1px solid var(--border-color);
             border-radius: 10px;
             box-shadow: 0 0 15px rgba(var(--glow-color), 0.15),
                         0 0 30px rgba(var(--glow-color), 0.1),
                         inset 0 0 10px rgba(var(--glow-color), 0.1);
             z-index: 9999;
             cursor: pointer;
             user-select: none;
             overflow: hidden;
             opacity: 0;
             animation: slideUpFadeIn 1s ease-out 0.5s forwards;
             transition: opacity 0.3s ease 0.2s, transform 0.3s ease 0.2s, background-color 0.5s ease, color 0.5s ease, box-shadow 0.3s ease, border-color 0.3s ease;
         }
        
         #futuristic-watermark:hover {
             transform: translateY(-5px) scale(1.03);
             border-color: rgba(127, 255, 212, 0.8);
             box-shadow: 0 0 25px rgba(var(--glow-color), 0.4),
                         0 0 50px rgba(var(--glow-color), 0.25),
                         inset 0 0 12px rgba(var(--glow-color), 0.2);
         }

         #futuristic-watermark.light-mode {
             --glow-color: hsl(220, 90%, 60%);
             --background-color: rgba(245, 248, 252, 0.85);
             --border-color: rgba(60, 100, 150, 0.3);
             --text-color: rgba(10, 25, 40, 0.95);
             --particle-base-hue: 220;
             --particle-base-lightness: 40;
         }
        
         #particle-canvas {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             z-index: 1;
             pointer-events: none;
         }

         .f-content-wrapper {
             position: relative;
             z-index: 2;
             display: flex;
             align-items: center;
             justify-content: center;
             min-height: 18px;
         }

         .f-content {
             display: flex;
             align-items: center;
             gap: 10px;
             transition: opacity 0.4s ease, transform 0.4s ease;
         }

         .f-content.hidden {
             opacity: 0;
             pointer-events: none;
             position: absolute;
             transform: scale(0.9);
         }

         .f-logo-container {
             width: 18px;
             height: 18px;
             transition: transform 0.4s ease;
             flex-shrink: 0;
         }

         .f-logo-container.reacting {
             animation: logo3DFlip 0.7s cubic-bezier(0.22, 1, 0.36, 1);
         }
        
         .f-logo-container svg {
              width: 100%;
              height: 100%;
              stroke: var(--glow-color);
              stroke-width: 8;
              transition: stroke 0.5s ease;
         }
        
         #f-watermark-text, #f-follow-message {
              transition: color 0.5s ease;
         }

         #f-watermark-text {
              font-size: 12px;
              letter-spacing: 1px;
              text-transform: uppercase;
         }
        
         #f-follow-message {
             font-size: 11px;
             letter-spacing: 0.2px;
             font-weight: 700;
             text-align: center;
             white-space: nowrap;
         }
        /* --- WATERMARK CSS END --- */
        
        /* [BARU] Aturan untuk menyembunyikan watermark saat menu mobile terbuka */
        body.sidebar-is-open #futuristic-watermark {
            opacity: 0;
            transform: translateX(-120%); /* Efek geser keluar */
            pointer-events: none;
        }

        /* [BARU] Premium Popup Styles */
        #premiumModalContent {
            animation: fadeInBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border: 1px solid #facc15; /* Gold border */
            box-shadow: 0 0 30px rgba(250, 204, 21, 0.3);
        }

        @keyframes fadeInBounce {
            0% {
                opacity: 0;
                transform: scale(0.7);
            }
            80% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .premium-lock-icon {
            font-size: 5rem; /* 80px */
            margin-bottom: 1rem;
            color: #facc15;
            animation: neonGlowPulse 2s infinite alternate;
        }

        @keyframes neonGlowPulse {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fde047, 0 0 20px #fde047, 0 0 25px #fde047, 0 0 30px #fde047, 0 0 35px #fde047;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #facc15, 0 0 40px #facc15, 0 0 50px #facc15, 0 0 60px #facc15, 0 0 70px #facc15;
            }
        }

        .premium-upgrade-btn {
            background: linear-gradient(90deg, #facc15, #eab308);
            color: #422006;
            font-weight: bold;
            text-transform: uppercase;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);
            border: none;
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
        }

        .premium-upgrade-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(250, 204, 21, 0.6);
        }

        .premium-benefits-list {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
            color: var(--text-secondary);
        }
        .premium-benefits-list li {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }
        .premium-benefits-list li span {
            margin-right: 0.75rem;
            width: 24px;
            text-align: center;
        }

    </style>
</head>
<body class="gradient-bg">
    <!-- Elemen untuk background media -->
    <div id="bg-image-layer"></div>
    <video autoplay loop muted id="bg-video"></video>

    <!-- PENAMBAHAN: Overlay untuk Fake Hack Effect -->
    <div id="hack-overlay">
        <pre id="hack-text" class="hack-text"></pre>
    </div>

    <!-- Overlay for mobile -->
    <div id="overlay" class="overlay"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="p-6 h-full flex flex-col">
                <!-- Bagian Atas (Logo, Judul, Mode) -->
                <div>
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center space-x-3">
                            <div id="logo-container" class="w-14 h-14 rounded-full flex items-center justify-center cursor-pointer" title="Masuk Mode Pratinjau">
                                <img src="https://i.imghippo.com/files/YXY6439eaY.png" alt="Uranus Space Logo" class="w-full h-full object-cover rounded-full">
                            </div>
                            <h1 class="text-3xl font-bold text-purple-300">Uranus Space</h1>
                        </div>
                        <button id="themeToggle" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-purple-500/10 text-purple-300" title="Toggle Theme">
                            <i class="fas fa-sun"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <label for="modeSelect" class="block text-sm font-medium mb-2 text-purple-300">Mode Terminal</label>
                        <select id="modeSelect" class="custom-input">
                            <option value="personal">Pribadi</option>
                            <option value="business">Bisnis</option>
                        </select>
                    </div>
                    
                    <!-- Navigasi Utama -->
                    <nav>
                        <div class="nav-item active" data-section="dashboard"><i class="fas fa-tachometer-alt mr-3 w-5"></i>Dashboard</div>
                        <div class="nav-item" data-section="finance"><i class="fas fa-wallet mr-3 w-5"></i>Manajemen Keuangan</div>
                        <div class="nav-item" data-section="tasks"><i class="fas fa-tasks mr-3 w-5"></i>Manajemen Waktu</div>
                        <div class="nav-item" data-section="split"><i class="fas fa-receipt mr-3 w-5"></i>Split Bill</div>
                        <div class="nav-item flex items-center" data-section="notes" data-premium="true"><i class="fas fa-book mr-3 w-5"></i>Catatan Profesional <i class="fas fa-lock text-yellow-500 ml-auto text-xs"></i></div>
                        <div class="nav-item flex items-center" data-section="html-editor" data-premium="true"><i class="fas fa-code mr-3 w-5"></i>Editor HTML <i class="fas fa-lock text-yellow-500 ml-auto text-xs"></i></div>
                        <div class="nav-item" data-section="settings"><i class="fas fa-cog mr-3 w-5"></i>Pengaturan</div>
                    </nav>
                </div>

                <!-- Container untuk Portal di Sidebar -->
                <div class="mt-8 pt-6 border-t border-[var(--sidebar-border)] flex-grow flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-purple-300">Portal Tautan</h3>
                        <button id="addNewPortalBtn" class="custom-button !p-2 !text-xs" title="Tambah Portal Baru">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <!-- Daftar Portal akan dirender di sini oleh JavaScript -->
                    <div id="sidebar-portals-container" class="flex-grow overflow-y-auto pr-2 space-y-2">
                        <!-- Konten portal akan diisi oleh JS -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
             <!-- Header baru ditambahkan untuk menampung tombol hamburger dan judul di mobile -->
            <header class="main-header p-4 glass-effect md:hidden fixed top-0 left-0 right-0 z-40">
                <div class="flex items-center justify-between">
                    <button id="mobileMenuBtn" class="custom-button !p-3">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center">
                             <img src="https://i.imghippo.com/files/YXY6439eaY.png" alt="Uranus Space Logo" class="w-full h-full object-cover rounded-full">
                        </div>
                        <h1 class="text-2xl font-bold text-purple-300">Uranus Space</h1>
                    </div>
                    <!-- Placeholder to balance the flexbox -->
                    <div class="w-12"></div>
                </div>
            </header>

            <div class="p-6 relative z-10">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Dashboard</h2>
                        <div id="master-range-selector" class="flex items-center gap-1 bg-purple-900/30 p-1 rounded-md glass-effect">
                            <button data-range="7d" class="range-btn active" title="7 Hari">7H</button>
                            <button data-range="1m" class="range-btn" title="1 Bulan">1B</button>
                            <button data-range="3m" class="range-btn" title="3 Bulan">3B</button>
                            <button data-range="1y" class="range-btn" title="1 Tahun">1T</button>
                            <button data-range="all" class="range-btn" title="Selamanya">∞</button>
                            <button data-range="custom" class="range-btn" title="Pilih Rentang"><i class="fas fa-calendar-alt"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Saldo Total</h3><p class="text-2xl font-bold" id="totalBalance">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Hari Ini</h3><p class="text-2xl font-bold" id="todayTasksCount">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Tertunda</h3><p class="text-2xl font-bold" id="pendingTasks">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Mode Aktif</h3><p class="text-2xl font-bold" id="activeMode">Pribadi</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold text-blue-400 mb-4">Arus Kas</h3>
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold text-pink-400 mb-4">Produktivitas</h3>
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-effect p-6 mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-400">Aktivitas Terkini</h3>
                        <div id="recentActivities" class="space-y-2"></div>
                    </div>

                    <h2 class="text-3xl font-bold mb-6 mt-10 text-purple-300">Analisis Mendalam</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-purple-400">Analisis Gabungan Fitur</h3>
                            <div class="chart-container" style="height: 450px;">
                                <canvas id="combinedAnalysisChart"></canvas>
                            </div>
                        </div>

                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Keuangan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Pemasukan vs Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="incomeVsExpenseChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                     <p class="text-md font-medium text-purple-300 mb-2">Alokasi Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="spendingByCategoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold mb-4 text-pink-400">Analisis Produktivitas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Tren Penyelesaian Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskCompletionTrendChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Distribusi Prioritas Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskPriorityDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-green-400">Analisis Split Bill</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Total Pengeluaran per Orang</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillByUserChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Frekuensi Split Bill</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillFrequencyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Catatan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2 text-center">Frekuensi Entri Catatan</p>
                                    <div class="chart-container h-64">
                                        <canvas id="diaryEntryFrequencyChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2 text-center">Analisis Mood</p>
                                    <div class="chart-container h-64">
                                        <canvas id="noteMoodAnalysisChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Section -->
                <div id="finance-section" class="section hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Manajemen Keuangan</h2>
                        <div class="flex gap-2">
                            <button id="addTransactionBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            <button id="exportFinanceBtn" class="custom-button" style="background: linear-gradient(90deg, #10b981, #059669);"><i class="fas fa-file-pdf mr-2"></i>Laporan</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-green-400 mb-2">Pemasukan</h3><p class="text-2xl font-bold" id="totalIncome">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-pink-400 mb-2">Pengeluaran</h3><p class="text-2xl font-bold" id="totalExpense">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-blue-400 mb-2">Saldo</h3><p class="text-2xl font-bold" id="balance">Rp 0</p></div>
                    </div>

                    <div class="glass-effect p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                            <input type="text" id="searchTransaction" placeholder="Cari transaksi..." class="custom-input md:col-span-2">
                            <select id="categoryFilter" class="custom-input"></select>
                            <select id="typeFilter" class="custom-input"></select>
                            <button id="financeDateFilterBtn" class="custom-button"><i class="fas fa-calendar-alt mr-2"></i>Filter Tanggal</button>
                        </div>
                    </div>

                    <div class="glass-effect p-6">
                        <h3 class="text-xl font-semibold mb-4 text-pink-400">Daftar Transaksi</h3>
                        <div id="transactionsList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tasks & Plans Section -->
                <div id="tasks-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Manajemen Waktu</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Tambah Tugas</h3>
                                <form id="taskForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Tugas</label><input type="text" id="taskTitle" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Tanggal & Waktu</label><input type="datetime-local" id="taskDateTime" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Prioritas</label><select id="taskPriority" class="custom-input"><option value="low">Rendah</option><option value="medium">Sedang</option><option value="high">Tinggi</option></select></div>
                                    <button type="submit" class="custom-button w-full">Tambah Tugas</button>
                                </form>
                            </div>
                            <div class="glass-effect p-6 text-center">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Pomodoro Timer</h3>
                                <div id="timerDisplay" class="text-5xl font-mono my-4">25:00</div>
                                <div class="flex gap-2 justify-center">
                                    <button id="startTimerBtn" class="custom-button bg-green-600 hover:bg-green-500"><i class="fas fa-play"></i></button>
                                    <button id="pauseTimerBtn" class="custom-button bg-yellow-600 hover:bg-yellow-500"><i class="fas fa-pause"></i></button>
                                    <button id="resetTimerBtn" class="custom-button custom-button-danger"><i class="fas fa-sync"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div class="glass-effect p-6">
                                 <h3 class="text-xl font-semibold mb-4 text-blue-400">Daftar Tugas</h3>
                                 <div id="taskList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                            </div>
                            <div class="glass-effect p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <button id="prevMonth" class="custom-button !p-3"><i class="fas fa-chevron-left"></i></button>
                                    <span id="currentMonth" class="text-xl font-semibold text-pink-400"></span>
                                    <button id="nextMonth" class="custom-button !p-3"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div id="calendar" class="grid grid-cols-7 gap-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Split Bill Section -->
                <div id="split-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Split Bill</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="glass-effect p-6 mb-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Kalkulator Bill</h3>
                                <form id="splitBillForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Total Tagihan</label><input type="number" id="totalBill" class="custom-input" required></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Tanggal</label>
                                        <input type="date" id="splitBillDate" class="custom-input" required>
                                    </div>
                                    <div><label class="block text-sm font-medium mb-1">Nama (pisahkan koma)</label><input type="text" id="peopleNames" class="custom-input" placeholder="Zedd, Jett, Omen" required></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Persentase (opsional, pisahkan koma)</label>
                                        <input type="text" id="splitPercentages" class="custom-input" placeholder="25, 75">
                                        <p class="text-xs text-gray-400 mt-1">Kosongkan untuk membagi rata.</p>
                                    </div>
                                    <button type="submit" class="custom-button w-full">Hitung</button>
                                </form>
                            </div>
                            <div id="splitResultCard" class="glass-effect p-6 hidden">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Hasil Pembagian</h3>
                                <div id="splitResult"></div>
                                <button id="exportSplitBtn" class="custom-button custom-button-danger w-full mt-4">Export PDF</button>
                            </div>
                        </div>
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Riwayat Split Bill</h3>
                            <div id="splitHistory" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div id="notes-section" class="section hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                         <h2 class="text-3xl font-bold text-purple-300">Catatan Profesional</h2>
                         <div class="flex gap-2">
                                <button id="notesAddNewBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Catatan Baru</button>
                         </div>
                    </div>
                    <div class="notes-container">
                        <div class="glass-effect p-4 mb-6">
                            <h3 class="font-semibold text-lg text-pink-400 mb-2">Manajemen Font Kustom</h3>
                            <div class="flex items-center gap-4">
                                <div class="flex-grow">
                                    <label for="customFontUploader" class="block text-sm font-medium mb-1">Unggah Font Baru (.ttf, .otf, .woff)</label>
                                    <input type="file" id="customFontUploader" class="custom-input !p-2" accept=".otf,.ttf,.woff,.woff2">
                                </div>
                                <button id="clearCustomFontsBtn" class="custom-button custom-button-danger" title="Hapus Semua Font Kustom">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Font yang diunggah akan tersimpan di browser Anda dan muncul di pilihan editor.</p>
                        </div>

                        <div id="notesEditorSection" class="glass-effect p-4">
                            <input type="text" id="notesTitleInput" class="custom-input mb-4 text-xl" placeholder="Judul Catatan...">
                            
                            <div class="pro-editor-container">
                                <button id="editor-master-btn" title="Tampilkan Opsi Pemformatan">
                                    <span class="font-bold">A</span><i class="fas fa-ellipsis-v ml-1"></i>
                                </button>
                
                                <div id="pro-toolbar" class="pro-toolbar">
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="undo" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                                        <button class="pro-toolbar-button" data-command="redo" title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                                    </div>
                                    
                                    <div class="pro-toolbar-group">
                                        <select class="pro-toolbar-select" data-command="fontName" title="Jenis Font">
                                        </select>
                                        <div class="flex items-center" title="Ukuran Teks">
                                            <button class="pro-toolbar-button" data-command="decreaseFontSize">A-</button>
                                            <input type="number" id="custom-font-size" class="w-12 text-center bg-transparent" value="16" min="8" max="72">
                                            <button class="pro-toolbar-button" data-command="increaseFontSize">A+</button>
                                        </div>
                                    </div>
                                    
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="bold" title="Bold (Ctrl+B)"><i class="fas fa-bold"></i></button>
                                        <button class="pro-toolbar-button" data-command="italic" title="Italic (Ctrl+I)"><i class="fas fa-italic"></i></button>
                                        <button class="pro-toolbar-button" data-command="underline" title="Underline (Ctrl+U)"><i class="fas fa-underline"></i></button>
                                        <button class="pro-toolbar-button" data-command="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                                    </div>
                                    
                                    <div class="pro-toolbar-group">
                                        <div class="pro-toolbar-color-wrapper" title="Warna Teks">
                                            <i class="fas fa-font"></i>
                                            <input type="color" data-command="foreColor">
                                        </div>
                                        <div class="pro-toolbar-color-wrapper" title="Warna Sorot (Highlight)">
                                            <i class="fas fa-highlighter"></i>
                                            <input type="color" data-command="backColor">
                                        </div>
                                    </div>
                                    
                                    <div class="pro-toolbar-group">
                                        <select class="pro-toolbar-select" data-command="formatBlock" title="Gaya Paragraf">
                                            <option value="p">Paragraf</option>
                                            <option value="h1">Heading 1</option>
                                            <option value="h2">Heading 2</option>
                                            <option value="h3">Heading 3</option>
                                            <option value="blockquote">Kutipan</option>
                                        </select>
                                    </div>
                                    
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="justifyLeft" title="Rata Kiri"><i class="fas fa-align-left"></i></button>
                                        <button class="pro-toolbar-button" data-command="justifyCenter" title="Rata Tengah"><i class="fas fa-align-center"></i></button>
                                        <button class="pro-toolbar-button" data-command="justifyRight" title="Rata Kanan"><i class="fas fa-align-right"></i></button>
                                        <button class="pro-toolbar-button" data-command="justifyFull" title="Rata Kanan Kiri"><i class="fas fa-align-justify"></i></button>
                                    </div>
                
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                                        <button class="pro-toolbar-button" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                                    </div>
                                    
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="createLink" title="Sisipkan Tautan"><i class="fas fa-link"></i></button>
                                        <button class="pro-toolbar-button" data-command="embedMediaUrl" title="Sematkan Gambar/Video dari URL"><i class="fas fa-photo-video"></i></button>
                                        <button class="pro-toolbar-button" data-command="embedYouTube" title="Sematkan Video YouTube"><i class="fab fa-youtube"></i></button>
                                        <button class="pro-toolbar-button" data-command="embedTikTok" title="Sematkan Video TikTok"><i class="fab fa-tiktok"></i></button>
                                        <button class="pro-toolbar-button" data-command="uploadFile" title="Unggah File (Gambar, Video, ZIP)"><i class="fas fa-upload"></i></button>
                                        <button class="pro-toolbar-button" data-command="insertHorizontalRule" title="Garis Horizontal"><i class="fas fa-minus"></i></button>
                                    </div>
                
                                    <div class="pro-toolbar-group">
                                         <button class="pro-toolbar-button" data-command="clearFormatting" title="Hapus Format"><i class="fas fa-eraser"></i></button>
                                    </div>
                                </div>
                
                                <div id="pro-editor-content" class="pro-editor-content" contenteditable="true" placeholder="Mulai menulis atau jatuhkan file di sini...">
                                </div>
                
                                <div class="pro-editor-statusbar">
                                    <div class="flex items-center gap-4">
                                        <span id="word-count" class="pro-statusbar-segment" title="Jumlah Kata"><i class="fas fa-file-word"></i>0 Kata</span>
                                        <span id="char-count" class="pro-statusbar-segment" title="Jumlah Karakter"><i class="fas fa-keyboard"></i>0 Karakter</span>
                                        <span id="reading-time" class="pro-statusbar-segment" title="Waktu Baca"><i class="fas fa-clock"></i>0 mnt</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span id="save-status" class="pro-statusbar-segment" title="Status Penyimpanan"><i class="fas fa-cloud"></i>Tersimpan</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-4 mt-4">
                                <input type="date" id="notesDateFilter" class="custom-input flex-1">
                                <select id="notesMoodSelector" class="custom-input flex-1">
                                    <option value="neutral">Netral</option>
                                    <option value="happy">Senang</option>
                                    <option value="sad">Sedih</option>
                                    <option value="excited">Bersemangat</option>
                                    <option value="angry">Marah</option>
                                </select>
                                <input type="text" id="notesTagsInput" class="custom-input flex-1" placeholder="Tags, pisahkan koma">
                            </div>

                            <div class="flex flex-wrap gap-2 mt-4">
                                <button id="notesSaveBtn" class="custom-button flex-grow"><i class="fas fa-save mr-2"></i>Simpan</button>
                                <button id="notesSetPasswordBtn" class="custom-button flex-grow" style="background: linear-gradient(90deg, #f59e0b, #d97706);"><i class="fas fa-lock mr-2"></i>Kunci</button>
                                <button id="notesClearEditorBtn" class="custom-button custom-button-danger"><i class="fas fa-eraser mr-2"></i>Bersihkan</button>
                            </div>
                        </div>
                        
                        <div class="glass-effect p-4 space-y-4 mt-6">
                            <h3 class="font-semibold text-lg text-pink-400">Kontrol & Filter Catatan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="search" id="notesSearchInput" class="custom-input" placeholder="Cari berdasarkan judul, isi, atau tag...">
                                <select id="notesMoodFilter" class="custom-input">
                                    <option value="">Semua Mood</option>
                                    <option value="happy">Senang</option>
                                    <option value="sad">Sedih</option>
                                    <option value="neutral">Netral</option>
                                    <option value="excited">Bersemangat</option>
                                    <option value="angry">Marah</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="glass-effect p-4 mt-6">
                            <h3 class="font-semibold text-lg text-pink-400 mb-2">Daftar Catatan</h3>
                            <div id="notesList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        </div>
                
                    </div>
                </div>
                
                <div id="settings-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Pengaturan</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Data & Laporan <i class="fas fa-lock text-yellow-500 ml-1 text-xs"></i></h3>
                            <div class="space-y-4" data-premium="true">
                                
                                <div class="p-4 rounded-lg border border-purple-500/20 space-y-3">
                                    <label for="pdf-time-range" class="block text-sm font-medium text-purple-300">Download Laporan Lengkap</label>
                                    <select id="pdf-time-range" class="custom-select">
                                        <option value="all">Selamanya</option>
                                        <option value="last7days">7 Hari Terakhir</option>
                                        <option value="last1month">1 Bulan Terakhir</option>
                                        <option value="last3months">3 Bulan Terakhir</option>
                                        <option value="last1year">1 Tahun Terakhir</option>
                                        <option value="custom">Rentang Kustom...</option>
                                    </select>
                                    <div id="pdf-custom-range-inputs" class="hidden grid grid-cols-2 gap-2">
                                        <input type="date" id="pdf-start-date" class="custom-input" title="Tanggal Mulai">
                                        <input type="date" id="pdf-end-date" class="custom-input" title="Tanggal Selesai">
                                    </div>
                                    <button id="export-pdf-btn" class="custom-button w-full" style="background: linear-gradient(90deg, #10b981, #059669);">
                                        <i class="fas fa-file-pdf mr-2"></i>Ekspor ke PDF
                                    </button>
                                    <button id="export-images-btn" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);">
                                        <i class="fas fa-file-archive mr-2"></i>Ekspor Gambar (ZIP)
                                    </button>
                                </div>

                                <hr class="border-purple-500/20">
                                <button id="backupData" class="custom-button w-full"><i class="fas fa-download mr-2"></i>Backup Data (.zip)</button>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Restore Data (.zip)</label>
                                    <input type="file" id="restoreFile" accept=".zip" class="custom-input">
                                    <button id="restoreData" class="custom-button custom-button-danger w-full mt-2"><i class="fas fa-upload mr-2"></i>Restore dari Lokal</button>
                                </div>
                                <hr class="border-purple-500/20">
                                <button id="clearAllData" class="custom-button custom-button-danger w-full mt-4"><i class="fas fa-trash mr-2"></i>Hapus Semua Data</button>
                            </div>
                        </div>

                        <div class="glass-effect p-6 space-y-4">
                            <div data-premium="true">
                                <h3 class="text-xl font-semibold text-blue-400 mb-2">
                                    <i class="fab fa-google-drive mr-2"></i>Penyimpanan & Sinkronisasi Cloud <i class="fas fa-lock text-yellow-500 ml-1 text-xs"></i>
                                </h3>
                                <p class="text-sm text-gray-400 -mt-2 mb-4">
                                    Simpan file, cadangkan, dan pulihkan data aplikasi Anda dengan aman menggunakan Google Drive.
                                </p>

                                <div id="user-profile" class="hidden mb-6 text-center border-b border-purple-500/20 pb-6">
                                    <div id="avatar-container" class="w-24 h-24 rounded-full p-1 border-2 border-purple-400 mx-auto mb-3">
                                        <img id="user-picture" class="w-full h-full object-cover" alt="Avatar Pengguna" src="https://placehold.co/96x96/0F0A20/c084fc?text=?">
                                    </div>
                                    <p class="text-lg font-semibold text-purple-200" id="user-name"></p>
                                    <div class="flex items-center justify-center gap-2 mt-1">
                                        <p class="text-sm text-gray-400" id="user-email"></p>
                                        <i id="toggle-email-visibility" class="fas fa-eye cursor-pointer text-purple-300 hover:text-white transition-colors" title="Tampilkan/Sembunyikan Email"></i>
                                    </div>
                                </div>

                                <div id="google-drive-ui" class="space-y-3">
                                    <button id="auth-button" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);"><i class="fab fa-google mr-2"></i><span>Hubungkan ke Google</span></button>
                                    
                                    <input type="file" id="smart-upload-input" multiple hidden>
                                    <button id="smart-upload-button" class="custom-button w-full hidden" style="background: linear-gradient(90deg, #10b981, #059669);"><i class="fas fa-cloud-upload-alt mr-2"></i>Unggah File ke Drive</button>
                                    <button id="download-via-link-button" class="custom-button w-full hidden" style="background: linear-gradient(90deg, #8b5cf6, #6d28d9);"><i class="fas fa-link mr-2"></i>Download via Link</button>
                                    <button id="backup-button" class="custom-button w-full hidden"><i class="fas fa-save mr-2"></i>Backup Aplikasi ke Drive</button>
                                    <button id="restore-button" class="custom-button w-full hidden" style="background: linear-gradient(90deg, #f59e0b, #d97706);"><i class="fas fa-cloud-download-alt mr-2"></i>Restore Aplikasi dari Drive</button>
                                    <button id="manage-drive-files-button" class="custom-button w-full hidden" style="background: linear-gradient(90deg, #22d3ee, #00a2ff);"><i class="fas fa-folder-open mr-2"></i>Kelola File Drive</button>
                                    
                                    <div id="auth-status" class="text-center text-sm text-gray-400 pt-2">Belum terhubung.</div>
                                    
                                    <div id="upload-progress-container" class="space-y-2 pt-2"></div>

                                    <div id="file-list" class="text-xs text-gray-500 bg-black/20 p-2 rounded-md max-h-40 overflow-y-auto"></div>
                                </div>
                            </div>

                            <div class="lg:col-span-2 space-y-6">
                                <div class="glass-effect p-6" data-premium="true">
                                    <h3 class="text-xl font-semibold mb-4 text-pink-400">Ubah Latar Belakang <i class="fas fa-lock text-yellow-500 ml-1 text-xs"></i></h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="bg-upload-media" class="block text-sm font-medium mb-2">Pilih File (Gambar/Video)</label>
                                            <input type="file" id="bg-upload-media" class="custom-input" accept="image/*,video/*">
                                        </div>
                                        <button id="applyBgMediaBtn" class="custom-button w-full">Terapkan Latar Belakang</button>
                                        <button id="resetBgMediaBtn" class="custom-button custom-button-danger w-full">Reset Latar Belakang</button>
                                        <button id="toggleVideoSoundBtn" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);">
                                            <i class="fas fa-volume-mute mr-2"></i> <span>Aktifkan Suara Video</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="glass-effect p-6">
                                    <h3 class="text-xl font-semibold mb-4 text-pink-400">Kontak & Sosial Media</h3>
                                    <div class="space-y-3">
                                        <a href="https://youtube.com/@uranusfazry?si=44IbU_u8hYA0cSBO" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                            <i class="fab fa-youtube w-6 text-center text-red-500 mr-3"></i>
                                            <span class="text-sm">YouTube</span>
                                        </a>
                                        <a href="https://www.tiktok.com/@uranusfazry?_t=ZS-8z7TBMBtmqu&_r=1" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                            <i class="fab fa-tiktok w-6 text-center mr-3"></i>
                                            <span class="text-sm">TikTok</span>
                                        </a>
                                        <a href="mailto:irawanfazry697@gmail.com" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                            <i class="fas fa-envelope w-6 text-center text-gray-400 mr-3"></i>
                                            <span class="text-sm">Email</span>
                                        </a>
                                        <a href="https://wa.me/6287872521809?text=Halo%2C%20saya%20membutuhkan%20bantuan%20terkait%20website%20dan%20aplikasi%20uranusfazry%20(Uranuspace)" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                            <i class="fab fa-whatsapp w-6 text-center text-green-500 mr-3"></i>
                                            <span class="text-sm">WhatsApp</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="glass-effect p-6">
                                    <h3 class="text-xl font-semibold mb-4 text-pink-400">Informasi Aplikasi</h3>
                                    <div class="space-y-2 text-sm">
                                        <p><strong>Nama:</strong> LifeHub v6 (Uranus Space)</p>
                                        <p><strong>Versi:</strong> 6.3.0-Integrated-Drive</p>
                                        <p><strong>Fitur:</strong> Editor HTML/CSS/JS (Toolbar Lengkap, Live Preview, Fullscreen, Undo/Redo Cerdas, Buka dari Drive), Penyimpanan Cloud (Upload, Backup, Restore, Download via Link), Pratinjau File Drive, Editor Teks Modern, Analisis Data, Keuangan, Tugas, Pomodoro, Split Bill, Portal Tautan, Custom BG (Persisten), Preview Mode, Kunci Catatan, Keamanan Lanjutan, Laporan PDF & Gambar Komprehensif, Unggah Font Kustom, Ukuran Teks per Catatan, Embed Media & ZIP.</p>
                                        <p><strong>Storage:</strong> LocalStorage, IndexedDB & Google Drive (Data terenkripsi di terminal Anda)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section untuk Editor HTML yang Diperbarui -->
                <div id="html-editor-section" class="section hidden flex flex-col gap-8">
                    <!-- Bagian Atas: Editor dan Pratinjau -->
                    <div class="flex-shrink-0">
                        <div id="editor-container" class="glass-effect p-2 sm:p-4 h-full flex flex-col">
                            <!-- Pesan Selamat Datang -->
                            <div id="welcome-message" class="text-center flex flex-col justify-center items-center h-full min-h-[60vh]">
                                <i class="fas fa-space-shuttle text-6xl text-purple-400 mb-4"></i>
                                <h1 class="text-3xl font-bold">Selamat Datang di Editor HTML</h1>
                                <p class="text-gray-400 mt-2">Pilih atau buat catatan baru di bawah untuk memulai.</p>
                            </div>
                            <!-- Editor HTML -->
                            <div id="html-editor" class="hidden h-full flex flex-col">
                                <div class="flex-shrink-0 mb-4">
                                    <input type="text" id="htmlNoteTitle" class="custom-input text-xl" placeholder="Judul Catatan HTML...">
                                </div>
                                
                                <!-- Toolbar Baru -->
                                <div id="html-editor-toolbar">
                                    <div class="toolbar-group">
                                        <button id="html-add-file-btn" class="toolbar-btn" title="File Baru"><i class="fas fa-plus"></i></button>
                                        <button id="html-open-drive-btn" class="toolbar-btn" title="Buka dari Drive"><i class="fas fa-folder-open"></i></button>
                                        <button id="html-undo-btn" class="toolbar-btn" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                                        <button id="html-redo-btn" class="toolbar-btn" title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                                    </div>
                                    <div class="toolbar-separator"></div>
                                    <div class="toolbar-group">
                                        <button id="html-cursor-prev-btn" class="toolbar-btn" title="Posisi Kursor Sebelumnya"><i class="fas fa-arrow-left"></i></button>
                                        <button id="html-cursor-next-btn" class="toolbar-btn" title="Posisi Kursor Berikutnya"><i class="fas fa-arrow-right"></i></button>
                                    </div>
                                    <div class="toolbar-separator"></div>
                                    <div class="toolbar-group">
                                        <button id="html-search-btn" class="toolbar-btn" title="Cari (Ctrl+F)"><i class="fas fa-search"></i></button>
                                        <div id="html-search-wrapper" class="toolbar-search-wrapper">
                                            <input type="text" id="html-search-input" placeholder="Cari di kode...">
                                        </div>
                                    </div>
                                </div>

                                <div class="flex-shrink-0 border-b border-gray-700">
                                    <div class="code-editor-tabs flex space-x-1 p-1">
                                        <button class="tab-btn active" data-tab="html">HTML</button>
                                        <button class="tab-btn" data-tab="css">CSS</button>
                                        <button class="tab-btn" data-tab="js">JS</button>
                                    </div>
                                </div>
                                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 overflow-hidden">
                                    <!-- Panel Kode -->
                                    <div id="code-panels" class="flex flex-col h-full">
                                        <div class="code-panel" data-panel="html">
                                            <textarea id="htmlCode" class="code-textarea" placeholder="<!-- Kode HTML di sini -->"></textarea>
                                        </div>
                                        <div class="code-panel hidden" data-panel="css">
                                            <textarea id="cssCode" class="code-textarea" placeholder="/* Aturan CSS di sini */"></textarea>
                                        </div>
                                        <div class="code-panel hidden" data-panel="js">
                                            <textarea id="jsCode" class="code-textarea" placeholder="// Kode JavaScript di sini"></textarea>
                                        </div>
                                    </div>
                                    <!-- Panel Pratinjau -->
                                    <div id="preview-panel" class="flex flex-col h-full bg-gray-800 rounded-md">
                                        <div id="preview-controls">
                                            <div class="flex items-center space-x-2 bg-[var(--card-bg)] p-1 rounded-full">
                                                <span class="text-xs ml-2">Auto</span>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer">
                                                    <div class="w-9 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div>
                                                </label>
                                            </div>
                                            <button id="fullscreen-btn" class="control-btn" title="Pratinjau Layar Penuh"><i class="fas fa-expand"></i></button>
                                        </div>
                                        <div class="flex-grow bg-white rounded-md mt-2">
                                           <iframe id="html-preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
                                        </div>
                                    </div>
                                </div>
                                <!-- Tombol Aksi Editor -->
                                <div class="flex-shrink-0 flex flex-wrap gap-2 mt-4">
                                    <button id="runBtn" class="custom-button"><i class="fas fa-play mr-2"></i>Jalankan</button>
                                    <button id="saveHtmlNoteBtn" class="custom-button"><i class="fas fa-save mr-2"></i>Simpan</button>
                                    <div class="relative inline-block">
                                        <button id="exportBtn" class="custom-button custom-button-secondary"><i class="fas fa-file-export mr-2"></i>Ekspor</button>
                                        <div id="export-menu" class="hidden absolute bottom-full mb-2 w-48 glass-effect !rounded-md p-2 z-10">
                                            <button id="exportHtmlBtn" class="w-full text-left p-2 hover:bg-purple-500/20 rounded text-sm">ke File .html</button>
                                            <button id="exportPdfBtn" class="w-full text-left p-2 hover:bg-purple-500/20 rounded text-sm">ke PDF (Pratinjau)</button>
                                            <button id="exportPdfCodeBtn" class="w-full text-left p-2 hover:bg-purple-500/20 rounded text-sm">ke PDF (Kode)</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Bagian Bawah: Daftar Catatan -->
                    <div class="flex-shrink-0">
                        <div class="glass-effect p-6">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h2 class="text-2xl font-bold text-purple-300">Daftar Catatan HTML</h2>
                                <!-- TOMBOL BARU DITAMBAHKAN DI SINI -->
                                <button id="addHtmlNoteBtn" class="custom-button !py-2 !px-3">
                                    <i class="fas fa-plus mr-2"></i>Buat Baru
                                </button>
                                <div class="flex-grow sm:flex-grow-0 sm:w-72">
                                    <input type="search" id="searchHtmlNotes" placeholder="Cari catatan HTML..." class="custom-input">
                                </div>
                            </div>
                            <div id="htmlNotesList" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-center text-gray-500">Tidak ada catatan HTML.</p>
                            </div>
                        </div>
                    </div>
                </div>


                <footer class="text-center mt-10 py-4">
                    <p class="text-xs text-gray-500">© 2025 Uranus Space All rights reserved</p>
                </footer>

            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="premiumModal" class="modal">
        <div id="premiumModalContent" class="modal-content glass-effect p-8 w-full max-w-md text-center">
            <!-- Konten akan diisi oleh JS -->
        </div>
    </div>
    <div id="mainModal" class="modal"><div class="modal-content glass-effect p-8 w-full max-w-2xl"></div></div>
    <div id="confirmModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm text-center">
            <h3 id="confirmTitle" class="text-xl font-semibold mb-4 text-pink-400">Konfirmasi</h3>
            <p id="confirmMessage" class="mb-6">Apakah Anda yakin?</p>
            <div class="flex gap-4">
                <button id="confirmYes" class="custom-button flex-1">Ya</button>
                <button id="confirmNo" class="custom-button custom-button-danger flex-1">Tidak</button>
            </div>
        </div>
    </div>
    <div id="dateRangeModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-6 text-purple-400">Pilih Rentang Tanggal</h3>
            <div class="space-y-4">
                <div>
                    <label for="startDate" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                    <input type="date" id="startDate" class="custom-input">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium mb-1">Tanggal Selesai</label>
                    <input type="date" id="endDate" class="custom-input">
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button id="applyDateRange" class="custom-button flex-1">Terapkan</button>
                <button id="cancelDateRange" class="custom-button custom-button-danger flex-1">Batal</button>
            </div>
        </div>
    </div>
    
    <!-- NotesApp Modals -->
    <div id="notesPasswordModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm text-center">
            <h3 class="text-xl font-semibold mb-4 text-pink-400">Catatan Terkunci</h3>
            <p id="password-prompt-message" class="mb-4">Masukkan kata sandi untuk membuka.</p>
            <input type="password" id="notesPasswordInput" class="custom-input mb-4">
            <div class="flex gap-2">
                <button id="notesCheckPasswordBtn" class="custom-button flex-1">Buka</button>
                <button id="notesCancelPasswordBtn" class="custom-button custom-button-danger">Batal</button>
            </div>
        </div>
    </div>
    <div id="notesPreviewModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-3xl">
            <div id="notesPreviewContent" class="prose max-w-none"></div>
            <button id="notesClosePreviewBtn" class="custom-button mt-6">Tutup</button>
        </div>
    </div>

    <!-- [BARU] Modal Kustom untuk Input Password -->
    <div id="customPromptModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm">
            <h3 id="customPromptTitle" class="text-xl font-semibold mb-4 text-pink-400">Atur Kata Sandi</h3>
            <p id="customPromptMessage" class="mb-6 text-gray-300">Masukkan kata sandi baru (kosongkan untuk membuka kunci):</p>
            
            <div class="relative">
                <input type="password" id="customPromptInput" class="custom-input pr-10" placeholder="Ketik kata sandi...">
                <i id="customPromptToggle" class="fas fa-eye absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer text-gray-400 hover:text-white"></i>
            </div>

            <div class="flex gap-4 mt-6">
                <button id="customPromptCancel" class="custom-button custom-button-danger flex-1">Batal</button>
                <button id="customPromptOK" class="custom-button flex-1">Oke</button>
            </div>
        </div>
    </div>

    <!-- [DIPERBARUI] Modal untuk Pratinjau File Drive -->
    <div id="filePreviewModal" class="modal" style="z-index: 1001;">
        <div class="modal-content glass-effect p-4 w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-2 flex-shrink-0">
                <h3 id="preview-title" class="text-lg font-semibold text-purple-300 truncate pr-4">Pratinjau File</h3>
                <div id="preview-controls-container" class="flex items-center space-x-2">
                    <button id="preview-back-btn" class="custom-button custom-button-secondary !py-1 !px-3 !text-xs hidden" title="Kembali ke Daftar File"><i class="fas fa-arrow-left mr-2"></i>Kembali</button>
                    <button class="closeModal custom-button custom-button-danger !p-2 !text-xs" title="Tutup"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="preview-content-container" class="bg-black/20 rounded-md flex-grow flex items-center justify-center overflow-auto p-2">
                <!-- Konten pratinjau (img, video, canvas, iframe) akan dirender di sini -->
                <i class="fas fa-spinner fa-spin text-4xl text-purple-300"></i>
            </div>
        </div>
    </div>

    <audio id="lockSound" src="https://c.top4top.io/m_35235kd2e1.m4a" preload="auto"></audio>

<script>
// ===================================================================================
// ========================== [BARU] LOGIKA FITUR PREMIUM ============================
// ===================================================================================

// Variabel ini akan menjadi "penjaga gerbang" untuk semua fitur premium.
// Ubah menjadi 'true' untuk menguji sebagai pengguna premium.
const isPremiumUser = false;

/**
 * Menampilkan popup yang mengajak pengguna untuk upgrade ke premium.
 */
function showPremiumPopup() {
    const modal = document.getElementById('premiumModal');
    const modalContent = document.getElementById('premiumModalContent');

    modalContent.innerHTML = `
        <div class="premium-lock-icon">🔒</div>
        <h2 class="text-2xl font-bold text-yellow-300 mb-2">Buka Akses Penuh dengan Premium!</h2>
        <p class="text-gray-400 mb-6">Anda memerlukan akun Premium untuk menggunakan fitur canggih ini dan meningkatkan produktivitas Anda.</p>
        <ul class="premium-benefits-list">
            <li><span>📄🖼️</span> Export catatan & editor ke PDF/Gambar</li>
            <li><span>🎨</span> Ubah background eksklusif</li>
            <li><span>☁️</span> Penyimpanan & Sinkronisasi Cloud</li>
            <li><span>🔐</span> Catatan Profesional & Editor HTML</li>
        </ul>
        <a href="https://trakteer.id/uranusfazry/shop/uranus-studio-unilD" target="_blank" class="premium-upgrade-btn">
            Upgrade Sekarang
        </a>
        <button class="closeModal text-gray-500 hover:text-white mt-6 text-sm">Nanti Saja</button>
    `;

    modal.classList.add('show');

    // Tambahkan event listener untuk tombol close di dalam modal
    modal.querySelector('.closeModal').addEventListener('click', () => {
        modal.classList.remove('show');
    });
}


/**
 * Fungsi pemeriksa akses premium.
 * @param {Event} e - Event object dari elemen yang diklik.
 * @returns {boolean} - Mengembalikan true jika pengguna premium, false jika tidak.
 */
function checkPremiumAccess(e) {
    if (isPremiumUser) {
        return true; // Akses diberikan
    }

    // Jika bukan premium, hentikan aksi default dan tampilkan popup
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    showPremiumPopup();
    return false; // Akses ditolak
}


// ===================================================================================
// ======================= [BARU] FUNGSI HELPER UNTUK INDEXEDDB ======================
// ===================================================================================
/**
 * Membuka koneksi ke database IndexedDB.
 * @returns {Promise<IDBDatabase>} Promise yang resolve dengan objek database.
 */
function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('UranusSpaceDB', 2); // Versi dinaikkan untuk upgrade
        request.onupgradeneeded = event => {
            const db = event.target.result;
            // Store untuk media (backgrounds, media catatan)
            if (!db.objectStoreNames.contains('mediaFiles')) {
                db.createObjectStore('mediaFiles', { keyPath: 'id' });
            }
        };
        request.onsuccess = event => resolve(event.target.result);
        request.onerror = event => reject(event.target.error);
    });
}

/**
 * Menyimpan file (Blob) ke IndexedDB.
 * @param {string} id - Kunci unik untuk file (misalnya, nama file).
 * @param {Blob} blob - Data file sebagai Blob.
 * @returns {Promise<void>}
 */
async function saveFileToDB(id, blob) {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readwrite');
        const store = tx.objectStore('mediaFiles');
        store.put({ id: id, file: blob });
        return tx.complete;
    } catch (error) {
        console.error("Gagal menyimpan file ke DB:", error);
        showMessage("Gagal menyimpan file media. Mungkin storage penuh.", "error");
    }
}

/**
 * Mengambil file (Blob) dari IndexedDB.
 * @param {string} id - Kunci unik file.
 * @returns {Promise<Blob|null>}
 */
async function getFileFromDB(id) {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readonly');
        const store = tx.objectStore('mediaFiles');
        const request = store.get(id);
        return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result ? request.result.file : null);
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error("Gagal mengambil file dari DB:", error);
        return null;
    }
}

/**
 * Menghapus file dari IndexedDB.
 * @param {string} id - Kunci unik file.
 * @returns {Promise<void>}
 */
async function deleteFileFromDB(id) {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readwrite');
        const store = tx.objectStore('mediaFiles');
        store.delete(id);
        return tx.complete;
    } catch (error) {
        console.error("Gagal menghapus file dari DB:", error);
    }
}

/**
 * Mengambil semua kunci file dari object store.
 * @returns {Promise<string[]>}
 */
async function getAllFileKeysFromDB() {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readonly');
        const store = tx.objectStore('mediaFiles');
        const request = store.getAllKeys();
        return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error("Gagal mengambil semua kunci file dari DB:", error);
        return [];
    }
}


// ===================================================================================
// ======================= [BARU] FUNGSI HELPER UNTUK MODAL KUSTOM ===================
// ===================================================================================
/**
 * Menampilkan modal kustom sebagai pengganti window.prompt().
 * @param {string} title - Judul modal.
 * @param {string} message - Pesan instruksi untuk pengguna.
 * @param {string} placeholder - Placeholder untuk input field.
 * @returns {Promise<string|null>} Promise yang resolve dengan nilai input atau null jika dibatalkan.
 */
function showCustomPrompt(title, message, placeholder, inputType = 'password') {
    return new Promise((resolve) => {
        const modal = document.getElementById('customPromptModal');
        const titleEl = document.getElementById('customPromptTitle');
        const messageEl = document.getElementById('customPromptMessage');
        const inputEl = document.getElementById('customPromptInput');
        const okBtn = document.getElementById('customPromptOK');
        const cancelBtn = document.getElementById('customPromptCancel');
        const toggleBtn = document.getElementById('customPromptToggle');

        // Reset state
        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.placeholder = placeholder;
        inputEl.value = '';
        inputEl.type = inputType;
        
        if (inputType === 'password') {
            toggleBtn.style.display = 'block';
            toggleBtn.classList.remove('fa-eye-slash');
            toggleBtn.classList.add('fa-eye');
        } else {
            toggleBtn.style.display = 'none';
        }


        modal.classList.add('show');
        inputEl.focus();

        const handleOK = () => {
            cleanup();
            resolve(inputEl.value);
        };

        const handleCancel = () => {
            cleanup();
            resolve(null);
        };

        const handleToggle = () => {
            if (inputEl.type === 'password') {
                inputEl.type = 'text';
                toggleBtn.classList.remove('fa-eye');
                toggleBtn.classList.add('fa-eye-slash');
            } else {
                inputEl.type = 'password';
                toggleBtn.classList.remove('fa-eye-slash');
                toggleBtn.classList.add('fa-eye');
            }
        };

        const handleKeyup = (e) => {
            if (e.key === 'Enter') handleOK();
            if (e.key === 'Escape') handleCancel();
        };

        // Tambahkan event listeners
        okBtn.addEventListener('click', handleOK);
        cancelBtn.addEventListener('click', handleCancel);
        toggleBtn.addEventListener('click', handleToggle);
        modal.addEventListener('keyup', handleKeyup);

        function cleanup() {
            modal.classList.remove('show');
            okBtn.removeEventListener('click', handleOK);
            cancelBtn.removeEventListener('click', handleCancel);
            toggleBtn.removeEventListener('click', handleToggle);
            modal.removeEventListener('keyup', handleKeyup);
        }
    });
}


/**
 * NotesApp Class
 */
class NotesApp {
    constructor() {
        this.notes = [];
        this.currentNoteId = null;
        this.lastSelection = null; 
        this.customFonts = [];
    }

    init() {
        this.cacheDOMElements();
        this.bindEvents();
        this.loadNotes();
        this.loadSavedFonts();
        setInterval(() => this.autoSave(), 30000);
    }

    cacheDOMElements() {
        this.dom = {
            lockSound: document.getElementById('lockSound'),
            passwordModal: document.getElementById('notesPasswordModal'),
            passwordInput: document.getElementById('notesPasswordInput'),
            checkPasswordBtn: document.getElementById('notesCheckPasswordBtn'),
            cancelPasswordBtn: document.getElementById('notesCancelPasswordBtn'),
            passwordPromptMessage: document.getElementById('password-prompt-message'),
            hackOverlay: document.getElementById('hack-overlay'),
            hackText: document.getElementById('hack-text'),
            addNewNoteBtn: document.getElementById('notesAddNewBtn'),
            searchInput: document.getElementById('notesSearchInput'),
            moodFilter: document.getElementById('notesMoodFilter'),
            editorSection: document.getElementById('notesEditorSection'),
            titleInput: document.getElementById('notesTitleInput'),
            masterBtn: document.getElementById('editor-master-btn'),
            toolbar: document.getElementById('pro-toolbar'),
            editorContent: document.getElementById('pro-editor-content'),
            fontSelect: document.querySelector('#pro-toolbar select[data-command="fontName"]'),
            fontSizeInput: document.getElementById('custom-font-size'),
            fontUploader: document.getElementById('customFontUploader'),
            clearFontsBtn: document.getElementById('clearCustomFontsBtn'),
            wordCountEl: document.getElementById('word-count'),
            charCountEl: document.getElementById('char-count'),
            readingTimeEl: document.getElementById('reading-time'),
            saveStatusEl: document.getElementById('save-status'),
            dateFilter: document.getElementById('notesDateFilter'),
            moodSelector: document.getElementById('notesMoodSelector'),
            tagsInput: document.getElementById('notesTagsInput'),
            saveNoteBtn: document.getElementById('notesSaveBtn'),
            setPasswordBtn: document.getElementById('notesSetPasswordBtn'),
            clearEditorBtn: document.getElementById('notesClearEditorBtn'),
            notesList: document.getElementById('notesList'),
            previewModal: document.getElementById('notesPreviewModal'),
            previewContent: document.getElementById('notesPreviewContent'),
            closePreviewBtn: document.getElementById('notesClosePreviewBtn'),
        };
    }

    bindEvents() {
        this.dom.addNewNoteBtn.addEventListener('click', () => this.addNewNote());
        this.dom.saveNoteBtn.addEventListener('click', () => this.saveNote(true));
        this.dom.setPasswordBtn.addEventListener('click', () => this.setPasswordForCurrentNote());
        this.dom.clearEditorBtn.addEventListener('click', () => this.clearEditor());
        this.dom.searchInput.addEventListener('input', () => this.filterNotes());
        this.dom.moodFilter.addEventListener('change', () => this.filterNotes());
        this.dom.fontUploader.addEventListener('change', (e) => this.handleFontUpload(e));
        this.dom.clearFontsBtn.addEventListener('click', () => this.clearAllCustomFonts());
        this.dom.masterBtn.addEventListener('click', () => this.toggleToolbar());

        this.dom.toolbar.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const command = button.dataset.command;
            if (command) {
                e.preventDefault();
                this.handleCommand(command);
            }
        });
        
        this.dom.fontSizeInput.addEventListener('change', (e) => this.applyStyle('fontSize', `${e.target.value}px`));
        this.dom.fontSizeInput.addEventListener('input', (e) => this.applyStyle('fontSize', `${e.target.value}px`));


        this.dom.toolbar.querySelectorAll('select, input[type="color"]').forEach(input => {
            input.addEventListener('change', (e) => {
                const command = e.target.dataset.command;
                if (command) {
                    this.handleCommand(command, e.target.value);
                }
            });
        });
        
        this.dom.editorContent.addEventListener('input', () => this.updateStatusBar());
        this.dom.editorContent.addEventListener('blur', () => this.saveSelection());
        this.dom.editorContent.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); this.dom.editorContent.classList.add('dragover'); });
        this.dom.editorContent.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); this.dom.editorContent.classList.remove('dragover'); });
        this.dom.editorContent.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); this.dom.editorContent.classList.remove('dragover'); this.handleFileUpload(e.dataTransfer.files); });
        this.dom.editorContent.addEventListener('paste', (e) => this.handlePaste(e));

        this.dom.notesList.addEventListener('click', (e) => {
            const target = e.target.closest('button, .note-item-clickable');
            if (!target) return;
            const noteId = parseInt(target.dataset.id);
            const action = target.dataset.action;
            if (action === 'click-to-edit') { e.stopPropagation(); this.handleNoteClick(noteId); }
            if (action === 'delete') { e.stopPropagation(); this.deleteNote(noteId); }
            if (action === 'preview') { e.stopPropagation(); this.previewNote(noteId); }
            if (action === 'export-pdf') { e.stopPropagation(); this.exportSingleNoteToPdf(noteId); }
        });
        this.dom.closePreviewBtn.addEventListener('click', () => this.closePreview());
    }

    loadSavedFonts() {
        this.customFonts = JSON.parse(localStorage.getItem('customFonts_v5.5.0')) || [];
        let fontStyleSheet = document.getElementById('custom-font-styles');
        if (!fontStyleSheet) {
            fontStyleSheet = document.createElement('style');
            fontStyleSheet.id = 'custom-font-styles';
            document.head.appendChild(fontStyleSheet);
        }
        
        this.customFonts.forEach(font => {
            const newFontFace = `@font-face { font-family: "${font.name}"; src: url(${font.url}); font-display: swap; }`;
            fontStyleSheet.innerHTML += newFontFace;
        });

        this.updateFontSelector();
    }

    handleFontUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const fontUrl = e.target.result;
            let fontName = file.name.split('.').slice(0, -1).join('.');
            fontName = fontName.replace(/[^a-zA-Z0-9\s-]/g, '').trim();

            if (!fontName) {
                showMessage(`Nama file font tidak valid.`, 'error');
                this.dom.fontUploader.value = '';
                return;
            }

            if (this.customFonts.some(f => f.name.toLowerCase() === fontName.toLowerCase())) {
                showMessage(`Font dengan nama "${fontName}" sudah ada.`, 'error');
                this.dom.fontUploader.value = '';
                return;
            }
            
            const newFont = { name: fontName, url: fontUrl };
            this.customFonts.push(newFont);
            
            const fontStyleSheet = document.getElementById('custom-font-styles');
            const newFontFace = `@font-face { font-family: "${fontName}"; src: url(${fontUrl}); font-display: swap; }`;
            fontStyleSheet.innerHTML += newFontFace;

            localStorage.setItem('customFonts_v5.5.0', JSON.stringify(this.customFonts));
            this.updateFontSelector();
            showMessage(`Font "${fontName}" berhasil ditambahkan!`, 'success');
            this.dom.fontUploader.value = '';
        };
        reader.readAsDataURL(file);
    }

updateFontSelector() {
        this.dom.fontSelect.innerHTML = '';

        const defaultFonts = [
            { value: "'Poppins', sans-serif", text: "Default (Poppins)" },
            { value: "'Roboto', sans-serif", text: "Roboto" },
            { value: "'Open Sans', sans-serif", text: "Open Sans" },
            { value: "'Lato', sans-serif", text: "Lato" },
            { value: "'Montserrat', sans-serif", text: "Montserrat" },
            { value: "'Merriweather', serif", text: "Merriweather" },
            { value: "'Playfair Display', serif", text: "Playfair Display" },
            { value: "'Fira Code', monospace", text: "Fira Code" },
            { value: "'JetBrains Mono', monospace", text: "JetBrains Mono" }
        ];

        const systemFontsGroup = document.createElement('optgroup');
        systemFontsGroup.label = '--- Font Sistem ---';
        defaultFonts.forEach(font => {
            const option = document.createElement('option');
            option.value = font.value;
            option.textContent = font.text;
            option.style.fontFamily = font.value;
            systemFontsGroup.appendChild(option);
        });
        this.dom.fontSelect.appendChild(systemFontsGroup);

        if (this.customFonts.length > 0) {
            const customFontsGroup = document.createElement('optgroup');
            customFontsGroup.label = '--- Font Kustom ---';
            this.customFonts.forEach(font => {
                const option = document.createElement('option');
                option.value = `"${font.name}", sans-serif`;
                option.textContent = font.name;
                option.style.fontFamily = `"${font.name}", sans-serif`;
                customFontsGroup.appendChild(option);
            });
            this.dom.fontSelect.appendChild(customFontsGroup);
        }
    }
    
    clearAllCustomFonts() {
        showConfirm('Hapus Semua Font?', 'Anda yakin ingin menghapus semua font kustom yang telah diunggah?', () => {
            this.customFonts = [];
            localStorage.removeItem('customFonts_v5.5.0');
            const fontStyleSheet = document.getElementById('custom-font-styles');
            if (fontStyleSheet) {
                fontStyleSheet.innerHTML = '';
            }
            this.updateFontSelector();
            showMessage('Semua font kustom telah dihapus.', 'success');
        });
    }

    toggleToolbar() {
        this.dom.toolbar.classList.toggle('visible');
    }
    
    saveSelection() {
        if (window.getSelection) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && this.dom.editorContent.contains(sel.anchorNode)) {
                 this.lastSelection = sel.getRangeAt(0);
            }
        }
    }

    restoreSelection() {
        if (this.lastSelection) {
            if (window.getSelection) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(this.lastSelection);
            }
        }
    }
    
    applyStyle(styleProperty, styleValue) {
        this.restoreSelection();
        this.dom.editorContent.focus();

        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        document.execCommand('styleWithCSS', false, true);
        if (styleProperty === 'fontFamily') {
            document.execCommand('fontName', false, styleValue);
        } else if (styleProperty === 'fontSize') {
            const tempSpan = document.createElement('span');
            tempSpan.style.fontSize = styleValue;
            
            const range = selection.getRangeAt(0);
            if (range.collapsed) {
                 // Tidak ada teks yang dipilih, kita akan membuat span baru untuk mengetik
                 tempSpan.innerHTML = '&#8203;'; // Zero-width space
                 range.insertNode(tempSpan);
                 range.selectNodeContents(tempSpan);
                 range.collapse(false); // Pindahkan kursor ke akhir
                 selection.removeAllRanges();
                 selection.addRange(range);
            } else {
                 // Ada teks yang dipilih, kita bungkus dengan span
                 tempSpan.appendChild(range.extractContents());
                 range.insertNode(tempSpan);
            }
        }
        document.execCommand('styleWithCSS', false, false);
        this.updateStatusBar();
    }

    handleCommand(command, value = null) {
        const simpleCommands = ['undo', 'redo', 'bold', 'italic', 'underline', 'strikeThrough', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'insertOrderedList', 'insertUnorderedList', 'insertHorizontalRule'];
        
        this.restoreSelection();
        this.dom.editorContent.focus();

        if (simpleCommands.includes(command)) {
            document.execCommand(command, false, value);
        } else if (command === 'clearFormatting') {
             document.execCommand('removeFormat', false, null);
        } else if (command === 'fontName') {
            this.applyStyle('fontFamily', value);
        } else if (command === 'decreaseFontSize' || command === 'increaseFontSize') {
            let currentSize = parseInt(this.dom.fontSizeInput.value);
            currentSize += (command === 'increaseFontSize' ? 2 : -2);
            if (currentSize < 8) currentSize = 8;
            if (currentSize > 72) currentSize = 72;
            this.dom.fontSizeInput.value = currentSize;
            this.applyStyle('fontSize', `${currentSize}px`);
        } else if (command === 'formatBlock' || command === 'foreColor' || command === 'backColor') {
            document.execCommand(command, false, value);
        } else if (command === 'createLink') {
            const url = prompt('Masukkan URL:', 'https://');
            if (url) document.execCommand('createLink', false, url);
        } else if (command === 'embedMediaUrl') {
            this.embedMediaFromUrl();
        } else if (command === 'embedYouTube') {
            this.embedYouTube();
        } else if (command === 'embedTikTok') {
            this.embedTikTok();
        } else if (command === 'uploadFile') {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,application/zip';
            input.onchange = (e) => this.handleFileUpload(e.target.files);
            input.click();
        } else {
            console.warn(`Perintah tidak dikenal: ${command}`);
        }
        this.dom.editorContent.focus();
        this.updateStatusBar();
    }

handlePaste(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
    }

    updateStatusBar() {
        const text = this.dom.editorContent.innerText || '';
        const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
        const charCount = text.length;
        const readingTime = Math.ceil(wordCount / 200);

        this.dom.wordCountEl.innerHTML = `<i class="fas fa-file-word"></i>${wordCount} Kata`;
        this.dom.charCountEl.innerHTML = `<i class="fas fa-keyboard"></i>${charCount} Karakter`;
        this.dom.readingTimeEl.innerHTML = `<i class="fas fa-clock"></i>${readingTime} mnt`;
        
        this.dom.saveStatusEl.innerHTML = `<i class="fas fa-edit"></i>Belum disimpan`;
        this.dom.saveStatusEl.style.color = '#fbbf24';
    }

    handleNoteClick(id) { const note = this.notes.find(n => n.id === id); if (note) { const lockdownKey = `lockdown_${id}`; const lockdownUntil = parseInt(localStorage.getItem(lockdownKey) || '0'); if (Date.now() < lockdownUntil) { const remaining = Math.ceil((lockdownUntil - Date.now()) / 1000); showMessage(`❌ Akses ditolak. Coba lagi dalam ${remaining} detik.`, 'error'); this.triggerHackEffect(true); return; } if (note.isLocked) { this.promptForPassword(id); } else { this.editNote(id); } } }
    
    promptForPassword(id) { 
        this.dom.passwordModal.classList.add('show'); 
        this.dom.passwordInput.value = ''; 
        this.dom.passwordInput.focus(); 
        this.dom.passwordPromptMessage.textContent = 'Masukkan kata sandi untuk membuka.'; 
        let attempts = 0; 
        const attemptKey = `attempts_${id}`; 
        const checkHandler = () => { 
            const note = this.notes.find(n => n.id === id); 
            if (note && this.dom.passwordInput.value === note.password) { 
                this.editNote(id); 
                this.dom.passwordModal.classList.remove('show'); 
                showMessage('Catatan terbuka!', 'success'); 
                localStorage.removeItem(attemptKey); 
                cleanup(); 
            } else { 
                attempts = parseInt(localStorage.getItem(attemptKey) || '0') + 1; 
                localStorage.setItem(attemptKey, attempts); 
                if (attempts === 1) { 
                    this.dom.passwordPromptMessage.textContent = '😕 Hmm, coba lagi.'; 
                } else if (attempts === 2) { 
                    this.dom.passwordPromptMessage.textContent = '😡 Masih salah, hati-hati!'; 
                } else if (attempts >= 3) { 
                    this.dom.passwordModal.classList.remove('show'); 
                    this.triggerLockdown(id); 
                    cleanup(); 
                    return; 
                } 
                this.dom.passwordInput.value = ''; 
                this.dom.passwordInput.focus(); 
            } 
        }; 
        const cancelHandler = () => { 
            this.dom.passwordModal.classList.remove('show'); 
            cleanup(); 
        }; 
        const cleanup = () => { 
            this.dom.checkPasswordBtn.removeEventListener('click', checkHandler); 
            this.dom.cancelPasswordBtn.removeEventListener('click', cancelHandler); 
        }; 
        this.dom.checkPasswordBtn.addEventListener('click', checkHandler); 
        this.dom.cancelPasswordBtn.addEventListener('click', cancelHandler); 
    }

    triggerLockdown(id) { 
        const lockdownDuration = 30000; 
        const lockdownKey = `lockdown_${id}`; 
        localStorage.setItem(lockdownKey, Date.now() + lockdownDuration); 
        localStorage.removeItem(`attempts_${id}`); 
        this.triggerHackEffect(); 
        setTimeout(() => { 
            localStorage.removeItem(lockdownKey); 
        }, lockdownDuration); 
    }
    
    triggerHackEffect(isResuming = false) { 
        this.dom.hackOverlay.style.display = 'flex'; 

        if (this.dom.lockSound) {
            this.dom.lockSound.currentTime = 0;
            this.dom.lockSound.play().catch(e => console.error("Gagal memutar audio:", e));
        }

        const text = "Access Denied!\nSystem Lockdown Initiated...\nPlease wait 30 seconds..."; 
        let i = 0; 
        this.dom.hackText.innerHTML = ''; 
        const type = () => { 
            if (i < text.length) { 
                this.dom.hackText.innerHTML += text.charAt(i); 
                i++; 
                setTimeout(type, 50); 
            } else { 
                this.dom.hackText.innerHTML += '<span class="typewriter-cursor"></span>'; 
                setInterval(() => { 
                    this.dom.hackText.classList.toggle('glitch'); 
                }, 200); 
            } 
        }; 
        type(); 
        
        setTimeout(() => { 
            this.dom.hackOverlay.style.display = 'none'; 
            this.dom.hackText.classList.remove('glitch'); 
            if (this.dom.lockSound) {
                this.dom.lockSound.pause();
                this.dom.lockSound.currentTime = 0;
            }
        }, isResuming ? 5000 : 30000); 
    }

async setPasswordForCurrentNote() {
        if (!this.currentNoteId) {
            showMessage('Simpan catatan terlebih dahulu sebelum menguncinya.', 'error');
            return;
        }
        const note = this.notes.find(n => n.id === this.currentNoteId);
        if (!note) return;

        if (note.isLocked) {
            const currentPassword = await showCustomPrompt('Ubah Kata Sandi', 'Masukkan kata sandi saat ini untuk melanjutkan.', 'Kata sandi saat ini');
            if (currentPassword === null) return;
            if (currentPassword !== note.password) {
                showMessage('Kata sandi saat ini salah.', 'error');
                return;
            }
        }

        const newPassword = await showCustomPrompt('Atur Kata Sandi Baru', 'Masukkan kata sandi baru (kosongkan untuk membuka kunci).', 'Kata sandi baru');
        if (newPassword === null) return;

        if (newPassword) {
            note.isLocked = true;
            note.password = newPassword;
            showMessage('Catatan berhasil dikunci!', 'success');
        } else {
            note.isLocked = false;
            delete note.password;
            showMessage('Kunci catatan berhasil dibuka.', 'success');
        }

        this.saveToStorage();
        this.displayNotes();
    }

    async embedMediaFromUrl() {
        const url = await showCustomPrompt('Sematkan Media', 'Masukkan URL gambar atau video.', 'https://...', 'url');
        if (!url) return;

        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp'];
        const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov'];
        
        const urlLower = url.toLowerCase();
        let embedHTML = '';

        if (imageExtensions.some(ext => urlLower.endsWith(ext))) {
            embedHTML = `<img src="${url}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0;" />`;
        } else if (videoExtensions.some(ext => urlLower.endsWith(ext))) {
            embedHTML = `<video controls src="${url}" style="max-width: 100%; border-radius: 8px; margin: 1rem 0;"></video>`;
        } else {
            showMessage("URL tidak didukung. Pastikan link merujuk langsung ke file gambar atau video.", "error");
            return;
        }
        document.execCommand('insertHTML', false, embedHTML + "<p><br></p>");
    }

    embedYouTube() { const url = prompt("Masukkan URL video YouTube:"); if (!url) return; let videoId = null; const regexes = [/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/, /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([^?]+)/, /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^?]+)/]; for (const regex of regexes) { const match = url.match(regex); if (match && match[1]) { videoId = match[1]; break; } } if (videoId) { const embedHTML = `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 1rem 0;"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px;"></iframe></div><p><br></p>`; document.execCommand('insertHTML', false, embedHTML); } else { showMessage("URL YouTube tidak valid.", "error"); } }
    embedTikTok() { const url = prompt("Masukkan URL video TikTok:"); if (!url) return; const regex = /tiktok\.com\/.*\/video\/(\d+)/; const match = url.match(regex); const videoId = match && match[1] ? match[1] : null; if (videoId) { const embedHTML = `<div style="position: relative; padding-bottom: 177.78%; height: 0; overflow: hidden; max-width: 325px; margin: 1rem auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"><iframe src="https://www.tiktok.com/embed/v2/${videoId}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe></div><p><br></p>`; document.execCommand('insertHTML', false, embedHTML); showMessage("Video TikTok berhasil disematkan!", "success"); } else { showMessage("URL TikTok tidak valid. Pastikan URL berisi '/video/...' dan ID video.", "error"); } }
    
    handleFileUpload(files) {
        if (!files || files.length === 0) return;
        const file = files[0];
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const result = e.target.result;
            let elementHTML = '';

            if (file.type.startsWith('image/')) {
                elementHTML = `<img src="${result}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0;" />`;
            } else if (file.type.startsWith('video/')) {
                elementHTML = `<video controls src="${result}" style="max-width: 100%; border-radius: 8px; margin: 1rem 0;"></video>`;
            } else if (file.type === 'application/zip') {
                const note = this.notes.find(n => n.id === this.currentNoteId) || { attachments: [] };
                if (!note.attachments) note.attachments = [];
                
                const attachment = {
                    id: `zip_${Date.now()}`,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadDate: new Date().toISOString(),
                    dataUrl: result
                };
                note.attachments.push(attachment);
                
                elementHTML = `
                    <div class="embedded-zip" contenteditable="false" data-attachment-id="${attachment.id}">
                        <i class="fas fa-file-archive"></i>
                        <div class="zip-info">
                            <div class="zip-name">${file.name}</div>
                            <div class="zip-details">${formatSize(file.size)} - ${formatDate(attachment.uploadDate)}</div>
                        </div>
                    </div>`;
            } else {
                showMessage(`Tipe file ${file.type} tidak didukung untuk disematkan.`, 'error');
                return;
            }

            document.execCommand('insertHTML', false, elementHTML + "<p><br></p>");
            this.saveNote(); // Simpan catatan untuk memastikan attachment tersimpan
        };
        
        reader.readAsDataURL(file);
    }
    
    saveNote(isManual = false) { 
        const title = this.dom.titleInput.value.trim(); 
        const content = this.dom.editorContent.innerHTML; 
        const tags = this.dom.tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag); 
        const mood = this.dom.moodSelector.value; 
        const date = this.dom.dateFilter.value || new Date().toISOString().split('T')[0];
        const fontSize = this.dom.editorContent.style.fontSize || '16px';
        const fontFamily = this.dom.editorContent.style.fontFamily || "'Poppins', sans-serif";

        if (!title && !this.dom.editorContent.innerText.trim()) { 
            if (isManual) showMessage('Judul atau isi tidak boleh kosong.', 'error'); 
            return; 
        } 
        
        if (this.currentNoteId) { 
            const index = this.notes.findIndex(n => n.id === this.currentNoteId); 
            const existingNote = this.notes[index]; 
            existingNote.title = title; 
            existingNote.content = content; 
            existingNote.tags = tags; 
            existingNote.mood = mood; 
            existingNote.date = new Date(date).toISOString(); 
            existingNote.lastModified = new Date().toISOString();
            existingNote.fontSize = fontSize;
            existingNote.fontFamily = fontFamily;
            // attachments sudah ditambahkan saat upload ZIP
        } else { 
            const note = { 
                id: Date.now(), 
                title: title, 
                content: content, 
                tags: tags, 
                mood: mood, 
                date: new Date(date).toISOString(), 
                lastModified: new Date().toISOString(), 
                isLocked: false,
                fontSize: fontSize,
                fontFamily: fontFamily,
                attachments: [] // Inisialisasi attachments untuk catatan baru
            }; 
            this.notes.unshift(note); 
            this.currentNoteId = note.id; 
        } 
        
        this.saveToStorage(); 
        this.displayNotes(); 
        
        if (isManual) { 
            showMessage('Catatan disimpan!', 'success'); 
            this.dom.saveStatusEl.innerHTML = `<i class="fas fa-cloud"></i>Disimpan`; 
            this.dom.saveStatusEl.style.color = 'var(--text-secondary)'; 
        } 
    }
    
    autoSave() { const title = this.dom.titleInput.value.trim(); const content = this.dom.editorContent.innerHTML; if ((title || this.dom.editorContent.innerText.trim()) && this.currentNoteId) { this.saveNote(); showMessage('Tersimpan otomatis', 'info'); this.dom.saveStatusEl.innerHTML = `<i class="fas fa-cloud"></i>Disimpan`; this.dom.saveStatusEl.style.color = 'var(--text-secondary)'; } }
    loadNotes() { const saved = localStorage.getItem('notes_v5.9.0'); if (saved) { this.notes = JSON.parse(saved); this.displayNotes(); } }
    saveToStorage() { localStorage.setItem('notes_v5.9.0', JSON.stringify(this.notes)); }
    
    displayNotes(filteredNotes = null) { 
        const notesToShow = (filteredNotes || this.notes).sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified)); 
        if (notesToShow.length === 0) { 
            this.dom.notesList.innerHTML = '<div class="text-center text-gray-500 py-4">Tidak ada catatan.</div>'; 
            return; 
        } 
        this.dom.notesList.innerHTML = notesToShow.map(note => { 
            const lockIcon = note.isLocked ? '<i class="fas fa-lock text-yellow-500 text-xs ml-2"></i>' : ''; 
            const tagsHtml = (note.tags && note.tags.length > 0) 
                ? `<div class="mt-2 flex flex-wrap gap-2">${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
                : '';
            return `<div class="note-item p-3 rounded-lg mb-2 cursor-pointer note-item-clickable" data-action="click-to-edit" data-id="${note.id}">
                        <div class="flex items-start justify-between mb-1">
                            <div>
                                <strong class="text-md text-purple-300">${note.title || 'Tanpa Judul'}${lockIcon}</strong>
                                <span class="block text-xs text-gray-400">${this.formatDate(note.lastModified)}</span>
                            </div>
                            <div class="flex gap-2">
                                <button data-action="preview" data-id="${note.id}" class="text-green-400 hover:text-green-300" title="Pratinjau"><i class="fas fa-eye"></i></button>
                                <button data-action="export-pdf" data-id="${note.id}" class="text-blue-400 hover:text-blue-300" title="Ekspor ke PDF"><i class="fas fa-file-pdf"></i></button>
                                <button data-action="delete" data-id="${note.id}" class="text-red-400 hover:text-red-300" title="Hapus"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-400">${note.isLocked ? '<em>Konten terkunci...</em>' : this.truncateContent(note.content, 80)}</div>
                        ${tagsHtml}
                    </div>`; 
        }).join(''); 
    }
    
    editNote(id) { 
        const note = this.notes.find(n => n.id === id); 
        if (note) { 
            this.currentNoteId = id; 
            this.dom.titleInput.value = note.title; 
            this.dom.editorContent.innerHTML = note.content; 
            this.dom.tagsInput.value = (note.tags || []).join(', '); 
            this.dom.moodSelector.value = note.mood || 'neutral'; 
            this.dom.dateFilter.value = (note.date || new Date().toISOString()).split('T')[0];
            
            // Terapkan gaya yang tersimpan
            this.dom.editorContent.style.fontSize = note.fontSize || '16px';
            this.dom.fontSizeInput.value = parseInt(note.fontSize) || 16;
            this.dom.editorContent.style.fontFamily = note.fontFamily || "'Poppins', sans-serif";
            this.dom.fontSelect.value = note.fontFamily || "'Poppins', sans-serif";

            this.dom.titleInput.focus(); 
            this.updateStatusBar(); 
            showMessage('Catatan dimuat untuk diedit', 'info'); 
        } 
    }
    
    deleteNote(id) { showConfirm('Hapus Catatan?', 'Yakin ingin menghapus catatan ini secara permanen?', () => { this.notes = this.notes.filter(n => n.id !== id); this.saveToStorage(); this.displayNotes(); if (this.currentNoteId === id) { this.clearEditor(); } showMessage('Catatan dihapus!', 'success'); }); }
    
    previewNote(id) { 
        const note = this.notes.find(n => n.id === id); 
        if (note) { 
            if (note.isLocked) { 
                showMessage('Catatan ini terkunci. Buka kunci untuk melihat pratinjau.', 'error'); 
                return; 
            } 
            
            const previewContainer = document.createElement('div');
            previewContainer.style.fontFamily = note.fontFamily || "'Poppins', sans-serif";
            previewContainer.style.fontSize = note.fontSize || '16px';

            previewContainer.innerHTML = `
                <h2 class="font-bold text-2xl mb-2 text-purple-300" style="font-family: 'Poppins', sans-serif; font-size: 1.5rem;">${note.title || 'Tanpa Judul'}</h2>
                <p class="text-sm text-gray-400 mb-4" style="font-family: 'Poppins', sans-serif; font-size: 0.875rem;">${this.formatDate(note.lastModified)}</p>
                <div class="pro-editor-content max-w-none">${note.content}</div>`;
            
            this.dom.previewContent.innerHTML = '';
            this.dom.previewContent.appendChild(previewContainer);
            this.dom.previewModal.classList.add('show'); 
        } 
    }
    
    closePreview() { this.dom.previewModal.classList.remove('show'); }
    
    clearEditor() { 
        this.dom.titleInput.value = ''; 
        this.dom.editorContent.innerHTML = ''; 
        this.dom.tagsInput.value = ''; 
        this.dom.moodSelector.value = 'neutral'; 
        this.dom.dateFilter.value = new Date().toISOString().split('T')[0]; 
        this.currentNoteId = null; 
        
        // Reset gaya ke default
        this.dom.editorContent.style.fontSize = '16px';
        this.dom.fontSizeInput.value = 16;
        this.dom.editorContent.style.fontFamily = "'Poppins', sans-serif";
        this.dom.fontSelect.value = "'Poppins', sans-serif";

        this.updateStatusBar(); 
    }
    
    addNewNote() { this.clearEditor(); this.dom.titleInput.focus(); showMessage('Editor siap untuk catatan baru.', 'info'); }
    
    filterNotes() { 
        const query = this.dom.searchInput.value.toLowerCase(); 
        const mood = this.dom.moodFilter.value; 
        let filtered = this.notes; 
        if (query) { 
            filtered = filtered.filter(note => (note.title && note.title.toLowerCase().includes(query)) || (!note.isLocked && this.truncateContent(note.content, 10000).toLowerCase().includes(query)) || (note.tags && note.tags.some(tag => tag.toLowerCase().includes(query)))); 
        } 
        if (mood) { 
            filtered = filtered.filter(note => note.mood === mood); 
        } 
        this.displayNotes(filtered); 
    }
    
    formatDate(dateString) { return dateString ? new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''; }
    
    truncateContent(html, length) { const text = html.replace(/<[^>]*>/g, ''); if (text.length <= length) return text; return text.substring(0, length) + '...'; }

    async exportSingleNoteToPdf(noteId) {
        if (!checkPremiumAccess()) return;
        const note = this.notes.find(n => n.id === noteId);
        if (!note) {
            showMessage('Catatan tidak ditemukan.', 'error');
            return;
        }
        if (note.isLocked) {
            showMessage('Buka kunci catatan sebelum mengekspor.', 'error');
            return;
        }

        showMessage(`Mempersiapkan ekspor PDF untuk "${note.title || 'catatan'}"...`, 'info');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        // Buat elemen tersembunyi untuk rendering
        const renderDiv = document.createElement('div');
        renderDiv.style.position = 'absolute';
        renderDiv.style.left = '-9999px';
        renderDiv.style.width = '700px'; // Lebar yang cukup untuk rendering berkualitas
        renderDiv.style.padding = '20px';
        renderDiv.style.fontFamily = note.fontFamily || "'Poppins', sans-serif";
        renderDiv.style.fontSize = note.fontSize || '16px';
        renderDiv.style.color = '#000'; // Warna teks dasar untuk PDF
        renderDiv.style.background = '#fff';
        
        // Sanitasi konten untuk rendering
        const tempContentDiv = document.createElement('div');
        tempContentDiv.innerHTML = note.content;
        // Ganti iframe dengan placeholder atau gambar thumbnail
        tempContentDiv.querySelectorAll('iframe').forEach(iframe => {
            const placeholder = document.createElement('div');
            placeholder.style.border = '1px dashed #ccc';
            placeholder.style.padding = '10px';
            placeholder.style.textAlign = 'center';
            placeholder.textContent = `[Konten tersemat dari: ${new URL(iframe.src).hostname}]`;
            iframe.parentNode.replaceChild(placeholder, iframe);
        });
        
        renderDiv.innerHTML = `<h1>${note.title || 'Tanpa Judul'}</h1><hr><p><small>Terakhir diubah: ${this.formatDate(note.lastModified)}</small></p>${tempContentDiv.innerHTML}`;
        document.body.appendChild(renderDiv);

        try {
            const canvas = await html2canvas(renderDiv, {
                scale: 2, // Meningkatkan resolusi
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            });

            const imgData = canvas.toDataURL('image/png');
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            let heightLeft = pdfHeight;
            let position = 0;
            const margin = 10;

            doc.addImage(imgData, 'PNG', margin, position, pdfWidth - (margin*2), pdfHeight - (margin*2));
            heightLeft -= (doc.internal.pageSize.getHeight() - (margin*2));

            while (heightLeft >= 0) {
                position = heightLeft - pdfHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', margin, position - margin, pdfWidth - (margin*2), pdfHeight - margin);
                heightLeft -= (doc.internal.pageSize.getHeight() - (margin*2));
            }

            doc.save(`Catatan_${(note.title || 'Untitled').replace(/ /g, '_')}.pdf`);
            showMessage('PDF berhasil diekspor!', 'success');

        } catch (error) {
            console.error("Gagal mengekspor PDF:", error);
            showMessage('Gagal membuat PDF. Lihat konsol untuk detail.', 'error');
        } finally {
            document.body.removeChild(renderDiv);
        }
    }
}

// ===================================================================================
// ========================== BAGIAN 2: LOGIKA APLIKASI UTAMA ========================
// ===================================================================================

let currentSection = 'dashboard'; 
let currentDate = new Date(); 
let currentMode = 'personal'; 
let timerInterval; 
let timerMinutes = 25; 
let timerSeconds = 0; 
let isTimerRunning = false; 
let touchStartX = 0; 
let touchEndX = 0; 
let isDragging = false; 

let masterDateRange = '7d'; 
let financeDateRange = { start: null, end: null };
let dateRangeSource = 'dashboard';

const storage = { 
    get: (key, defaultValue = null) => { 
        try { 
            const item = localStorage.getItem(key); 
            return item ? JSON.parse(item) : defaultValue; 
        } catch { 
            return defaultValue; 
        } 
    }, 
    set: (key, value) => { 
        localStorage.setItem(key, JSON.stringify(value)); 
    }, 
    getAppData: () => { 
        return storage.get('lifeHubData_v6.2.0', { 
            currentMode: 'personal', 
            theme: 'dark', 
            isVideoMuted: true, 
            personal: { transactions: [], tasks: [], splitBills: [], portals: [] }, 
            business: { transactions: [], tasks: [], splitBills: [], portals: [] } 
        }); 
    }, 
    saveAppData: (data) => { 
        storage.set('lifeHubData_v6.2.0', data); 
    } 
};

const GOOGLE_CLIENT_ID = "175269804015-7agb1gr0nd6ah66co5qen34dd2mvtm68.apps.googleusercontent.com"; 
const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email";
const DRIVE_BACKUP_FOLDER_NAME = "Uranuspace_App_Backups";
const DRIVE_UPLOAD_FOLDER_NAME = "uranuspace_storage";
let googleTokenClient; 
let googleAccessToken = null;

// Instance untuk Editor HTML
let htmlEditorApp;

document.addEventListener('DOMContentLoaded', function() { 
    initializeApp(); 
    setupEventListeners(); 
    const notesApp = new NotesApp(); 
    notesApp.init(); 
    // Inisialisasi Editor HTML
    htmlEditorApp = new HtmlEditorApp();
    htmlEditorApp.init();
    setTimeout(initGisClient, 500); 
    setupPremiumFeatures(); // [BARU] Menambahkan event listener untuk fitur premium
});

async function initializeApp() {
    const bgMediaBlob = await getFileFromDB('customBackground');
    const bgType = localStorage.getItem('customBackgroundType');

    if (bgMediaBlob && bgType) {
        const bgUrl = URL.createObjectURL(bgMediaBlob);
        const bgVideo = document.getElementById('bg-video');
        const bgImageLayer = document.getElementById('bg-image-layer');
        resetBackgrounds(); 

        if (bgType.startsWith('image/')) {
            bgImageLayer.style.backgroundImage = `url('${bgUrl}')`;
            bgImageLayer.style.display = 'block';
            document.body.classList.remove('gradient-bg');
        } else if (bgType.startsWith('video/')) {
            bgVideo.src = bgUrl;
            bgVideo.style.display = 'block';
            const appData = storage.getAppData();
            bgVideo.muted = appData.isVideoMuted;
            bgVideo.play().catch(e => console.error("Gagal memutar video saat memuat:", e));
            document.body.classList.remove('gradient-bg');
        }
    }

    const appData = storage.getAppData();
    currentMode = appData.currentMode || 'personal';
    document.getElementById('modeSelect').value = currentMode;
    
    if (appData.theme === 'light') {
        document.body.classList.add('light-mode');
    } else if (appData.theme === 'black') {
        document.body.classList.add('black-mode');
    }
    updateThemeUI(appData.theme || 'dark');
    document.getElementById('bg-video').muted = appData.isVideoMuted;
    updateVideoSoundUI();
    const splitBillDateInput = document.getElementById('splitBillDate');
    if (splitBillDateInput) {
        splitBillDateInput.value = new Date().toISOString().split('T')[0];
    }
    switchSection('dashboard');
    renderPortals();
}

function setupEventListeners() { 
    document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', () => switchSection(item.dataset.section))); 
    document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu); 
    document.getElementById('overlay').addEventListener('click', closeMobileMenu); 
    document.getElementById('themeToggle').addEventListener('click', toggleTheme); 
    document.getElementById('modeSelect').addEventListener('change', switchMode); 
    document.getElementById('logo-container').addEventListener('click', enterPreviewMode); 
    document.getElementById('addTransactionBtn').addEventListener('click', () => showTransactionModal()); 
    document.getElementById('exportFinanceBtn').addEventListener('click', exportFinancePDF); 
    document.getElementById('searchTransaction').addEventListener('input', filterAndRenderTransactions); 
    document.getElementById('categoryFilter').addEventListener('change', filterAndRenderTransactions); 
    document.getElementById('typeFilter').addEventListener('change', filterAndRenderTransactions); 
    document.getElementById('financeDateFilterBtn').addEventListener('click', () => showDateRangeModal('finance')); 
    document.getElementById('taskForm').addEventListener('submit', saveTask); 
    document.getElementById('startTimerBtn').addEventListener('click', startTimer); 
    document.getElementById('pauseTimerBtn').addEventListener('click', pauseTimer); 
    document.getElementById('resetTimerBtn').addEventListener('click', resetTimer); 
    document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1)); 
    document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1)); 
    document.getElementById('splitBillForm').addEventListener('submit', calculateSplitBill); 
    document.getElementById('backupData').addEventListener('click', backupData); 
    document.getElementById('restoreFile').addEventListener('change', restoreData);
    document.getElementById('restoreData').addEventListener('click', () => document.getElementById('restoreFile').click());
    document.getElementById('clearAllData').addEventListener('click', () => { showConfirm('Hapus Semua Data?', 'Operasi ini tidak dapat diurungkan. Anda yakin ingin menghapus semua data lokal?', clearAllDataConfirmed); }); 
    document.getElementById('applyBgMediaBtn').addEventListener('click', applyUploadedMedia); 
    document.getElementById('resetBgMediaBtn').addEventListener('click', resetBackgroundMedia); 
    document.getElementById('toggleVideoSoundBtn').addEventListener('click', toggleVideoSound); 
    document.body.addEventListener('touchstart', handleTouchStart, { passive: true }); 
    document.body.addEventListener('touchend', handleTouchEnd); 
    document.body.addEventListener('mousedown', handleMouseDown); 
    document.body.addEventListener('mouseup', handleMouseUp); 
    setupMasterRangeSelector(); 
    document.getElementById('applyDateRange').addEventListener('click', applyDateRange); 
    document.getElementById('cancelDateRange').addEventListener('click', () => document.getElementById('dateRangeModal').classList.remove('show')); 
    document.getElementById('auth-button').addEventListener('click', handleAuthClick); 
    document.getElementById('backup-button').addEventListener('click', handleBackupClick); 
    document.getElementById('restore-button').addEventListener('click', showRestoreOptionsModal); 
    document.getElementById('addNewPortalBtn').addEventListener('click', showPortalModal);
    document.getElementById('toggle-email-visibility').addEventListener('click', toggleEmailVisibility);
    
    document.getElementById('smart-upload-button').addEventListener('click', () => document.getElementById('smart-upload-input').click());
    document.getElementById('smart-upload-input').addEventListener('change', handleSmartUpload);

    // Event listener untuk fitur baru
    document.getElementById('download-via-link-button').addEventListener('click', showDownloadViaLinkModal);
    document.getElementById('manage-drive-files-button').addEventListener('click', showManageFilesModal);


    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            document.getElementById('lockSound')?.pause();
        }
    });

    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const pdfTimeRangeSelector = document.getElementById('pdf-time-range');
    const pdfCustomRangeInputs = document.getElementById('pdf-custom-range-inputs');

    pdfTimeRangeSelector.addEventListener('change', () => {
        if (pdfTimeRangeSelector.value === 'custom') {
            pdfCustomRangeInputs.classList.remove('hidden');
        } else {
            pdfCustomRangeInputs.classList.add('hidden');
        }
    });

    exportPdfBtn.addEventListener('click', () => {
        const selectedRange = pdfTimeRangeSelector.value;
        if (selectedRange === 'custom') {
            const startDate = document.getElementById('pdf-start-date').value;
            const endDate = document.getElementById('pdf-end-date').value;
            if (!startDate || !endDate) {
                showMessage('Harap pilih tanggal mulai dan selesai untuk rentang kustom.', 'error');
                return;
            }
            exportAllToPdf('custom', startDate, endDate);
        } else {
            exportAllToPdf(selectedRange);
        }
    });
    
    document.getElementById('export-images-btn').addEventListener('click', () => {
        const selectedRange = document.getElementById('pdf-time-range').value;
        if (selectedRange === 'custom') {
            const startDate = document.getElementById('pdf-start-date').value;
            const endDate = document.getElementById('pdf-end-date').value;
            if (!startDate || !endDate) {
                showMessage('Harap pilih tanggal mulai dan selesai untuk rentang kustom.', 'error');
                return;
            }
            exportAllToImages('custom', startDate, endDate);
        } else {
            exportAllToImages(selectedRange);
        }
    });
}
function enterPreviewMode() { document.body.classList.add('preview-mode'); } function handleGestureEnd() { const swipeThreshold = 70; const deltaX = touchEndX - touchStartX; if (document.querySelector('.modal.show')) return; if (deltaX < -swipeThreshold) { document.body.classList.remove('preview-mode'); } } function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; } function handleTouchEnd(e) { touchEndX = e.changedTouches[0].screenX; handleGestureEnd(); } function handleMouseDown(e) { if (e.button !== 0 || e.target.closest('button, input, select, textarea, a, .modal')) return; isDragging = true; touchStartX = e.screenX; } function handleMouseUp(e) { if (!isDragging) return; isDragging = false; touchEndX = e.screenX; handleGestureEnd(); }
function switchSection(section) { 
    document.getElementById('lockSound')?.pause();

    // Cek jika section yang dituju adalah premium
    const navItem = document.querySelector(`.nav-item[data-section="${section}"]`);
    if (navItem && navItem.dataset.premium === 'true') {
        if (!isPremiumUser) {
            showPremiumPopup();
            return; // Hentikan navigasi
        }
    }

    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden')); 
    document.getElementById(section + '-section').classList.remove('hidden'); 
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active')); 
    document.querySelector(`[data-section="${section}"]`).classList.add('active'); 
    currentSection = section; 
    switch(section) { 
        case 'dashboard': loadDashboard(); break; 
        case 'finance': loadFinancePage(); break; 
        case 'tasks': loadTasksPage(); break; 
        case 'split': loadSplitPage(); break; 
        case 'notes': break; 
        case 'settings': break; 
        case 'html-editor': 
            if (htmlEditorApp) htmlEditorApp.showWelcomeOrLastNote();
            break;
    } 
    closeMobileMenu(); 
}
function switchMode(e) { currentMode = e.target.value; let appData = storage.getAppData(); appData.currentMode = currentMode; storage.saveAppData(appData); switchSection(currentSection); renderPortals(); } 

function toggleTheme() {
    let currentTheme = 'dark';
    if (document.body.classList.contains('light-mode')) {
        currentTheme = 'light';
    } else if (document.body.classList.contains('black-mode')) {
        currentTheme = 'black';
    }

    let nextTheme;
    document.body.classList.remove('light-mode', 'black-mode');

    if (currentTheme === 'dark') {
        nextTheme = 'light';
        document.body.classList.add('light-mode');
    } else if (currentTheme === 'light') {
        nextTheme = 'black';
        document.body.classList.add('black-mode');
    } else {
        nextTheme = 'dark';
    }

    let appData = storage.getAppData();
    appData.theme = nextTheme;
    storage.saveAppData(appData);
    updateThemeUI(nextTheme);
}

function updateThemeUI(theme) {
    const icon = document.querySelector('#themeToggle i');
    icon.classList.remove('fa-sun', 'fa-moon', 'fa-star');

    if (theme === 'dark') {
        icon.classList.add('fa-sun');
    } else if (theme === 'light') {
        icon.classList.add('fa-moon');
    } else {
        icon.classList.add('fa-star');
    }
    
    if (currentSection === 'dashboard') {
        refreshDashboardData();
    }
    renderPortals();
}

function toggleMobileMenu() { 
    document.getElementById('sidebar').classList.toggle('open'); 
    document.getElementById('overlay').classList.toggle('show'); 
    // [BARU] Tambahkan/hapus kelas pada body untuk watermark
    document.body.classList.toggle('sidebar-is-open');
} 
function closeMobileMenu() { 
    document.getElementById('sidebar').classList.remove('open'); 
    document.getElementById('overlay').classList.remove('show'); 
    // [BARU] Hapus kelas dari body
    document.body.classList.remove('sidebar-is-open');
}

function loadDashboard() { const appData = storage.getAppData(); const modeData = appData[currentMode]; const balance = modeData.transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0); const today = new Date().toISOString().split('T')[0]; const todayTasks = modeData.tasks.filter(p => p.datetime && p.datetime.startsWith(today) && !p.completed).length; const pendingTasks = modeData.tasks.filter(t => !t.completed).length; document.getElementById('totalBalance').textContent = formatCurrency(balance); document.getElementById('todayTasksCount').textContent = todayTasks; document.getElementById('pendingTasks').textContent = pendingTasks; document.getElementById('activeMode').textContent = currentMode === 'personal' ? 'Pribadi' : 'Bisnis'; refreshDashboardData(); }
function refreshDashboardData() { updateDashboardCharts(); loadAnalysisCharts(); loadRecentActivities(); } function loadRecentActivities() { const appData = storage.getAppData(); const modeData = appData[currentMode]; const activities = []; const filteredTransactions = filterDataByRange(modeData.transactions, masterDateRange, 'date'); const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime'); const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date'); filteredTransactions.forEach(t => activities.push({ type: 'transaction', icon: t.type === 'income' ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-pink-500', text: `${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}: ${formatCurrency(t.amount)}`, time: t.date })); filteredTasks.forEach(p => activities.push({ type: 'task', icon: 'fa-calendar-check text-blue-500', text: `Tugas: ${p.title}`, time: p.datetime })); filteredSplits.forEach(s => activities.push({ type: 'split', icon: 'fa-receipt text-green-500', text: `Split Bill: ${formatCurrency(s.totalBill)}`, time: s.date })); activities.sort((a, b) => new Date(b.time) - new Date(a.time)); const container = document.getElementById('recentActivities'); container.innerHTML = activities.length > 0 ? activities.slice(0, 15).map(activity => `<div class="flex items-center justify-between p-2 hover:bg-purple-500/10 rounded"><div class="flex items-center"><i class="fas ${activity.icon} mr-3"></i><span>${activity.text}</span></div><span class="text-sm text-gray-400">${formatDate(activity.time)}</span></div>`).join('') : '<p class="text-gray-500">Tidak ada aktivitas dalam rentang waktu ini.</p>'; }
function loadFinancePage() { populateFinanceFilters(); filterAndRenderTransactions(); updateFinanceSummary(); } function updateFinanceSummary() { const appData = storage.getAppData(); const transactions = appData[currentMode].transactions; const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); document.getElementById('totalIncome').textContent = formatCurrency(income); document.getElementById('totalExpense').textContent = formatCurrency(expense); document.getElementById('balance').textContent = formatCurrency(income - expense); } 
function filterAndRenderTransactions() { const appData = storage.getAppData(); let transactions = appData[currentMode].transactions; const search = document.getElementById('searchTransaction').value.toLowerCase(); const category = document.getElementById('categoryFilter').value; const type = document.getElementById('typeFilter').value; if (search) transactions = transactions.filter(t => t.description.toLowerCase().includes(search)); if (category) transactions = transactions.filter(t => t.category === category); if (type) transactions = transactions.filter(t => t.type === type); if (financeDateRange.start && financeDateRange.end) { transactions = transactions.filter(t => { const tDate = new Date(t.date); return tDate >= new Date(financeDateRange.start) && tDate <= new Date(financeDateRange.end); }); } displayTransactions(transactions); } 
function displayTransactions(transactions) { const container = document.getElementById('transactionsList'); if (transactions.length === 0) { container.innerHTML = '<p class="text-center text-gray-500">Belum ada transmisi data</p>'; return; } container.innerHTML = [...transactions].reverse().map(t => `<div class="p-4 rounded-md flex justify-between items-center hover:bg-purple-500/10 cursor-pointer ${t.type}" onclick="showTransactionModal('${t.id}')"><div class="flex items-center"><i class="fas ${getTransactionIcon(t.category)} mr-4 text-xl"></i><div><h4 class="font-semibold">${t.description}</h4><p class="text-sm text-gray-400">${getCategoryName(t.category)} • ${formatDate(t.date)}</p></div></div><div class="text-right"><p class="font-bold font-mono ${t.type === 'income' ? 'text-green-500' : 'text-pink-500'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</p><button onclick="confirmDeleteTransaction('${t.id}', event)" class="text-red-500 hover:text-red-400 ml-2 text-xs"><i class="fas fa-trash"></i></button></div></div>`).join(''); } function showTransactionModal(id = null) { const appData = storage.getAppData(); const transaction = id ? appData[currentMode].transactions.find(t => t.id === id) : null; const content = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-purple-600">${id ? 'Edit' : 'Tambah'} Transaksi</h3><button class="closeModal text-gray-400 hover:text-purple-600"><i class="fas fa-times"></i></button></div><form id="transactionForm" class="space-y-4"><input type="hidden" id="transactionId" value="${id || ''}"><div><label class="block text-sm font-medium mb-1">Tipe</label><select id="transactionType" class="custom-input" required>${['income', 'expense'].map(o => `<option value="${o}" ${transaction?.type === o ? 'selected' : ''}>${o === 'income' ? 'Pemasukan' : 'Pengeluaran'}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-1">Jumlah</label><input type="number" id="transactionAmount" class="custom-input" value="${transaction?.amount || ''}" required></div><div><label class="block text-sm font-medium mb-1">Kategori</label><select id="transactionCategory" class="custom-input" required>${Object.keys(getCategoryName()).map(c => `<option value="${c}" ${transaction?.category === c ? 'selected' : ''}>${getCategoryName(c)}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-1">Deskripsi</label><input type="text" id="transactionDescription" class="custom-input" value="${transaction?.description || ''}" required></div><div><label class="block text-sm font-medium mb-1">Tanggal</label><input type="date" id="transactionDate" class="custom-input" value="${transaction?.date || new Date().toISOString().split('T')[0]}" required></div><div class="flex gap-2 mt-6"><button type="submit" class="custom-button flex-1">Simpan</button><button type="button" class="closeModal custom-button custom-button-danger">Batal</button></div></form>`; showModal(content); document.getElementById('transactionForm').addEventListener('submit', saveTransaction); } function saveTransaction(e) { e.preventDefault(); const id = document.getElementById('transactionId').value || generateId(); const newTransaction = { id, type: document.getElementById('transactionType').value, amount: parseFloat(document.getElementById('transactionAmount').value), category: document.getElementById('transactionCategory').value, description: document.getElementById('transactionDescription').value, date: document.getElementById('transactionDate').value, }; let appData = storage.getAppData(); if (document.getElementById('transactionId').value) { const index = appData[currentMode].transactions.findIndex(t => t.id === id); if (index > -1) appData[currentMode].transactions[index] = newTransaction; } else { appData[currentMode].transactions.push(newTransaction); } storage.saveAppData(appData); loadFinancePage(); closeModal(); showMessage("Transaksi disimpan!", "success"); } function confirmDeleteTransaction(id, event) { event.stopPropagation(); showConfirm('Hapus Transaksi?', 'Yakin ingin menghapus transmisi data ini?', () => deleteTransaction(id)); } function deleteTransaction(id) { let appData = storage.getAppData(); appData[currentMode].transactions = appData[currentMode].transactions.filter(t => t.id !== id); storage.saveAppData(appData); loadFinancePage(); } function populateFinanceFilters() { const appData = storage.getAppData(); const categories = [...new Set(appData[currentMode].transactions.map(t => t.category))]; const categoryFilter = document.getElementById('categoryFilter'); categoryFilter.innerHTML = '<option value="">Semua Kategori</option>' + categories.map(c => `<option value="${c}">${getCategoryName(c)}</option>`).join(''); const typeFilter = document.getElementById('typeFilter'); typeFilter.innerHTML = '<option value="">Semua Tipe</option><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option>'; }
function loadTasksPage() { renderTasks(); generateCalendar(); } function renderTasks() { const appData = storage.getAppData(); const tasks = appData[currentMode].tasks; const list = document.getElementById('taskList'); list.innerHTML = ''; const sortedTasks = [...tasks].sort((a, b) => new Date(a.datetime) - new Date(b.datetime)); if (sortedTasks.length === 0) { list.innerHTML = '<p class="text-gray-500 text-center">Tidak ada tugas. Waktunya bersantai!</p>'; return; } sortedTasks.forEach(task => { const item = document.createElement('div'); item.className = `task-item p-3 rounded-lg flex justify-between items-center hover:bg-purple-500/10 ${task.completed ? 'completed' : ''}`; const priorityColor = { high: '#f472b6', medium: '#fbbf24', low: '#4ade80' }; item.innerHTML = `<div class="flex items-center"><input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${task.id}')" class="w-5 h-5 rounded bg-purple-900/50 border-purple-400 text-purple-600 focus:ring-purple-500"><div class="ml-4"><strong class="block">${task.title}</strong><small class="text-gray-400">${formatDateTime(task.datetime)} | <span style="color: ${priorityColor[task.priority]}">●</span> ${task.priority}</small></div></div><button onclick="confirmDeleteTask('${task.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>`; list.appendChild(item); }); } function saveTask(e) { e.preventDefault(); const task = { id: generateId(), title: document.getElementById('taskTitle').value, datetime: document.getElementById('taskDateTime').value, priority: document.getElementById('taskPriority').value, completed: false, }; let appData = storage.getAppData(); appData[currentMode].tasks.push(task); storage.saveAppData(appData); renderTasks(); generateCalendar(); document.getElementById('taskForm').reset(); showMessage("Tugas ditambahkan!", "success"); } function toggleTask(id) { let appData = storage.getAppData(); const task = appData[currentMode].tasks.find(t => t.id === id); if (task) { task.completed = !task.completed; storage.saveAppData(appData); renderTasks(); generateCalendar(); } } function confirmDeleteTask(id) { showConfirm('Hapus Tugas?', 'Yakin ingin menghapus tugas ini?', () => deleteTask(id)); } function deleteTask(id) { let appData = storage.getAppData(); appData[currentMode].tasks = appData[currentMode].tasks.filter(t => t.id !== id); storage.saveAppData(appData); renderTasks(); generateCalendar(); }
function generateCalendar() { const calendar = document.getElementById('calendar'); document.getElementById('currentMonth').textContent = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(currentDate); calendar.innerHTML = ''; const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const appData = storage.getAppData(); const tasks = appData[currentMode].tasks; const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab']; days.forEach(day => calendar.innerHTML += `<div class="text-center font-bold text-purple-400 text-sm">${day}</div>`); for (let i = 0; i < firstDay; i++) calendar.innerHTML += '<div></div>'; for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const dayTasks = tasks.filter(t => t.datetime && t.datetime.startsWith(dateStr)); const isToday = new Date().toDateString() === new Date(year, month, day).toDateString(); let dayClass = 'text-center p-2 border border-transparent rounded-md transition-colors duration-300 relative'; if (isToday) dayClass += ' border-purple-400 bg-purple-500/10'; let priorityIndicator = ''; if (dayTasks.length > 0) { const hasHigh = dayTasks.some(t => t.priority === 'high' && !t.completed); const hasMedium = dayTasks.some(t => t.priority === 'medium' && !t.completed); const hasLow = dayTasks.some(t => t.priority === 'low' && !t.completed); let indicatorColor = ''; if (hasHigh) indicatorColor = '#f472b6'; else if (hasMedium) indicatorColor = '#fbbf24'; else if (hasLow) indicatorColor = '#4ade80'; if (indicatorColor) { priorityIndicator = `<span class="absolute top-1 right-1 h-2 w-2 rounded-full" style="background-color: ${indicatorColor};"></span>`; } } calendar.innerHTML += `<div class="${dayClass}">${day}${priorityIndicator}</div>`; } }
function changeMonth(dir) { currentDate.setMonth(currentDate.getMonth() + dir); generateCalendar(); }
function startTimer() { if (isTimerRunning) return; isTimerRunning = true; timerInterval = setInterval(() => { if (timerSeconds === 0) { if (timerMinutes === 0) { resetTimer(); showMessage("Pomodoro Selesai!", "success"); return; } timerMinutes--; timerSeconds = 59; } else { timerSeconds--; } updateTimerDisplay(); }, 1000); } function pauseTimer() { isTimerRunning = false; clearInterval(timerInterval); } function resetTimer() { pauseTimer(); timerMinutes = 25; timerSeconds = 0; updateTimerDisplay(); } function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = `${String(timerMinutes).padStart(2, '0')}:${String(timerSeconds).padStart(2, '0')}`; }
function loadSplitPage() { document.getElementById('splitBillDate').value = new Date().toISOString().split('T')[0]; renderSplitHistory(); } function calculateSplitBill(e) { e.preventDefault(); const totalBill = parseFloat(document.getElementById('totalBill').value); const billDate = document.getElementById('splitBillDate').value; const peopleNames = document.getElementById('peopleNames').value.split(',').map(name => name.trim()).filter(name => name); const percentagesStr = document.getElementById('splitPercentages').value; const percentages = percentagesStr ? percentagesStr.split(',').map(p => parseFloat(p.trim())) : []; if (peopleNames.length === 0) { showMessage('Harap masukkan setidaknya satu nama.', 'error'); return; } let results; if (percentages.length > 0) { if (percentages.length !== peopleNames.length) { showMessage('Jumlah nama dan persentase harus sama.', 'error'); return; } const totalPercentage = percentages.reduce((sum, p) => sum + p, 0); if (Math.round(totalPercentage) !== 100) { showMessage(`Total persentase harus 100%, bukan ${totalPercentage}%.`, 'error'); return; } if (percentages.some(isNaN)) { showMessage('Mohon masukkan persentase yang valid.', 'error'); return; } results = peopleNames.map((name, index) => ({ name, amount: (totalBill * percentages[index]) / 100, percentage: percentages[index] })); } else { const amountPerPerson = totalBill / peopleNames.length; results = peopleNames.map(name => ({ name, amount: amountPerPerson })); } const splitBill = { id: generateId(), totalBill, results, date: billDate, type: percentages.length > 0 ? 'custom' : 'equal' }; let appData = storage.getAppData(); appData[currentMode].splitBills.push(splitBill); storage.saveAppData(appData); displaySplitResults(results, totalBill, billDate); renderSplitHistory(); document.getElementById('splitBillForm').reset(); document.getElementById('splitBillDate').value = new Date().toISOString().split('T')[0]; } function displaySplitResults(results, totalBill, date) { const resultDiv = document.getElementById('splitResult'); resultDiv.innerHTML = `<h4 class="font-bold mb-2">Total: ${formatCurrency(totalBill)}</h4>` + results.map(r => `<div class="flex justify-between p-2 border-b border-purple-900/50"><span>${r.name} ${r.percentage ? `(${r.percentage}%)` : ''}</span><strong>${formatCurrency(r.amount)}</strong></div>`).join(''); document.getElementById('splitResultCard').classList.remove('hidden'); document.getElementById('exportSplitBtn').onclick = () => exportSplitBillPDF(results, totalBill, date); } function renderSplitHistory() { const appData = storage.getAppData(); const history = appData[currentMode].splitBills; const container = document.getElementById('splitHistory'); container.innerHTML = [...history].reverse().map(split => `<div class="p-3 rounded-md border border-purple-900/50 hover:bg-purple-500/10"><div class="flex justify-between items-center"><div><strong class="block text-blue-400">${formatCurrency(split.totalBill)}</strong><small class="text-gray-400">${formatDate(split.date)} | ${split.results.length} orang | <span class="font-semibold ${split.type === 'custom' ? 'text-pink-400' : 'text-green-400'}">${split.type === 'custom' ? 'Kustom' : 'Merata'}</span></small></div><button onclick="confirmDeleteSplit('${split.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button></div></div>`).join('') || '<p class="text-gray-500 text-center">Tidak ada riwayat.</p>'; } function confirmDeleteSplit(id) { showConfirm('Hapus Riwayat?', 'Yakin ingin menghapus riwayat split bill ini?', () => deleteSplit(id)); } function deleteSplit(id) { let appData = storage.getAppData(); appData[currentMode].splitBills = appData[currentMode].splitBills.filter(s => s.id !== id); storage.saveAppData(appData); renderSplitHistory(); }

async function backupData() {
    showMessage("Memulai proses backup... Mengumpulkan data.", "info");
    try {
        const zip = new JSZip();
        const lifeHubData = storage.getAppData();
        const notesData = storage.get('notes_v5.9.0', []);
        const htmlNotesData = storage.get('lifeHub_htmlNotes_v6.2.0', []); // Tambahkan ini
        
        // Proses media dari catatan dan latar belakang
        const { processedNotes, mediaFiles } = await processMediaForBackup(notesData);
        const { processedBgInfo, backgroundFile } = await processBackgroundForBackup();

        // Tambahkan file media ke ZIP
        for (const [path, blob] of Object.entries(mediaFiles)) {
            zip.file(path, blob);
        }
        if (backgroundFile) {
            zip.file(backgroundFile.path, backgroundFile.blob);
        }

        const allData = {
            lifeHub: lifeHubData,
            notes: processedNotes,
            htmlNotes: htmlNotesData, // Tambahkan ini
            background: processedBgInfo
        };

        zip.file("data.json", JSON.stringify(allData, null, 2));

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lifehub-backup-${new Date().toISOString().split('T')[0]}.zip`;
        a.click();
        URL.revokeObjectURL(url);
        showMessage("Backup ZIP berhasil diunduh!", "success");
    } catch (error) {
        console.error("Gagal membuat backup ZIP:", error);
        showMessage("Gagal membuat backup. Lihat konsol untuk detail.", "error");
    }
}

async function processMediaForBackup(notes) {
    const mediaFiles = {};
    const processedNotes = [];

    for (const note of notes) {
        let newContent = note.content;
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = note.content;

        // Proses media inline (base64)
        const mediaElements = tempDiv.querySelectorAll('img[src^="data:"], video[src^="data:"]');
        let mediaIndex = 0;
        for(const el of mediaElements) {
            const dataUrl = el.src;
            const extension = dataUrl.split('/')[1].split(';')[0];
            const filename = `media_catatan/note_${note.id}_${mediaIndex}.${extension}`;
            
            const blob = dataURLtoBlob(dataUrl);
            mediaFiles[filename] = blob;
            
            el.src = filename; // Ganti src di HTML
            mediaIndex++;
        }
        
        // Proses attachment ZIP
        if (note.attachments && note.attachments.length > 0) {
            for (const attachment of note.attachments) {
                if (attachment.dataUrl) {
                    const zipFilename = `media_catatan/${attachment.id}_${attachment.name}`;
                    const zipBlob = dataURLtoBlob(attachment.dataUrl);
                    mediaFiles[zipFilename] = zipBlob;
                    // Hapus dataUrl dari JSON untuk menghemat ruang, karena sudah disimpan sebagai file terpisah
                    delete attachment.dataUrl; 
                }
            }
        }

        processedNotes.push({ ...note, content: tempDiv.innerHTML });
    }
    return { processedNotes, mediaFiles };
}

async function processBackgroundForBackup() {
    const bgBlob = await getFileFromDB('customBackground');
    const bgType = localStorage.getItem('customBackgroundType');
    if (bgBlob && bgType) {
        const extension = bgType.split('/')[1];
        const filename = `background/background.${extension}`;
        return {
            processedBgInfo: { type: bgType, path: filename },
            backgroundFile: { path: filename, blob: bgBlob }
        };
    }
    return { processedBgInfo: null, backgroundFile: null };
}

async function restoreData() {
    const file = document.getElementById('restoreFile').files[0];
    if (!file) {
        showMessage("Pilih file .zip untuk restore.", "error");
        return;
    }

    try {
        const zip = await JSZip.loadAsync(file);
        const dataFile = zip.file("data.json");
        if (!dataFile) throw new Error("File data.json tidak ditemukan di dalam ZIP.");

        const content = await dataFile.async("string");
        const data = JSON.parse(content);

        if (!data.lifeHub || !data.notes) {
            throw new Error("Struktur file backup tidak valid.");
        }

        showConfirm('Timpa Data Lokal?', 'Data dari backup akan menimpa data lokal Anda. Lanjutkan?', async () => {
            await clearAllDataConfirmed(false); // Hapus data tanpa notifikasi

            // Restore background
            if (data.background && data.background.path) {
                const bgFile = zip.file(data.background.path);
                if (bgFile) {
                    const bgBlob = await bgFile.async("blob");
                    await saveFileToDB('customBackground', bgBlob);
                    localStorage.setItem('customBackgroundType', data.background.type);
                }
            }

            // Restore notes with media
            const restoredNotes = [];
            for (const note of data.notes) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = note.content;

                // Restore media inline
                const mediaElements = tempDiv.querySelectorAll('img[src^="media_catatan/"], video[src^="media_catatan/"]');
                for(const el of mediaElements) {
                    const filePath = el.src.split('/').slice(-2).join('/'); // Ambil path relatif
                    const mediaFile = zip.file(filePath);
                    if (mediaFile) {
                        const mediaBlob = await mediaFile.async("blob");
                        const dataUrl = await blobToDataURL(mediaBlob);
                        el.src = dataUrl;
                    }
                }
                
                // Restore attachment ZIP
                if (note.attachments && note.attachments.length > 0) {
                    for(const attachment of note.attachments) {
                         const zipFilename = `media_catatan/${attachment.id}_${attachment.name}`;
                         const zipFile = zip.file(zipFilename);
                         if (zipFile) {
                             const zipBlob = await zipFile.async("blob");
                             attachment.dataUrl = await blobToDataURL(zipBlob);
                         }
                    }
                }

                restoredNotes.push({ ...note, content: tempDiv.innerHTML });
            }

            storage.saveAppData(data.lifeHub);
            storage.set('notes_v5.9.0', restoredNotes);
            if (data.htmlNotes) { // Tambahkan ini
                storage.set('lifeHub_htmlNotes_v6.2.0', data.htmlNotes);
            }

            showMessage("Restore berhasil! Aplikasi akan dimuat ulang.", "success");
            setTimeout(() => window.location.reload(), 1500);
        });

    } catch (err) {
        console.error("Gagal restore:", err);
        showMessage("File backup korup atau tidak valid.", "error");
    }
}

async function clearAllDataConfirmed(notify = true) {
    localStorage.removeItem('lifeHubData_v6.2.0');
    localStorage.removeItem('notes_v5.9.0');
    localStorage.removeItem('lifeHub_htmlNotes_v6.2.0'); // Tambahkan ini
    localStorage.removeItem('customBackgroundType');
    localStorage.removeItem('customFonts_v5.5.0');
    
    try {
        const keys = await getAllFileKeysFromDB();
        for (const key of keys) {
            await deleteFileFromDB(key);
        }
    } catch (error) {
        console.error("Gagal membersihkan IndexedDB:", error);
    }

    if (notify) {
        initializeApp();
        showMessage("Semua data lokal telah dihapus.", "success");
        setTimeout(() => window.location.reload(), 1000);
    }
}


async function applyUploadedMedia() {
    if (!checkPremiumAccess()) return;
    const bgUploadMediaInput = document.getElementById('bg-upload-media');
    const selectedMediaFile = bgUploadMediaInput.files[0];
    if (!selectedMediaFile) {
        showMessage('Silakan pilih file terlebih dahulu!', 'error');
        return;
    }

    await saveFileToDB('customBackground', selectedMediaFile);
    localStorage.setItem('customBackgroundType', selectedMediaFile.type);

    await initializeApp();
    showMessage('Latar belakang custom berhasil diterapkan dan disimpan.', 'success');
} 

async function resetBackgroundMedia() { 
    if (!checkPremiumAccess()) return;
    resetBackgrounds(); 
    document.getElementById('bg-upload-media').value = ''; 
    document.body.classList.add('gradient-bg'); 
    await deleteFileFromDB('customBackground');
    localStorage.removeItem('customBackgroundType');
    showMessage('Background direset.', 'info'); 
}

function resetBackgrounds() { const bgVideo = document.getElementById('bg-video'); const bgImageLayer = document.getElementById('bg-image-layer'); bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.display = 'none'; bgImageLayer.style.backgroundImage = 'none'; bgImageLayer.style.display = 'none'; } function toggleVideoSound() { const video = document.getElementById('bg-video'); video.muted = !video.muted; let appData = storage.getAppData(); appData.isVideoMuted = video.muted; storage.saveAppData(appData); updateVideoSoundUI(); showMessage(video.muted ? 'Suara video dimatikan.' : 'Suara video diaktifkan.', 'info'); } function updateVideoSoundUI() { const appData = storage.getAppData(); const btn = document.getElementById('toggleVideoSoundBtn'); const icon = btn.querySelector('i'); const text = btn.querySelector('span'); if (appData.isVideoMuted) { icon.classList.remove('fa-volume-up'); icon.classList.add('fa-volume-mute'); text.textContent = 'Aktifkan Suara Video'; } else { icon.classList.remove('fa-volume-mute'); icon.classList.add('fa-volume-up'); text.textContent = 'Matikan Suara Video'; } }

function exportFinancePDF() {
    if (!checkPremiumAccess()) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const appData = storage.getAppData();
    const transactions = appData[currentMode].transactions;

    doc.setFontSize(20);
    doc.text('Laporan Keuangan', 20, 20);
    doc.setFontSize(12);
    doc.text(`Mode: ${currentMode === 'personal' ? 'Pribadi' : 'Bisnis'}`, 20, 30);
    doc.text(`Tanggal: ${formatDate(new Date().toISOString())}`, 20, 40);

    const tableData = transactions.map(t => [
        formatDate(t.date),
        t.description,
        getCategoryName(t.category),
        t.type === 'income' ? formatCurrency(t.amount) : '',
        t.type === 'expense' ? formatCurrency(t.amount) : ''
    ]);

    doc.autoTable({
        head: [['Tanggal', 'Deskripsi', 'Kategori', 'Pemasukan', 'Pengeluaran']],
        body: tableData,
        startY: 50
    });

    const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    const balance = totalIncome - totalExpense;
    let finalY = doc.autoTable.previous.finalY + 10;

    doc.setFontSize(12);
    doc.text('Total Pemasukan:', 20, finalY);
    doc.text(formatCurrency(totalIncome), 190, finalY, { align: 'right' });
    finalY += 7;
    doc.text('Total Pengeluaran:', 20, finalY);
    doc.text(formatCurrency(totalExpense), 190, finalY, { align: 'right' });
    finalY += 7;
    doc.setFont('helvetica', 'bold');
    doc.text('Saldo Akhir:', 20, finalY);
    doc.text(formatCurrency(balance), 190, finalY, { align: 'right' });

    doc.save(`laporan-keuangan-${currentMode}.pdf`);
}

function exportSplitBillPDF(results, totalBill, date) { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(16); doc.text('Laporan Split Bill', 20, 20); doc.setFontSize(12); doc.text(`Total Tagihan: ${formatCurrency(totalBill)}`, 20, 30); doc.text(`Tanggal: ${formatDate(date)}`, 20, 38); const tableData = results.map(r => [r.name, formatCurrency(r.amount)]); doc.autoTable({ head: [['Nama', 'Jumlah Bayar']], body: tableData, startY: 45 }); doc.save('split-bill.pdf'); }

function getChartColors() {
    const isLight = document.body.classList.contains('light-mode');
    const isBlack = document.body.classList.contains('black-mode');

    if (isBlack) {
        return {
            gridColor: 'rgba(255, 255, 255, 0.15)',
            tickColor: '#e5e7eb',
            legendColor: '#e5e7eb',
            incomeColor: '#00f0ff',
            expenseColor: '#ff00ff',
            taskColor: '#00ff7f',
            incomeBg: 'rgba(0, 240, 255, 0.2)',
            expenseBg: 'rgba(255, 0, 255, 0.2)',
            taskBg: 'rgba(0, 255, 127, 0.7)',
        };
    }

    if (isLight) {
        return { 
            gridColor: 'rgba(0, 0, 0, 0.1)', 
            tickColor: '#4b5563', 
            legendColor: '#1f2937', 
            incomeColor: '#22c55e', 
            expenseColor: '#ec4899', 
            taskColor: '#3b82f6', 
            incomeBg: 'rgba(34, 197, 94, 0.2)', 
            expenseBg: 'rgba(236, 72, 153, 0.2)', 
            taskBg: 'rgba(59, 130, 246, 0.7)', 
        };
    }

    return { 
        gridColor: 'rgba(255, 255, 255, 0.1)', 
        tickColor: '#d1d5db', 
        legendColor: '#d1d5db', 
        incomeColor: '#4ade80', 
        expenseColor: '#f472b6', 
        taskColor: '#60a5fa', 
        incomeBg: 'rgba(74, 222, 128, 0.2)', 
        expenseBg: 'rgba(244, 114, 182, 0.2)', 
        taskBg: 'rgba(96, 165, 250, 0.7)', 
    };
}

function updateDashboardCharts() { updateCashFlowChart(); updateProductivityChart(); } function updateCashFlowChart() { const ctx = document.getElementById('cashFlowChart')?.getContext('2d'); if (!ctx) return; if (window.cashFlowChartInstance) window.cashFlowChartInstance.destroy(); const colors = getChartColors(); const appData = storage.getAppData(); const transactions = filterDataByRange(appData[currentMode].transactions, masterDateRange, 'date'); const { labels, dataPoints } = getTimeBuckets(masterDateRange, transactions, 'date'); const incomeData = new Array(labels.length).fill(0); const expenseData = new Array(labels.length).fill(0); transactions.forEach(t => { const itemDate = new Date(t.date + 'T00:00:00Z'); let bucketIndex = -1; for (let i = dataPoints.length - 1; i >= 0; i--) { if (itemDate >= dataPoints[i]) { bucketIndex = i; break; } } if (bucketIndex !== -1) { if (t.type === 'income') incomeData[bucketIndex] += t.amount; else expenseData[bucketIndex] += t.amount; } }); window.cashFlowChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [ { label: 'Pemasukan', data: incomeData, borderColor: colors.incomeColor, backgroundColor: colors.incomeBg, tension: 0.3, fill: true }, { label: 'Pengeluaran', data: expenseData, borderColor: colors.expenseColor, backgroundColor: colors.expenseBg, tension: 0.3, fill: true } ] }, options: { responsive: true, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } }, x: { grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } } }, plugins: { legend: { labels: { color: colors.legendColor } } } } }); } function updateProductivityChart() { const ctx = document.getElementById('productivityChart')?.getContext('2d'); if (!ctx) return; if (window.productivityChartInstance) window.productivityChartInstance.destroy(); const colors = getChartColors(); const appData = storage.getAppData(); const tasks = filterDataByRange(appData[currentMode].tasks, masterDateRange, 'datetime'); const { labels, dataPoints } = getTimeBuckets(masterDateRange, tasks, 'datetime'); const completedCounts = new Array(labels.length).fill(0); tasks.filter(t => t.completed && t.datetime).forEach(t => { const itemDate = new Date(t.datetime); let bucketIndex = -1; for (let i = dataPoints.length - 1; i >= 0; i--) { if (itemDate >= dataPoints[i]) { bucketIndex = i; break; } } if (bucketIndex !== -1) completedCounts[bucketIndex]++; }); window.productivityChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Tugas Selesai', data: completedCounts, backgroundColor: colors.taskBg, borderColor: colors.taskColor, borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.tickColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.tickColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { labels: { color: colors.legendColor } } } } }); }
function loadAnalysisCharts() { const appData = storage.getAppData(); const modeData = appData[currentMode]; const colors = getChartColors(); const diaryNotes = JSON.parse(localStorage.getItem('notes_v5.9.0') || '[]'); Chart.defaults.color = colors.legendColor; Chart.defaults.font.family = "'Poppins', 'sans-serif'"; const chartIds = ['combinedAnalysisChart', 'incomeVsExpenseChart', 'spendingByCategoryChart', 'taskCompletionTrendChart', 'taskPriorityDistributionChart', 'splitBillByUserChart', 'splitBillFrequencyChart', 'diaryEntryFrequencyChart', 'noteMoodAnalysisChart']; chartIds.forEach(id => { if (window[id + 'Instance']) window[id + 'Instance'].destroy(); }); const filteredPersonalTransactions = filterDataByRange(appData.personal.transactions, masterDateRange, 'date'); const filteredPersonalTasks = filterDataByRange(appData.personal.tasks, masterDateRange, 'datetime'); const filteredPersonalSplits = filterDataByRange(appData.personal.splitBills, masterDateRange, 'date'); const filteredBusinessTransactions = filterDataByRange(appData.business.transactions, masterDateRange, 'date'); const filteredBusinessTasks = filterDataByRange(appData.business.tasks, masterDateRange, 'datetime'); const filteredBusinessSplits = filterDataByRange(appData.business.splitBills, masterDateRange, 'date'); const filteredDiary = filterDataByRange(diaryNotes, masterDateRange, 'date'); const personalData = { finance: filteredPersonalTransactions.length, tasks: filteredPersonalTasks.length, splitBill: filteredPersonalSplits.length, diary: filteredDiary.length, }; const businessData = { finance: filteredBusinessTransactions.length, tasks: filteredBusinessTasks.length, splitBill: filteredBusinessSplits.length, diary: 0, }; const combinedCtx = document.getElementById('combinedAnalysisChart').getContext('2d'); window.combinedAnalysisChartInstance = new Chart(combinedCtx, { type: 'radar', data: { labels: ['Keuangan', 'Tugas', 'Split Bill', 'Catatan'], datasets: [ { label: 'Pribadi', data: [personalData.finance, personalData.tasks, personalData.splitBill, personalData.diary], backgroundColor: 'rgba(0, 136, 255, 0.2)', borderColor: '#0088ff', borderWidth: 2, pointBackgroundColor: '#0088ff', pointRadius: 4, }, { label: 'Bisnis', data: [businessData.finance, businessData.tasks, businessData.splitBill, businessData.diary], backgroundColor: 'rgba(255, 0, 110, 0.2)', borderColor: '#ff006e', borderWidth: 2, pointBackgroundColor: '#ff006e', pointRadius: 4, } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { size: 14 } } } }, scales: { r: { angleLines: { color: colors.gridColor }, grid: { color: colors.gridColor }, pointLabels: { font: { size: 14, weight: '600' }, color: colors.tickColor }, ticks: { backdropColor: 'rgba(0,0,0,0.5)', color: colors.tickColor, stepSize: 5 }, suggestedMin: 0 } } } }); const filteredFinance = filterDataByRange(modeData.transactions, masterDateRange, 'date'); const financialData = processTimeSeriesData(filteredFinance, 'date', masterDateRange); const incomeVsExpenseCtx = document.getElementById('incomeVsExpenseChart').getContext('2d'); window.incomeVsExpenseChartInstance = new Chart(incomeVsExpenseCtx, { type: 'bar', data: { labels: financialData.labels, datasets: [ { label: 'Pemasukan', data: financialData.income, backgroundColor: colors.incomeColor }, { label: 'Pengeluaran', data: financialData.expense, backgroundColor: colors.expenseColor } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: colors.gridColor } } } } }); const spendingCtx = document.getElementById('spendingByCategoryChart').getContext('2d'); const { labels: categoryLabels, data: spendingData } = processSpendingByCategory(filteredFinance); window.spendingByCategoryChartInstance = new Chart(spendingCtx, { type: 'doughnut', data: { labels: categoryLabels, datasets: [{ data: spendingData, backgroundColor: ['#f472b6', '#60a5fa', '#fbbf24', '#4ade80', '#c084fc', '#a1a1aa', '#f87171', '#818cf8'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime'); const taskData = processTimeSeriesData(filteredTasks, 'datetime', masterDateRange); const taskTrendCtx = document.getElementById('taskCompletionTrendChart').getContext('2d'); window.taskCompletionTrendChartInstance = new Chart(taskTrendCtx, { type: 'line', data: { labels: taskData.labels, datasets: [ { label: 'Dibuat', data: taskData.created, borderColor: '#60a5fa', tension: 0.3 }, { label: 'Selesai', data: taskData.completed, borderColor: '#4ade80', tension: 0.3 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } } }); const taskPriorityCtx = document.getElementById('taskPriorityDistributionChart').getContext('2d'); const { labels: priorityLabels, data: priorityData } = processTaskPriorities(filteredTasks); window.taskPriorityDistributionChartInstance = new Chart(taskPriorityCtx, { type: 'pie', data: { labels: priorityLabels, datasets: [{ data: priorityData, backgroundColor: ['#f472b6', '#fbbf24', '#4ade80'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date'); const splitByUserCtx = document.getElementById('splitBillByUserChart').getContext('2d'); const { labels: userLabels, data: userSpendingData } = processSplitBillByUser(filteredSplits); window.splitBillByUserChartInstance = new Chart(splitByUserCtx, { type: 'bar', data: { labels: userLabels, datasets: [{ label: 'Total Pengeluaran', data: userSpendingData, backgroundColor: colors.incomeColor, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { grid: { color: colors.gridColor } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } } }); const splitFreqData = processTimeSeriesData(filteredSplits, 'date', masterDateRange); const splitFreqCtx = document.getElementById('splitBillFrequencyChart').getContext('2d'); window.splitBillFrequencyChartInstance = new Chart(splitFreqCtx, { type: 'line', data: { labels: splitFreqData.labels, datasets: [{ label: 'Jumlah Split Bill', data: splitFreqData.count, borderColor: '#22d3ee', tension: 0.3, fill: true, backgroundColor: 'rgba(34, 211, 238, 0.2)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } } }); const diaryCtx = document.getElementById('diaryEntryFrequencyChart').getContext('2d'); const diaryData = processTimeSeriesData(filteredDiary, 'date', masterDateRange); window.diaryEntryFrequencyChartInstance = new Chart(diaryCtx, { type: 'bar', data: { labels: diaryData.labels, datasets: [{ label: 'Jumlah Entri', data: diaryData.count, backgroundColor: colors.taskBg, borderColor: colors.taskColor, borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } } }); const moodCtx = document.getElementById('noteMoodAnalysisChart').getContext('2d'); const moodData = processNoteMoods(filteredDiary); window.noteMoodAnalysisChartInstance = new Chart(moodCtx, { type: 'doughnut', data: { labels: moodData.labels, datasets: [{ data: moodData.data, backgroundColor: moodData.backgroundColors, borderColor: colors.gridColor, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 10 } } } } }); }
function processTimeSeriesData(data, dateKey, range) { const { labels, dataPoints } = getTimeBuckets(range, data, dateKey); const isFinance = data.length > 0 && 'type' in data[0] && 'amount' in data[0]; const isTask = data.length > 0 && 'completed' in data[0]; let results = {}; if (isFinance) { results.income = new Array(labels.length).fill(0); results.expense = new Array(labels.length).fill(0); } else if (isTask) { results.created = new Array(labels.length).fill(0); results.completed = new Array(labels.length).fill(0); } else { results.count = new Array(labels.length).fill(0); } data.forEach(item => { if (!item[dateKey]) return; const itemDate = new Date(item[dateKey]); let bucketIndex = -1; for (let i = dataPoints.length - 1; i >= 0; i--) { if (itemDate >= dataPoints[i]) { bucketIndex = i; break; } } if (bucketIndex !== -1) { if (isFinance) { if (item.type === 'income') results.income[bucketIndex] += item.amount; else results.expense[bucketIndex] += item.amount; } else if (isTask) { results.created[bucketIndex]++; if (item.completed) results.completed[bucketIndex]++; } else { results.count[bucketIndex]++; } } }); return { labels, ...results }; } function processSpendingByCategory(transactions) { const spending = {}; transactions.filter(t => t.type === 'expense').forEach(t => { const categoryName = getCategoryName(t.category); spending[categoryName] = (spending[categoryName] || 0) + t.amount; }); const sortedSpending = Object.entries(spending).sort(([,a],[,b]) => b-a); return { labels: sortedSpending.map(([label]) => label), data: sortedSpending.map(([,data]) => data) }; } function processTaskPriorities(tasks) { const priorities = { high: 0, medium: 0, low: 0 }; tasks.filter(t => !t.completed).forEach(t => { priorities[t.priority]++; }); return { labels: ['Tinggi', 'Sedang', 'Rendah'], data: [priorities.high, priorities.medium, priorities.low] }; } function processSplitBillByUser(splitBills) { const userTotals = {}; splitBills.forEach(bill => { bill.results.forEach(person => { userTotals[person.name] = (userTotals[person.name] || 0) + person.amount; }); }); const sortedUsers = Object.entries(userTotals).sort(([,a],[,b]) => b-a); return { labels: sortedUsers.map(([label]) => label), data: sortedUsers.map(([,data]) => data) }; }

function processNoteMoods(notes) {
    const moodCounts = {};
    const moodColors = {
        happy: '#4ade80',
        sad: '#60a5fa',
        excited: '#facc15',
        angry: '#f472b6',
        neutral: '#9ca3af'
    };
    const moodLabels = {
        happy: 'Senang',
        sad: 'Sedih',
        excited: 'Bersemangat',
        angry: 'Marah',
        neutral: 'Netral'
    };

    notes.forEach(note => {
        if (note.mood) {
            moodCounts[note.mood] = (moodCounts[note.mood] || 0) + 1;
        }
    });

    const labels = Object.keys(moodCounts).map(mood => moodLabels[mood] || mood);
    const data = Object.values(moodCounts);
    const backgroundColors = Object.keys(moodCounts).map(mood => moodColors[mood] || '#a1a1aa');

    return { labels, data, backgroundColors };
}
function getGroupingUnit(range) { if (typeof range === 'object' && range.type === 'custom') { const diffTime = Math.abs(new Date(range.end) - new Date(range.start)); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays > 90) return 'month'; if (diffDays > 30) return 'week'; return 'day'; } if (['7d', '1m'].includes(range)) return 'day'; if (range === '3m') return 'week'; if (['1y', 'all'].includes(range)) return 'month'; return 'day'; } function getTimeBuckets(range, data, dateKey) { const labels = []; const dataPoints = []; const now = new Date(); const unit = getGroupingUnit(range); let startDate, endDate = new Date(now); if (typeof range === 'object' && range.type === 'custom') { startDate = new Date(range.start + 'T00:00:00Z'); endDate = new Date(range.end + 'T23:59:59Z'); } else if (range === 'all') { const validData = data.filter(d => d[dateKey]); if (validData.length === 0) { startDate = new Date(); startDate.setMonth(startDate.getMonth() - 1); } else { startDate = new Date(validData.reduce((min, p) => (p[dateKey] < min) ? p[dateKey] : min, validData[0][dateKey])); } } else { startDate = new Date(now); if (range === '7d') startDate.setDate(now.getDate() - 6); else if (range === '1m') startDate.setDate(now.getDate() - 29); else if (range === '3m') startDate.setMonth(now.getMonth() - 3); else if (range === '1y') startDate.setFullYear(now.getFullYear() - 1); } startDate.setHours(0, 0, 0, 0); let current = new Date(startDate); while (current <= endDate) { dataPoints.push(new Date(current)); if (unit === 'day') { labels.push(current.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })); current.setDate(current.getDate() + 1); } else if (unit === 'week') { labels.push(`W${getWeekNumber(current)}`); current.setDate(current.getDate() + 7); } else { labels.push(current.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' })); current.setMonth(current.getMonth() + 1); } } return { labels, dataPoints }; } function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7); return weekNo; }
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); } function formatCurrency(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); } 
function formatDate(dateString) { return dateString ? new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''; } 
function formatDateTime(dateString) { return dateString ? new Date(dateString).toLocaleString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''; } 

function getTransactionIcon(category) {
    const icons = {
        food: 'fa-utensils', transport: 'fa-car', entertainment: 'fa-gamepad', shopping: 'fa-shopping-bag', bills: 'fa-file-invoice', salary: 'fa-money-bill-wave', business: 'fa-briefcase', investment: 'fa-chart-line', health: 'fa-heart-pulse', education: 'fa-graduation-cap', subscription: 'fa-rss', household: 'fa-house-chimney', personal_care: 'fa-spa', gift: 'fa-gift', other: 'fa-shapes'
    };
    return icons[category] || 'fa-shapes';
}

function getCategoryName(category = null) { const names = { food: 'Makanan & Minuman', transport: 'Transportasi', entertainment: 'Hiburan', shopping: 'Belanja', bills: 'Tagihan & Utilitas', salary: 'Gaji', business: 'Bisnis', investment: 'Investasi', health: 'Kesehatan', education: 'Pendidikan', subscription: 'Langganan', household: 'Rumah Tangga', personal_care: 'Perawatan Diri', gift: 'Hadiah & Donasi', other: 'Lainnya' }; return category ? names[category] : names; }
function showModal(content) { const modal = document.getElementById('mainModal'); modal.querySelector('.modal-content').innerHTML = content; modal.classList.add('show'); modal.querySelectorAll('.closeModal').forEach(btn => btn.addEventListener('click', closeModal)); } function closeModal() { document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show')); } function showConfirm(title, message, onConfirm) { const modal = document.getElementById('confirmModal'); document.getElementById('confirmTitle').textContent = title; document.getElementById('confirmMessage').textContent = message; modal.classList.add('show'); const yesBtn = document.getElementById('confirmYes'); const noBtn = document.getElementById('confirmNo'); const yesHandler = () => { onConfirm(); closeModal(); cleanup(); }; const noHandler = () => { closeModal(); cleanup(); }; const cleanup = () => { yesBtn.removeEventListener('click', yesHandler); noBtn.removeEventListener('click', noHandler); }; yesBtn.addEventListener('click', yesHandler); noBtn.addEventListener('click', noHandler); } function showMessage(message, type = 'info') { const isLight = document.body.classList.contains('light-mode'); const colors = { info: '#60a5fa', success: '#4ade80', error: '#f472b6' }; const msgDiv = document.createElement('div'); Object.assign(msgDiv.style, { position: 'fixed', bottom: '20px', right: '20px', padding: '15px', backgroundColor: isLight ? '#ffffff' : 'rgba(15, 10, 32, 0.8)', backdropFilter: 'blur(10px)', color: colors[type], border: `1px solid ${colors[type]}`, borderRadius: '8px', boxShadow: `0 4px 15px rgba(0,0,0,0.1)`, zIndex: '9999', transition: 'opacity 0.5s' }); msgDiv.textContent = message; document.body.appendChild(msgDiv); setTimeout(() => { msgDiv.style.opacity = '0'; setTimeout(() => msgDiv.remove(), 500); }, 3000); } 

function showDateRangeModal(source = 'dashboard') { 
    dateRangeSource = source;
    document.getElementById('dateRangeModal').classList.add('show'); 
} 

function applyDateRange() { const startDate = document.getElementById('startDate').value; const endDate = document.getElementById('endDate').value; if (!startDate || !endDate) { showMessage('Harap pilih tanggal mulai dan selesai.', 'error'); return; } if (new Date(startDate) > new Date(endDate)) { showMessage('Tanggal mulai tidak boleh setelah tanggal selesai.', 'error'); return; } const rangeObject = { type: 'custom', start: startDate, end: endDate }; if (dateRangeSource === 'dashboard') { masterDateRange = rangeObject; updateActiveButton('master-range-selector', 'custom'); refreshDashboardData(); } else if (dateRangeSource === 'finance') { financeDateRange = rangeObject; filterAndRenderTransactions(); } document.getElementById('dateRangeModal').classList.remove('show'); } 

function setupMasterRangeSelector() { document.querySelectorAll('#master-range-selector .range-btn').forEach(btn => { btn.addEventListener('click', (e) => { const range = e.currentTarget.dataset.range; if (range === 'custom') { showDateRangeModal('dashboard'); } else { updateActiveButton('master-range-selector', range); masterDateRange = range; refreshDashboardData(); } }); }); } function updateActiveButton(selectorId, activeRange) { document.querySelectorAll(`#${selectorId} .range-btn`).forEach(b => b.classList.remove('active')); document.querySelector(`#${selectorId} .range-btn[data-range="${activeRange}"]`).classList.add('active'); } function filterDataByRange(data, range, dateKey) { if (range === 'all') return data.filter(item => item[dateKey] || item.lastModified); let startDate, endDate = new Date(); if (typeof range === 'object' && range.type === 'custom') { startDate = new Date(range.start + 'T00:00:00Z'); endDate = new Date(range.end + 'T23:59:59Z'); } else { startDate = new Date(); if (range === '7d') startDate.setDate(endDate.getDate() - 6); else if (range === '1m') startDate.setDate(endDate.getDate() - 29); else if (range === '3m') startDate.setMonth(endDate.getMonth() - 3); else if (range === '1y') startDate.setFullYear(endDate.getFullYear() - 1); startDate.setHours(0, 0, 0, 0); } return data.filter(item => { const itemDateStr = item[dateKey] || item.lastModified; if (!itemDateStr) return false; const itemDate = new Date(itemDateStr); return itemDate >= startDate && itemDate <= endDate; }); }
function saveToken(tokenResponse) { const expiresAt = Date.now() + (tokenResponse.expires_in * 1000); const tokenData = { access_token: tokenResponse.access_token, expires_at: expiresAt }; localStorage.setItem('googleAuthToken', JSON.stringify(tokenData)); } function loadToken() { const tokenStr = localStorage.getItem('googleAuthToken'); if (!tokenStr) return null; try { return JSON.parse(tokenStr); } catch (e) { return null; } } function clearToken() { localStorage.removeItem('googleAuthToken'); localStorage.removeItem('googleAuthLoggedIn'); } function initGisClient() { try { if (typeof google === 'undefined' || typeof google.accounts === 'undefined') { console.error("Google Identity Services script not loaded yet."); showMessage("Gagal memuat API Google. Coba refresh halaman.", "error"); return; } googleTokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_SCOPES, callback: (tokenResponse) => { if (tokenResponse && tokenResponse.access_token) { googleAccessToken = tokenResponse.access_token; saveToken(tokenResponse); localStorage.setItem('googleAuthLoggedIn', 'true'); updateSigninStatus(true); } else { console.error("Gagal mendapatkan access token:", tokenResponse); showMessage("Gagal melakukan otentikasi.", "error"); clearToken(); } }, }); const savedToken = loadToken(); if (savedToken) { if (Date.now() < savedToken.expires_at) { googleAccessToken = savedToken.access_token; updateSigninStatus(true); verifyToken(googleAccessToken).then(valid => { if (!valid) { console.warn("Token invalid, refreshing..."); googleTokenClient.requestAccessToken({ prompt: '' }); } }); } else { console.log("Token expired, requesting new one..."); googleTokenClient.requestAccessToken({ prompt: '' }); } } else if (localStorage.getItem('googleAuthLoggedIn') === 'true') { googleTokenClient.requestAccessToken({ prompt: '' }); } } catch (error) { console.error("Google Identity Services client gagal dimuat.", error); showMessage("Gagal memuat API Google. Coba refresh halaman.", "error"); } } function handleAuthClick() { if (googleAccessToken) { google.accounts.oauth2.revoke(googleAccessToken, () => { googleAccessToken = null; clearToken(); updateSigninStatus(false); showMessage("Berhasil keluar dari akun Google.", "success"); }); } else { if (googleTokenClient) { googleTokenClient.requestAccessToken({ prompt: 'consent' }); } else { showMessage("Client otentikasi belum siap.", "error"); } } } async function verifyToken(token) { try { const res = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${token}`); return res.ok; } catch (e) { console.error("Verifikasi token gagal:", e); return false; } }

// ===================================================================================
// =================== BAGIAN 3: FUNGSI GOOGLE DRIVE (BACKUP, RESTORE, & UPLOAD) ==============
// ===================================================================================

function dataURLtoBlob(dataUrl) {
    const arr = dataUrl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}

function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function handleSmartUpload(event) {
    if (!checkPremiumAccess(event)) return;
    const files = event.target.files;
    if (!files || files.length === 0) return;
    if (!googleAccessToken) {
        showMessage("Otentikasi diperlukan untuk mengunggah file.", "error");
        return;
    }

    showMessage(`Memulai upload ${files.length} file...`, "info");

    try {
        const rootFolderId = await findOrCreateFolder(DRIVE_UPLOAD_FOLDER_NAME, 'root');
        if (!rootFolderId) {
            throw new Error(`Gagal membuat folder utama '${DRIVE_UPLOAD_FOLDER_NAME}'.`);
        }

        for (const file of files) {
            const subfolderName = getUploadSubfolder(file);
            const subfolderId = await findOrCreateFolder(subfolderName, rootFolderId);
            if (!subfolderId) {
                showMessage(`Gagal membuat subfolder '${subfolderName}' untuk file '${file.name}'. Melanjutkan...`, "error");
                continue;
            }
            uploadSingleFileWithProgress(file, subfolderId);
        }

    } catch (error) {
        console.error("Error pada proses smart upload:", error);
        showMessage(`Terjadi kesalahan: ${error.message}`, "error");
    } finally {
        event.target.value = '';
    }
}

function getUploadSubfolder(file) {
    const type = file.type;
    const name = file.name.toLowerCase();

    if (type.startsWith('image/')) return 'Gambar';
    if (type.startsWith('video/')) return 'Video';
    if (type.startsWith('audio/')) return 'Audio';
    if (type.startsWith('application/pdf') || type.includes('document') || name.endsWith('.doc') || name.endsWith('.docx') || name.endsWith('.txt')) return 'Dokumen';
    if (type.includes('spreadsheet') || type.includes('excel') || name.endsWith('.xls') || name.endsWith('.xlsx') || name.endsWith('.csv')) return 'Spreadsheet';
    if (type.includes('presentation') || type.includes('powerpoint') || name.endsWith('.ppt') || name.endsWith('.pptx')) return 'Presentasi';
    
    return 'Lainnya';
}

function uploadSingleFileWithProgress(file, parentId) {
    const uploadId = `upload-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    addUploadProgressUI(uploadId, file.name);

    const metadata = {
        name: file.name,
        parents: [parentId]
    };

    const uploader = new MediaUploader({
        file: file,
        token: googleAccessToken,
        metadata: metadata,
        onProgress: (progress) => {
            const percentage = progress.total > 0 ? Math.round((progress.loaded / progress.total) * 100) : 0;
            const statusText = `${formatSize(progress.loaded)} / ${formatSize(progress.total)} (${formatSize(progress.speed || 0)}/s)`;
            updateUploadProgressUI(uploadId, percentage, statusText);
        },
        onComplete: () => {
            updateUploadProgressUI(uploadId, 100, 'Selesai!');
            removeUploadProgressUI(uploadId, true);
        },
        onError: (error) => {
            console.error('Upload error:', error);
            updateUploadProgressUI(uploadId, 100, 'Gagal!');
            removeUploadProgressUI(uploadId, false);
        }
    });
    uploader.upload();
}

function addUploadProgressUI(id, fileName) {
    const container = document.getElementById('upload-progress-container');
    const item = document.createElement('div');
    item.id = id;
    item.className = 'upload-progress-item';
    item.innerHTML = `
        <div class="flex items-center justify-between gap-2">
            <div class="flex-1 overflow-hidden">
                <p class="text-sm font-medium truncate">${fileName}</p>
                <div class="text-xs text-gray-400 upload-status">Mempersiapkan...</div>
            </div>
            <span class="upload-percentage font-mono text-sm">0%</span>
        </div>
        <div class="upload-progress-bar-bg mt-2">
            <div class="upload-progress-bar-fg w-0"></div>
        </div>
    `;
    container.prepend(item);
}

function updateUploadProgressUI(id, percentage, statusText) {
    const item = document.getElementById(id);
    if (!item) return;
    item.querySelector('.upload-progress-bar-fg').style.width = `${percentage}%`;
    item.querySelector('.upload-percentage').textContent = `${percentage}%`;
    item.querySelector('.upload-status').textContent = statusText;
}

function removeUploadProgressUI(id, success) {
    const item = document.getElementById(id);
    if (!item) return;
    const progressBar = item.querySelector('.upload-progress-bar-fg');
    progressBar.style.backgroundColor = success ? '#4ade80' : '#f472b6';
    setTimeout(() => {
        item.style.opacity = '0';
        setTimeout(() => item.remove(), 500);
    }, 4000);
}

async function handleBackupClick(e) {
    if (!checkPremiumAccess(e)) return;
    if (!googleAccessToken) {
        showMessage("Otentikasi diperlukan untuk backup.", "error");
        return;
    }

    showMessage("Memulai proses backup... Mengumpulkan data.", "info");
    const authStatus = document.getElementById('auth-status');
    authStatus.innerText = "Memulai proses backup...";

    try {
        const zip = new JSZip();
        
        // Menggunakan fungsi yang sudah ada untuk memproses data
        const lifeHubData = storage.getAppData();
        const notesData = storage.get('notes_v5.9.0', []);
        
        const { processedNotes, mediaFiles } = await processMediaForBackup(notesData);
        const { processedBgInfo, backgroundFile } = await processBackgroundForBackup();

        for (const [path, blob] of Object.entries(mediaFiles)) {
            zip.file(path, blob);
        }
        if (backgroundFile) {
            zip.file(backgroundFile.path, backgroundFile.blob);
        }

        const finalJsonData = {
            backupInfo: { version: "6.2.0", timestamp: new Date().toISOString() },
            lifeHub: lifeHubData,
            notes: processedNotes,
            htmlNotes: storage.get('lifeHub_htmlNotes_v6.2.0', []),
            background: processedBgInfo
        };
        zip.file("data.json", JSON.stringify(finalJsonData, null, 2));

        authStatus.innerText = "Membuat file ZIP...";
        const zipBlob = await zip.generateAsync({ type: "blob", compression: "DEFLATE" });
        const fileName = `Uranuspace_Backup_${new Date().toISOString().replace(/:/g, '-')}.zip`;
        
        authStatus.innerText = `Mengunggah ${fileName}...`;
        const folderId = await findOrCreateFolder(DRIVE_BACKUP_FOLDER_NAME, 'root');
        await createFileInFolder(folderId, fileName, 'application/zip', zipBlob);

        authStatus.innerText = `Backup berhasil! File: ${fileName}`;
        showMessage("Backup ZIP ke Google Drive berhasil!", "success");
        listFiles();

    } catch (error) {
        console.error("Error saat proses backup ZIP:", error);
        authStatus.innerText = "Backup gagal. Lihat konsol untuk detail.";
        showMessage(`Backup gagal: ${error.message}`, "error");
    }
}


async function restoreFromZip(fileId) {
    showMessage("Memulai restore... Mengunduh file ZIP.", "info");
    const authStatus = document.getElementById('auth-status');
    authStatus.innerText = "Mengunduh file ZIP...";

    try {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken })
        });
        if (!response.ok) throw new Error("Gagal mengunduh file ZIP.");
        const zipBlob = await response.blob();
        
        const zip = await JSZip.loadAsync(zipBlob);
        authStatus.innerText = "Membaca data.json...";

        const jsonDataFile = zip.file("data.json");
        if (!jsonDataFile) throw new Error("File data.json tidak ditemukan di dalam ZIP.");
        const jsonContent = await jsonDataFile.async("string");
        const restoredData = JSON.parse(jsonContent);

        showConfirm('Timpa Data Lokal?', 'Data dari backup ZIP akan menimpa data lokal Anda. Operasi ini tidak dapat diurungkan. Lanjutkan?', async () => {
            try {
                showMessage("Memulihkan data... Proses ini mungkin memakan waktu.", "info");
                authStatus.innerText = "Memulihkan data...";
                await clearAllDataConfirmed(false);

                if (restoredData.background && restoredData.background.path) {
                    authStatus.innerText = "Memulihkan background...";
                    const bgFile = zip.file(restoredData.background.path);
                    if (bgFile) {
                        const bgBlob = await bgFile.async("blob");
                        await saveFileToDB('customBackground', bgBlob);
                        localStorage.setItem('customBackgroundType', restoredData.background.type);
                    }
                }

                let finalNotes = [];
                if (restoredData.notes) {
                    authStatus.innerText = "Memulihkan catatan dan media...";
                    for (const note of restoredData.notes) {
                        let newContent = note.content;
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = note.content;

                        // Restore media inline
                        const mediaElements = tempDiv.querySelectorAll('img[src^="media_catatan/"], video[src^="media_catatan/"]');
                        for(const el of mediaElements) {
                            const filePath = el.getAttribute('src'); // Dapatkan path dari src
                            const mediaFile = zip.file(filePath);
                            if (mediaFile) {
                                const mediaBlob = await mediaFile.async("blob");
                                const dataUrl = await blobToDataURL(mediaBlob);
                                el.src = dataUrl;
                            }
                        }
                        
                        // Restore attachment ZIP
                        if (note.attachments && note.attachments.length > 0) {
                            for(const attachment of note.attachments) {
                                 const zipFilename = `media_catatan/${attachment.id}_${attachment.name}`;
                                 const zipFile = zip.file(zipFilename);
                                 if (zipFile) {
                                     const zipBlob = await zipFile.async("blob");
                                     attachment.dataUrl = await blobToDataURL(zipBlob);
                                 }
                            }
                        }
                        finalNotes.push({ ...note, content: tempDiv.innerHTML });
                    }
                }

                if (restoredData.lifeHub) {
                    storage.saveAppData(restoredData.lifeHub);
                }
                storage.set('notes_v5.9.0', finalNotes);
                if (restoredData.htmlNotes) {
                    storage.set('lifeHub_htmlNotes_v6.2.0', restoredData.htmlNotes);
                }

                authStatus.innerText = "Restore berhasil! Muat ulang...";
                showMessage("Restore berhasil! Memuat ulang aplikasi...", "success");
                setTimeout(() => window.location.reload(), 1500);

            } catch (restoreError) {
                console.error("Error selama proses apply restore:", restoreError);
                authStatus.innerText = "Gagal menerapkan data restore.";
                showMessage(`Gagal menerapkan data restore: ${restoreError.message}`, "error");
            }
        });

    } catch (error) {
        console.error("Error saat restore dari ZIP:", error);
        authStatus.innerText = "Restore gagal.";
        showMessage(`Restore dari ZIP gagal: ${error.message}`, "error");
    }
}
async function findFolderId(folderName, parentId = 'root') { const query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and '${parentId}' in parents and trashed=false`; const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id, name)`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error("Gagal mencari folder."); const data = await response.json(); return data.files.length > 0 ? data.files[0].id : null; } 
async function findOrCreateFolder(folderName, parentId = 'root') { let folderId = await findFolderId(folderName, parentId); if (folderId) return folderId; const fileMetadata = { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder', 'parents': [parentId] }; const response = await fetch('https://www.googleapis.com/drive/v3/files', { method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken, 'Content-Type': 'application/json' }), body: JSON.stringify(fileMetadata) }); if (!response.ok) throw new Error("Gagal membuat folder."); const folder = await response.json(); return folder.id; } 
async function createFileInFolder(folderId, fileName, mimeType, content) { const metadata = { 'name': fileName, 'mimeType': mimeType, 'parents': [folderId] }; const form = new FormData(); form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' })); form.append('file', new Blob([content], { type: mimeType })); const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name', { method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }), body: form }); if (!response.ok) throw new Error("Gagal mengunggah file."); return await response.json(); } 
async function findLatestBackupFile(folderId) { const query = `'${folderId}' in parents and (mimeType='application/zip' or mimeType='text/plain') and name contains 'Uranuspace_Backup_' and trashed=false`; const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime,mimeType)&orderBy=createdTime desc&pageSize=1`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error("Gagal mencari file backup."); const data = await response.json(); return data.files.length > 0 ? data.files[0] : null; } 
async function getFileContent(fileId) { const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error("Gagal mengunduh konten file."); return await response.text(); } 
async function listFiles() { if (!googleAccessToken) return; const fileListDiv = document.getElementById('file-list'); fileListDiv.innerHTML = '<p class="text-gray-400">Memuat daftar file...</p>'; try { const folderId = await findFolderId(DRIVE_BACKUP_FOLDER_NAME, 'root'); if (!folderId) { fileListDiv.innerHTML = '<p class="text-gray-500">Folder backup belum dibuat.</p>'; return; } const query = `'${folderId}' in parents and (mimeType='application/zip' or mimeType='text/plain') and name contains 'Uranuspace_Backup_' and trashed=false`; const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime,mimeType)&pageSize=5&orderBy=createdTime desc`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error(`Gagal memuat daftar file: ${response.statusText}`); const data = await response.json(); if (data.files && data.files.length > 0) { fileListDiv.innerHTML = "<strong class='block mb-1 text-purple-300'>Backup Terbaru:</strong>" + data.files.map(file => `<div class="p-1"><i class="fas ${file.mimeType === 'application/zip' ? 'fa-file-archive' : 'fa-file-alt'} mr-2 text-purple-400"></i><span>${file.name.substring(0, 35)}...</span><span class="block text-gray-500 text-xs">${new Date(file.createdTime).toLocaleString('id-ID')}</span></div>`).join(''); } else { fileListDiv.innerHTML = '<p class="text-gray-500">Belum ada file backup di Google Drive.</p>'; } } catch (error) { console.error('Error listing files:', error); fileListDiv.innerHTML = `<p class="text-red-500">Gagal memuat daftar file.</p>`; } }

async function listAllBackupFiles() {
    if (!googleAccessToken) return null;
    try {
        const folderId = await findFolderId(DRIVE_BACKUP_FOLDER_NAME, 'root');
        if (!folderId) return [];

        const query = `'${folderId}' in parents and (mimeType='application/zip' or mimeType='text/plain') and name contains 'Uranuspace_Backup_' and trashed=false`;
        const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime,mimeType)&orderBy=createdTime desc`, {
            headers: new Headers({ 'Authorization': `Bearer ${googleAccessToken}` })
        });

        if (!response.ok) throw new Error(`Gagal memuat daftar file: ${response.statusText}`);
        const data = await response.json();
        return data.files || [];
    } catch (error) {
        console.error('Error listing all files:', error);
        throw error;
    }
}

function showRestoreOptionsModal(e) {
    if (!checkPremiumAccess(e)) return;
    if (!googleAccessToken) {
        showMessage("Otentikasi diperlukan untuk restore.", "error");
        return;
    }

    const content = `
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-purple-300">Pilih Mode Restore</h3>
            <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
        </div>
        <p class="text-gray-400 mb-6">Pilih cara Anda ingin memulihkan data dari Google Drive.</p>
        <div class="space-y-4">
            <button id="autoRestoreBtn" class="custom-button w-full text-left !p-4 flex items-center">
                <i class="fas fa-magic mr-4 text-xl"></i>
                <div>
                    <strong class="block">Restore Otomatis (Cepat)</strong>
                    <span class="text-xs font-normal opacity-80">Pulihkan data dari file cadangan terbaru.</span>
                </div>
            </button>
            <button id="manualRestoreBtn" class="custom-button w-full text-left !p-4 flex items-center" style="background: linear-gradient(90deg, #10b981, #059669);">
                <i class="fas fa-list-ul mr-4 text-xl"></i>
                <div>
                    <strong class="block">Restore Manual (Kontrol Penuh)</strong>
                    <span class="text-xs font-normal opacity-80">Lihat semua file cadangan dan pilih satu untuk dipulihkan.</span>
                </div>
            </button>
        </div>
    `;
    showModal(content);

    document.getElementById('autoRestoreBtn').addEventListener('click', handleAutoRestore);
    document.getElementById('manualRestoreBtn').addEventListener('click', handleManualRestore);
}

async function handleAutoRestore() {
    closeModal();
    const authStatus = document.getElementById('auth-status');
    authStatus.innerText = "Memulai proses restore otomatis...";
    showMessage("Mencari file backup terbaru...", "info");

    try {
        const folderId = await findFolderId(DRIVE_BACKUP_FOLDER_NAME, 'root');
        if (!folderId) throw new Error(`Folder '${DRIVE_BACKUP_FOLDER_NAME}' tidak ditemukan.`);

        const latestFile = await findLatestBackupFile(folderId);
        if (!latestFile) throw new Error("Tidak ada file backup yang ditemukan.");

        authStatus.innerText = `File terbaru ditemukan: ${latestFile.name}`;
        showMessage(`Mengunduh ${latestFile.name}...`, "info");

        if (latestFile.mimeType === 'application/zip') {
            await restoreFromZip(latestFile.id);
        } else {
            const fileContent = await getFileContent(latestFile.id);
            const restoredData = JSON.parse(fileContent);
            confirmAndApplyRestore(restoredData);
        }

    } catch (error) {
        console.error("Error saat restore otomatis:", error);
        authStatus.innerText = "Restore otomatis gagal.";
        showMessage(`Restore otomatis gagal: ${error.message}`, "error");
    }
}

async function handleManualRestore() {
    closeModal();
    showMessage("Memuat daftar file dari Google Drive...", "info");

    try {
        const files = await listAllBackupFiles();
        if (!files || files.length === 0) {
            showMessage("Tidak ada file cadangan yang ditemukan di Google Drive.", "error");
            return;
        }

        const fileListHTML = files.map(file => `
            <div class="p-3 rounded-md flex justify-between items-center hover:bg-purple-500/10 cursor-pointer border-b border-purple-500/10" data-file-id="${file.id}" data-mime-type="${file.mimeType}">
                <div>
                    <strong class="block text-purple-300"><i class="fas ${file.mimeType === 'application/zip' ? 'fa-file-archive' : 'fa-file-alt'} mr-2"></i>${file.name}</strong>
                    <p class="text-xs text-gray-400">Dibuat: ${new Date(file.createdTime).toLocaleString('id-ID')}</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div>
        `).join('');

        const content = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-purple-300">Pilih File untuk Restore</h3>
                <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-sm text-gray-400 mb-4">Klik pada salah satu file di bawah ini untuk memulai proses pemulihan.</p>
            <div class="max-h-96 overflow-y-auto">${fileListHTML}</div>
        `;
        showModal(content);

        document.querySelectorAll('[data-file-id]').forEach(item => {
            item.addEventListener('click', async (e) => {
                const fileId = e.currentTarget.dataset.fileId;
                const mimeType = e.currentTarget.dataset.mimeType;
                closeModal();
                showMessage(`Mengunduh file yang dipilih...`, "info");
                try {
                    if (mimeType === 'application/zip') {
                        await restoreFromZip(fileId);
                    } else {
                        const fileContent = await getFileContent(fileId);
                        const restoredData = JSON.parse(fileContent);
                        confirmAndApplyRestore(restoredData);
                    }
                } catch (error) {
                    showMessage(`Gagal memulihkan dari file yang dipilih: ${error.message}`, "error");
                }
            });
        });

    } catch (error) {
        showMessage(`Gagal memuat daftar file: ${error.message}`, "error");
    }
}

function confirmAndApplyRestore(restoredData) {
    showConfirm('Timpa Data Lokal?', 'Data dari Google Drive akan menimpa data lokal Anda. Operasi ini tidak dapat diurungkan. Lanjutkan?', () => {
        if (restoredData.lifeHub) {
            storage.saveAppData(restoredData.lifeHub);
        }
        if (restoredData.notes) {
            localStorage.setItem('notes_v5.9.0', JSON.stringify(restoredData.notes));
        }
        if (restoredData.htmlNotes) {
            localStorage.setItem('lifeHub_htmlNotes_v6.2.0', JSON.stringify(restoredData.htmlNotes));
        }
        showMessage("Restore berhasil! Memuat ulang aplikasi...", "success");
        setTimeout(() => window.location.reload(), 1500);
    });
}

async function updateSigninStatus(isSignedIn) {
    const authButton = document.getElementById('auth-button');
    const backupButton = document.getElementById('backup-button');
    const restoreButton = document.getElementById('restore-button');
    const smartUploadButton = document.getElementById('smart-upload-button');
    const downloadViaLinkButton = document.getElementById('download-via-link-button');
    const manageFilesButton = document.getElementById('manage-drive-files-button');
    const authStatus = document.getElementById('auth-status');
    const fileListDiv = document.getElementById('file-list');
    const authButtonText = authButton.querySelector('span');
    const userProfileDiv = document.getElementById('user-profile');
    const userEmailEl = document.getElementById('user-email');
    const toggleEmailIcon = document.getElementById('toggle-email-visibility');

    if (isSignedIn && googleAccessToken) {
        authButtonText.innerText = 'Putuskan Hubungan Google';
        authButton.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
        
        backupButton.classList.remove('hidden');
        restoreButton.classList.remove('hidden');
        smartUploadButton.classList.remove('hidden');
        downloadViaLinkButton.classList.remove('hidden');
        manageFilesButton.classList.remove('hidden');

        authStatus.innerText = "Terhubung ke Google Drive";
        listFiles();

        try {
            const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken })
            });
            if (!response.ok) {
                throw new Error('Gagal mengambil info profil.');
            }
            const profile = await response.json();

            const dynamicSeed = Date.now() + Math.random();
            const avatarUrl = `https://api.dicebear.com/8.x/lorelei/svg?seed=${dynamicSeed}&backgroundColor=transparent&hairColor=6a0dad,0d94ea,c084fc&clothingColor=1e1b4b,3b0764&glassesProbability=50`;

            document.getElementById('user-picture').src = avatarUrl;
            document.getElementById('user-name').textContent = profile.name;
            userEmailEl.textContent = profile.email;
            
            userEmailEl.classList.add('email-blur');
            toggleEmailIcon.classList.remove('fa-eye-slash');
            toggleEmailIcon.classList.add('fa-eye');

            userProfileDiv.classList.remove('hidden');

        } catch (error) {
            console.error("Error fetching user profile:", error);
            showMessage("Gagal memuat profil pengguna.", "error");
            userProfileDiv.classList.add('hidden');
        }

    } else {
        authButtonText.innerText = 'Hubungkan ke Google';
        authButton.style.background = 'linear-gradient(90deg, #3b82f6, #2563eb)';
        
        backupButton.classList.add('hidden');
        restoreButton.classList.add('hidden');
        smartUploadButton.classList.add('hidden');
        downloadViaLinkButton.classList.add('hidden');
        manageFilesButton.classList.add('hidden');

        authStatus.innerText = "Belum terhubung.";
        fileListDiv.innerHTML = '';
        userProfileDiv.classList.add('hidden');
    }
}

function toggleEmailVisibility() {
    const userEmailEl = document.getElementById('user-email');
    const toggleIcon = document.getElementById('toggle-email-visibility');

    const isNowBlurred = userEmailEl.classList.toggle('email-blur');

    if (isNowBlurred) {
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
        toggleIcon.title = "Tampilkan Email";
    } else {
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
        toggleIcon.title = "Sembunyikan Email";
    }
}


const defaultPortalIcons = [ { label: "Ikon Universal", icons: [ { value: "fas fa-shopping-cart", text: "Belanja: Keranjang" }, { value: "fas fa-shopping-bag", text: "Belanja: Tas" }, { value: "fas fa-store", text: "Belanja: Toko" }, { value: "fas fa-tags", text: "Belanja: Tag Harga" }, { value: "fas fa-car", text: "Transportasi: Mobil" }, { value: "fas fa-motorcycle", text: "Transportasi: Motor" }, { value: "fas fa-plane-departure", text: "Perjalanan: Pesawat" }, { value: "fas fa-ticket-alt", text: "Perjalanan: Tiket" }, { value: "fas fa-bed", text: "Perjalanan: Akomodasi" }, { value: "fas fa-wallet", text: "Keuangan: Dompet" }, { value: "fas fa-credit-card", text: "Keuangan: Kartu Kredit" }, { value: "fas fa-landmark", text: "Keuangan: Bank" }, { value: "fas fa-coins", text: "Keuangan: Koin" }, { value: "fas fa-utensils", text: "Makanan: Peralatan Makan" }, { value: "fas fa-hamburger", text: "Makanan: Burger" }, { value: "fas fa-feather-alt", text: "Produktivitas: Tulis/Catatan" }, { value: "fas fa-check-double", text: "Produktivitas: Tugas Selesai" }, { value: "fas fa-chart-pie", text: "Produktivitas: Laporan" }, { value: "fas fa-film", text: "Hiburan: Film" }, { value: "fas fa-tv", text: "Hiburan: TV" }, { value: "fas fa-headphones", text: "Hiburan: Musik" }, ] }, { label: "Media Sosial (Logo Resmi)", icons: [ { value: "fab fa-facebook", text: "Facebook" }, { value: "fab fa-instagram", text: "Instagram" }, { value: "fab fa-whatsapp", text: "WhatsApp" }, { value: "fab fa-x-twitter", text: "Twitter / X" }, { value: "fab fa-tiktok", text: "TikTok" }, { value: "fab fa-youtube", text: "YouTube" }, { value: "fab fa-telegram", text: "Telegram" }, { value: "fab fa-discord", text: "Discord" }, { value: "fab fa-linkedin", text: "LinkedIn" }, { value: "fab fa-pinterest", text: "Pinterest" }, { value: "fab fa-reddit", text: "Reddit" }, { value: "fab fa-snapchat", text: "Snapchat" }, { value: "fab fa-threads", text: "Threads" }, { value: "fab fa-line", text: "Line" }, { value: "fab fa-weixin", text: "WeChat" }, { value: "fab fa-tumblr", text: "Tumblr" }, { value: "fab fa-vk", text: "VK" }, { value: "fab fa-quora", text: "Quora" }, { value: "fab fa-medium", text: "Medium" }, { value: "fab fa-blogger", text: "Blogger" }, { value: "fab fa-wordpress", text: "WordPress" }, { value: "fab fa-deviantart", text: "DeviantArt" }, { value: "fab fa-dribbble", text: "Dribbble" }, { value: "fab fa-behance", text: "Behance" }, { value: "fab fa-flickr", text: "Flickr" }, { value: "fab fa-meetup", text: "Meetup" }, { value: "fab fa-mastodon", text: "Mastodon" }, { value: "fab fa-vimeo", text: "Vimeo" }, { value: "fab fa-mix", text: "Mix" }, { value: "fab fa-xing", text: "Xing" }, { value: "fab fa-goodreads", text: "GoodReads" }, ] }, { label: "Produktivitas & Kerja (Logo Resmi)", icons: [ { value: "fab fa-google-drive", text: "Google Drive" }, { value: "fab fa-slack", text: "Slack" }, { value: "fab fa-trello", text: "Trello" }, { value: "fab fa-asana", text: "Asana" }, { value: "fab fa-evernote", text: "Evernote" }, { value: "fab fa-microsoft", text: "Microsoft" }, { value: "fab fa-skype", text: "Skype" }, { value: "fab fa-dropbox", text: "Dropbox" }, { value: "fab fa-confluence", text: "Confluence" }, { value: "fab fa-jira", text: "Jira" }, { value: "fab fa-figma", text: "Figma" }, ] }, { label: "E-commerce & Keuangan (Logo Resmi)", icons: [ { value: "fab fa-amazon", text: "Amazon" }, { value: "fab fa-ebay", text: "eBay" }, { value: "fab fa-alibaba", text: "Alibaba" }, { value: "fab fa-etsy", text: "Etsy" }, { value: "fab fa-paypal", text: "PayPal" }, { value: "fab fa-stripe", text: "Stripe" }, { value: "fab fa-cc-wise", text: "Wise" }, { value: "fab fa-google-pay", text: "Google Pay" }, { value: "fab fa-apple-pay", text: "Apple Pay" }, { value: "fab fa-samsung-pay", text: "Samsung Pay" }, { value: "fab fa-bitcoin", text: "Bitcoin" }, ] }, { label: "Hiburan & Streaming (Logo Resmi)", icons: [ { value: "fab fa-spotify", text: "Spotify" }, { value: "fab fa-soundcloud", text: "SoundCloud" }, { value: "fab fa-apple", text: "Apple" }, { value: "fab fa-deezer", text: "Deezer" }, { value: "fab fa-pandora", text: "Pandora" }, { value: "fab fa-bandcamp", text: "Bandcamp" }, { value: "fab fa-mixcloud", text: "Mixcloud" }, { value: "fab fa-twitch", text: "Twitch" }, { value: "fab fa-steam", text: "Steam" }, ] }, { label: "Teknologi & Tools (Logo Resmi)", icons: [ { value: "fab fa-github", text: "GitHub" }, { value: "fab fa-gitlab", text: "GitLab" }, { value: "fab fa-bitbucket", text: "Bitbucket" }, { value: "fab fa-aws", text: "AWS" }, { value: "fab fa-google", text: "Google" }, { value: "fab fa-digital-ocean", text: "DigitalOcean" }, { value: "fab fa-linode", text: "Linode" }, { value: "fab fa-docker", text: "Docker" }, { value: "fab fa-npm", text: "NPM" }, { value: "fab fa-yarn", text: "Yarn" }, { value: "fab fa-android", text: "Android" }, { value: "fab fa-jenkins", text: "Jenkins" }, ] }, { label: "Utility / Umum (Lanjutan)", icons: [ { value: "fas fa-home", text: "Home" }, { value: "fas fa-user", text: "User / Profile" }, { value: "fas fa-cog", text: "Settings" }, { value: "fas fa-phone", text: "Phone" }, { value: "fas fa-globe", text: "Globe / Website" }, { value: "fas fa-link", text: "Link (Default)" }, { value: "fas fa-envelope", text: "Email" }, { value: "fas fa-camera", text: "Camera" }, { value: "fas fa-image", text: "Gallery / Image" }, { value: "fas fa-file", text: "File" }, { value: "fas fa-folder", text: "Folder" }, { value: "fas fa-search", text: "Search" }, { value: "fas fa-map-marker-alt", text: "Location" }, { value: "fas fa-bookmark", text: "Bookmark" }, { value: "fas fa-star", text: "Star / Favorite" }, { value: "fas fa-heart", text: "Heart / Like" }, { value: "fas fa-bell", text: "Bell / Notification" }, { value: "fas fa-lock", text: "Lock / Private" }, { value: "fas fa-upload", text: "Upload" }, { value: "fas fa-download", text: "Download" }, { value: "fas fa-qrcode", text: "QR Code" }, ] } ];

function showPortalModal() {
    const iconOptionsHTML = defaultPortalIcons.map(group => `
        <optgroup label="--- ${group.label} ---">
            ${group.icons.map(icon => `<option value="${icon.value}">${icon.text}</option>`).join('')}
        </optgroup>
    `).join('');
    const finalIconOptions = iconOptionsHTML + `<optgroup label="--- Kustomisasi ---"><option value="custom-icon">Ikon Kustom (URL/Unggah)</option></optgroup>`;

    const colorOptions = [
        '#ff2a6d', '#05d9e8', '#d300c5', '#00ff9d', '#ffcc00', '#ffffff', '#1DA1F2', '#FF5700'
    ].map((color, index) => `<div class="portal-color-option ${index === 1 ? 'selected' : ''}" style="background-color: ${color};" onclick="selectPortalColor(this)"></div>`).join('');

    const content = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl text-purple-300" style="font-family: 'Orbitron', sans-serif;">Buat Portal Baru</h3>
            <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
        </div>
        <form id="portalForm" class="space-y-4">
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">Nama Portal</label>
                <input type="text" id="portal-name" class="custom-input" required>
            </div>
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">URL Tujuan</label>
                <input type="url" id="portal-url" class="custom-input" placeholder="https://" required>
            </div>
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">Ikon</label>
                <select id="portal-icon" class="custom-select">${finalIconOptions}</select>
                <div id="custom-icon-options" class="mt-3 hidden">
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <div class="flex-1">
                            <label class="block mb-2 text-xs uppercase tracking-wider">Unggah Ikon</label>
                            <input type="file" id="icon-upload" class="custom-input text-xs p-2" accept="image/*">
                        </div>
                        <div class="flex-1">
                            <label class="block mb-2 text-xs uppercase tracking-wider">atau URL Ikon</label>
                            <input type="url" id="icon-url" class="custom-input" placeholder="https://.../icon.png">
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                       <img id="icon-preview" class="hidden w-16 h-16 object-cover mx-auto rounded-lg border-2 border-dashed p-1" src="#" alt="Icon Preview" style="border-color: var(--input-border);">
                    </div>
                </div>
            </div>
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">Warna Ikon (jika bukan kustom)</label>
                <div class="text-center border rounded-lg p-2" style="border-color: var(--input-border);">
                    ${colorOptions}
                    <input type="color" id="portal-custom-color" class="portal-custom-color-input" value="#05d9e8">
                </div>
                <input type="hidden" id="portal-color" value="#05d9e8">
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" class="closeModal custom-button custom-button-danger">Batal</button>
                <button type="submit" class="custom-button">Buat Portal</button>
            </div>
        </form>
    `;
    showModal(content);

    document.getElementById('portalForm').addEventListener('submit', handlePortalFormSubmit);
    document.getElementById('portal-icon').addEventListener('change', toggleCustomIconOptions);
    document.getElementById('icon-upload').addEventListener('change', (e) => handleImageUpload(e, document.getElementById('icon-preview')));
    document.getElementById('portal-custom-color').addEventListener('input', (e) => applyCustomPortalColor(e.target.value));
}

function handlePortalFormSubmit(e) {
    e.preventDefault();
    
    const name = document.getElementById('portal-name').value;
    const url = document.getElementById('portal-url').value;
    let icon = document.getElementById('portal-icon').value;
    const color = document.getElementById('portal-color').value;
    
    if (icon === 'custom-icon') {
        const iconUrlInput = document.getElementById('icon-url');
        const iconPreview = document.getElementById('icon-preview');

        if (iconPreview.src && iconPreview.src !== '#' && iconPreview.src.startsWith('data:image')) {
            addPortalToArray(name, url, iconPreview.src, color);
        } else if (iconUrlInput.value) {
            addPortalToArray(name, url, iconUrlInput.value, color);
        } else {
            showMessage('Harap unggah gambar atau masukkan URL untuk ikon kustom.', 'error');
        }
    } else {
        addPortalToArray(name, url, icon, color);
    }
}

function addPortalToArray(name, url, icon, color) {
    let appData = storage.getAppData();
    const newPortal = { id: generateId(), name, url, icon, color };
    appData[currentMode].portals.push(newPortal);
    storage.saveAppData(appData);
    renderPortals();
    closeModal();
    showMessage('Portal berhasil dibuat!', 'success');
}

function renderPortals() {
    const portalsContainer = document.getElementById('sidebar-portals-container');
    const appData = storage.getAppData();
    const portals = appData[currentMode].portals || [];

    portalsContainer.innerHTML = '';
    if (portals.length === 0) {
        portalsContainer.innerHTML = `<p class="text-sm text-center text-gray-500 px-2 py-4">Belum ada portal.</p>`;
        return;
    }

    portals.forEach(portal => {
        const portalColor = portal.color || 'var(--primary-brand)';
        
        const iconHtml = portal.icon.startsWith('data:image') || portal.icon.startsWith('http')
            ? `<img src="${portal.icon}" alt="${portal.name} icon">`
            : `<i class="${portal.icon}" style="color: ${portalColor};"></i>`;

        const linkElement = document.createElement('a');
        linkElement.href = portal.url;
        linkElement.target = '_blank';
        linkElement.className = 'sidebar-portal-item';
        linkElement.title = portal.name;

        linkElement.innerHTML = `
            <div class="portal-icon">${iconHtml}</div>
            <span class="portal-name">${portal.name}</span>
            <button data-id="${portal.id}" class="delete-portal-btn text-xs">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        portalsContainer.appendChild(linkElement);

        linkElement.querySelector('.delete-portal-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const portalId = e.currentTarget.dataset.id;
            showConfirm('Hapus Portal?', `Yakin ingin menghapus portal "${portal.name}"?`, () => deletePortal(portalId));
        });
    });
}

function deletePortal(portalId) {
    let appData = storage.getAppData();
    appData[currentMode].portals = appData[currentMode].portals.filter(p => p.id !== portalId);
    storage.saveAppData(appData);
    renderPortals();
    showMessage('Portal dihapus.', 'success');
}


function toggleCustomIconOptions() {
    const portalIconSelect = document.getElementById('portal-icon');
    const customIconOptions = document.getElementById('custom-icon-options');
    customIconOptions.classList.toggle('hidden', portalIconSelect.value !== 'custom-icon');
}

function handleImageUpload(event, previewElement) {
    const file = event.target.files[0];
    if (file) {
        document.getElementById('icon-url').value = ''; 
        const reader = new FileReader();
        reader.onload = (e) => {
            previewElement.src = e.target.result;
            previewElement.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function selectPortalColor(element) {
    const container = element.closest('.text-center');
    container.querySelectorAll('.portal-color-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    const colorValue = element.style.backgroundColor;
    document.getElementById('portal-color').value = colorValue;
    document.getElementById('portal-custom-color').value = rgbToHex(colorValue);
}

function applyCustomPortalColor(color) {
    document.getElementById('portal-color').value = color;
    document.querySelectorAll('.portal-color-option').forEach(el => el.classList.remove('selected'));
}

function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb;
    let sep = rgb.indexOf(",") > -1 ? "," : " ";
    rgb = rgb.substr(4).split(")")[0].split(sep);
    let r = (+rgb[0]).toString(16),
        g = (+rgb[1]).toString(16),
        b = (+rgb[2]).toString(16);
    if (r.length == 1) r = "0" + r;
    if (g.length == 1) g = "0" + g;
    if (b.length == 1) b = "0" + b;
    return "#" + r + g + b;
}

async function exportAllToPdf(timeRange = 'all', customStartDate = null, customEndDate = null, outputType = 'download') {
    if (!checkPremiumAccess()) return;
    if (outputType === 'download') {
        showMessage('Memulai pembuatan laporan PDF komprehensif...', 'info');
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'p',
        unit: 'mm',
        format: [210, 330]
    });

    const bgMediaBlob = await getFileFromDB('customBackground');
    const bgType = localStorage.getItem('customBackgroundType');
    let customBgDataUrl = null;
    if (bgMediaBlob && bgType && bgType.startsWith('image/')) {
        customBgDataUrl = await blobToDataURL(bgMediaBlob);
    }

    let startDate, endDate;
    const now = new Date();
    const endOfToday = new Date(now.getTime());
    endOfToday.setHours(23, 59, 59, 999);
    let dateRangeLabel = "Selamanya";

    switch (timeRange) {
        case 'last7days': startDate = new Date(); startDate.setDate(now.getDate() - 7); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "7 Hari Terakhir"; break;
        case 'last1month': startDate = new Date(); startDate.setMonth(now.getMonth() - 1); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "1 Bulan Terakhir"; break;
        case 'last3months': startDate = new Date(); startDate.setMonth(now.getMonth() - 3); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "3 Bulan Terakhir"; break;
        case 'last1year': startDate = new Date(); startDate.setFullYear(now.getFullYear() - 1); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "1 Tahun Terakhir"; break;
        case 'custom':
            startDate = customStartDate ? new Date(customStartDate) : null;
            if (startDate) startDate.setHours(0, 0, 0, 0);
            endDate = customEndDate ? new Date(customEndDate) : null;
            if (endDate) endDate.setHours(23, 59, 59, 999);
            if (!startDate || !endDate || startDate > endDate) { showMessage('Rentang tanggal kustom tidak valid.', 'error'); return; }
            dateRangeLabel = `${formatDate(startDate.toISOString())} - ${formatDate(endDate.toISOString())}`;
            break;
        case 'all':
        default: startDate = null; endDate = null; break;
    }

    const isLight = document.body.classList.contains('light-mode');
    const isBlack = document.body.classList.contains('black-mode');
    let pdfTheme;
    if (isLight) { pdfTheme = { bgColor: '#FFFFFF', textColor: '#1f2937', headerColor: '#9333ea', subtleTextColor: '#6b7280', lineColor: '#e5e7eb', tableHeaderBg: '#f3e8ff' }; } 
    else if (isBlack) { pdfTheme = { bgColor: '#111827', textColor: '#FFFFFF', headerColor: '#00f0ff', subtleTextColor: '#9ca3af', lineColor: '#4b5563', tableHeaderBg: '#1f2937' }; } 
    else { pdfTheme = { bgColor: '#1A1033', textColor: '#FFFFFF', headerColor: '#c084fc', subtleTextColor: '#9ca3af', lineColor: '#4A148C', tableHeaderBg: '#2E0B4D' }; }
    
    const margin = 15;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let yPos = margin;

    const addBackground = () => {
        if (customBgDataUrl) {
            try {
                const imageType = bgType.split('/')[1].toUpperCase();
                doc.addImage(customBgDataUrl, imageType, 0, 0, pageWidth, pageHeight, '', 'FAST');
            } catch (e) {
                console.error("Gagal menambahkan gambar latar belakang kustom ke PDF:", e);
                doc.setFillColor(pdfTheme.bgColor);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');
            }
        } else {
            doc.setFillColor(pdfTheme.bgColor);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
        }
    };

    const addHeader = (pageTitle) => { doc.setFontSize(10); doc.setTextColor(pdfTheme.headerColor); doc.text('Laporan Lengkap Uranuspace', margin, margin); doc.text(pageTitle, pageWidth / 2, margin, { align: 'center' }); doc.text(new Date().toLocaleDateString('id-ID'), pageWidth - margin, margin, { align: 'right' }); doc.setDrawColor(pdfTheme.lineColor); doc.line(margin, margin + 5, pageWidth - margin, margin + 5); yPos = margin + 15; };
    const addSectionTitle = (title, size = 16) => { if (checkPageEnd(size / 2 + 10)) { addHeader('Lanjutan...'); } doc.setFontSize(size); doc.setTextColor(pdfTheme.headerColor); doc.text(title, margin, yPos); yPos += (size / 2) + 5; };
    const addPageTitle = (title) => { doc.setFontSize(22); doc.setTextColor(pdfTheme.textColor); doc.text(title, margin, yPos); yPos += 15; };
    const checkPageEnd = (neededHeight = 20) => { if (yPos + neededHeight > pageHeight - margin) { doc.addPage(); addBackground(); yPos = margin; return true; } return false; };
    const addChartToPdf = async (canvasId) => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        const chartInstance = window[canvasId + 'Instance'];
        if (!chartInstance) return canvas.toDataURL('image/png', 1.0);
        return canvas.toDataURL('image/png', 1.0);
    };

    addBackground();

    addHeader('Ringkasan Dashboard');
    addPageTitle('Ringkasan Eksekutif');
    
    const appData = storage.getAppData();
    const modeData = appData[currentMode];

    const filterByDate = (item) => {
        if (!startDate || !endDate) return true;
        const itemDateStr = item.date || item.datetime || item.lastModified;
        if (!itemDateStr) return false;
        const itemDate = new Date(itemDateStr);
        return itemDate >= startDate && itemDate <= endDate;
    };

    const filteredTransactions = modeData.transactions.filter(filterByDate);
    const filteredTasks = modeData.tasks.filter(filterByDate);
    const filteredSplitBills = modeData.splitBills.filter(filterByDate);
    const allNotes = storage.get('notes_v5.9.0', []);
    const filteredNotes = allNotes.filter(note => !note.isLocked && filterByDate(note));

    const balance = filteredTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
    const todayStr = new Date().toISOString().split('T')[0];
    const todayTasks = modeData.tasks.filter(p => p.datetime && p.datetime.startsWith(todayStr) && !p.completed).length;
    const pendingTasks = filteredTasks.filter(t => !t.completed).length;

    doc.setFontSize(12);
    doc.setTextColor(pdfTheme.textColor);
    doc.text(`Mode Aktif: ${currentMode === 'personal' ? 'Pribadi' : 'Bisnis'}`, margin, yPos); yPos += 8;
    doc.text(`Rentang Waktu Laporan: ${dateRangeLabel}`, margin, yPos); yPos += 8;
    doc.text(`Saldo Total (Selama Periode): ${formatCurrency(balance)}`, margin, yPos); yPos += 8;
    doc.text(`Tugas Hari Ini (Total): ${todayTasks} tugas`, margin, yPos); yPos += 8;
    doc.text(`Tugas Tertunda (Selama Periode): ${pendingTasks} tugas`, margin, yPos); yPos += 15;

    addSectionTitle('Visualisasi Data Dashboard');
    doc.setFontSize(10);
    doc.setTextColor(pdfTheme.subtleTextColor);
    const warningText = doc.splitTextToSize('PENTING: Grafik di bawah ini diambil dari tampilan dashboard saat ini. Pastikan Anda telah memilih rentang waktu yang sama di filter dashboard sebelum mengekspor agar visualisasi data sesuai dengan data tabel dalam laporan ini.', pageWidth - (margin * 2));
    doc.text(warningText, margin, yPos);
    yPos += (warningText.length * 4) + 10;
    
    const chartWidth = (pageWidth - (margin * 3)) / 2;
    const chartHeight = chartWidth * 0.75;

    if (checkPageEnd(chartHeight + 10)) { addHeader('Ringkasan Dashboard'); }
    let chartX = margin;
    
    let cashFlowImg = await addChartToPdf('cashFlowChart');
    if(cashFlowImg) doc.addImage(cashFlowImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;

    let productivityImg = await addChartToPdf('productivityChart');
    if(productivityImg) doc.addImage(productivityImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 10;

    if (checkPageEnd(chartHeight + 10)) { addHeader('Ringkasan Dashboard'); }
    addSectionTitle('Analisis Gabungan');
    
    let combinedImg = await addChartToPdf('combinedAnalysisChart');
    const combinedHeight = (pageWidth - margin*2) * 0.7;
    if(combinedImg) doc.addImage(combinedImg, 'PNG', margin, yPos, pageWidth - margin*2, combinedHeight);
    yPos += combinedHeight + 10;

    doc.addPage(); addBackground(); addHeader('Analisis Mendalam'); addPageTitle('Detail Analisis Grafik');
    chartX = margin;
    addSectionTitle('Analisis Keuangan');
    let incomeVsExpenseImg = await addChartToPdf('incomeVsExpenseChart');
    if(incomeVsExpenseImg) doc.addImage(incomeVsExpenseImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let spendingByCategoryImg = await addChartToPdf('spendingByCategoryChart');
    if(spendingByCategoryImg) doc.addImage(spendingByCategoryImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 15;
    chartX = margin;

    if (checkPageEnd(chartHeight + 20)) { addHeader('Analisis Mendalam'); }
    addSectionTitle('Analisis Produktivitas');
    let taskCompletionTrendImg = await addChartToPdf('taskCompletionTrendChart');
    if(taskCompletionTrendImg) doc.addImage(taskCompletionTrendImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let taskPriorityDistributionImg = await addChartToPdf('taskPriorityDistributionChart');
    if(taskPriorityDistributionImg) doc.addImage(taskPriorityDistributionImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 15;
    chartX = margin;

    if (checkPageEnd(chartHeight + 20)) { addHeader('Analisis Mendalam'); }
    addSectionTitle('Analisis Split Bill');
    let splitBillByUserImg = await addChartToPdf('splitBillByUserChart');
    if(splitBillByUserImg) doc.addImage(splitBillByUserImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let splitBillFrequencyImg = await addChartToPdf('splitBillFrequencyChart');
    if(splitBillFrequencyImg) doc.addImage(splitBillFrequencyImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 15;
    chartX = margin;

    if (checkPageEnd(chartHeight + 20)) { addHeader('Analisis Mendalam'); }
    addSectionTitle('Analisis Catatan');
    let diaryEntryFrequencyImg = await addChartToPdf('diaryEntryFrequencyChart');
    if(diaryEntryFrequencyImg) doc.addImage(diaryEntryFrequencyImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let noteMoodAnalysisImg = await addChartToPdf('noteMoodAnalysisChart');
    if(noteMoodAnalysisImg) doc.addImage(noteMoodAnalysisImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 10;


    doc.addPage(); addBackground(); addHeader('Keuangan'); addPageTitle('Laporan Keuangan');
    if (filteredTransactions.length > 0) {
        const head = [['Tanggal', 'Deskripsi', 'Kategori', 'Pemasukan', 'Pengeluaran']];
        const body = filteredTransactions.map(t => [formatDate(t.date), t.description, getCategoryName(t.category), t.type === 'income' ? formatCurrency(t.amount) : '', t.type === 'expense' ? formatCurrency(t.amount) : '']);
        doc.autoTable({ head, body, startY: yPos, theme: 'grid', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
        yPos = doc.autoTable.previous.finalY;
        
        const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const netResult = totalIncome - totalExpense;

        if (checkPageEnd(40)) { 
            addHeader('Keuangan'); 
        }

        yPos += 15;
        addSectionTitle('Ringkasan Keuangan', 14);

        doc.setFontSize(11);
        doc.setTextColor(pdfTheme.textColor);
        
        const summaryX = margin + 5;
        const valueX = pageWidth - margin - 5;

        doc.text('Total Pemasukan:', summaryX, yPos);
        doc.text(formatCurrency(totalIncome), valueX, yPos, { align: 'right' });
        yPos += 8;

        doc.text('Total Pengeluaran:', summaryX, yPos);
        doc.text(formatCurrency(totalExpense), valueX, yPos, { align: 'right' });
        yPos += 8;

        doc.setDrawColor(pdfTheme.lineColor);
        doc.line(summaryX, yPos, valueX, yPos);
        yPos += 8;

        doc.setFont('helvetica', 'bold');
        doc.text(netResult >= 0 ? 'Laba Bersih:' : 'Rugi Bersih:', summaryX, yPos);
        doc.text(formatCurrency(netResult), valueX, yPos, { align: 'right' });
        doc.setFont('helvetica', 'normal');

    } else { 
        doc.setTextColor(pdfTheme.textColor); 
        doc.text('Tidak ada data transaksi pada rentang waktu yang dipilih.', margin, yPos); 
    }

    doc.addPage(); addBackground(); addHeader('Manajemen Waktu'); addPageTitle('Daftar Tugas');
    const activeTasks = filteredTasks.filter(t => !t.completed);
    const completedTasks = filteredTasks.filter(t => t.completed);
    if (activeTasks.length > 0) {
        addSectionTitle('Tugas Aktif', 14);
        doc.autoTable({ head: [['Tugas', 'Waktu', 'Prioritas']], body: activeTasks.map(t => [t.title, formatDateTime(t.datetime), t.priority]), startY: yPos, theme: 'grid', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
        yPos = doc.autoTable.previous.finalY + 15;
    } else { doc.setTextColor(pdfTheme.textColor); doc.text('Tidak ada tugas aktif pada rentang waktu yang dipilih.', margin, yPos); yPos += 15; }
    if (completedTasks.length > 0) {
        if(checkPageEnd(30)) { addHeader('Manajemen Waktu'); }
        addSectionTitle('Tugas Selesai', 14);
        doc.autoTable({ head: [['Tugas', 'Waktu', 'Prioritas']], body: completedTasks.map(t => [t.title, formatDateTime(t.datetime), t.priority]), startY: yPos, theme: 'grid', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
    }

    doc.addPage(); addBackground(); addHeader('Split Bill'); addPageTitle('Riwayat Split Bill');
    if (filteredSplitBills.length > 0) {
        filteredSplitBills.forEach(bill => {
            if (checkPageEnd(40)) { addHeader('Split Bill'); }
            doc.setFontSize(12); doc.setTextColor(pdfTheme.textColor); doc.text(`Tanggal: ${formatDate(bill.date)} - Total: ${formatCurrency(bill.totalBill)}`, margin, yPos); yPos += 8;
            doc.autoTable({ head: [['Nama', 'Jumlah Bayar']], body: bill.results.map(r => [r.name, formatCurrency(r.amount)]), startY: yPos, theme: 'striped', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
            yPos = doc.autoTable.previous.finalY + 10;
            doc.setDrawColor(pdfTheme.lineColor); doc.line(margin, yPos, pageWidth - margin, yPos); yPos += 5;
        });
    } else { doc.setTextColor(pdfTheme.textColor); doc.text('Tidak ada riwayat split bill pada rentang waktu yang dipilih.', margin, yPos); }

    doc.addPage(); addBackground(); addHeader('Catatan'); addPageTitle('Daftar Catatan');
    if (filteredNotes.length > 0) {
        filteredNotes.forEach(note => {
            if (checkPageEnd(30)) { addHeader('Catatan'); }
            doc.setFontSize(14); doc.setTextColor(pdfTheme.headerColor); doc.text(note.title || 'Tanpa Judul', margin, yPos); yPos += 6;
            doc.setFontSize(9); doc.setTextColor(pdfTheme.subtleTextColor); 
            doc.text(`Tanggal: ${formatDate(note.lastModified)}`, margin, yPos); yPos += 8;
            doc.setFontSize(11); doc.setTextColor(pdfTheme.textColor);
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = note.content;
            const contentText = tempDiv.innerText || tempDiv.textContent || '';
            const splitText = doc.splitTextToSize(contentText, pageWidth - (margin * 2));
            doc.text(splitText, margin, yPos);
            yPos += (splitText.length * 4) + 10;
            doc.setDrawColor(pdfTheme.lineColor); doc.line(margin, yPos, pageWidth - margin, yPos); yPos += 5;
        });
    } else { doc.setTextColor(pdfTheme.textColor); doc.text('Tidak ada catatan pada rentang waktu yang dipilih.', margin, yPos); }

    if (outputType === 'blob') {
        return doc.output('blob');
    } else {
        const fileName = `Laporan_Uranuspace_${dateRangeLabel.replace(/ /g, '_')}.pdf`;
        doc.save(fileName);
        showMessage('Laporan PDF berhasil dibuat dan diunduh!', 'success');
    }
}

async function exportAllToImages(timeRange = 'all', customStartDate = null, customEndDate = null) {
    if (!checkPremiumAccess()) return;
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const exportImagesBtn = document.getElementById('export-images-btn');
    
    exportPdfBtn.disabled = true;
    exportImagesBtn.disabled = true;

    try {
        showMessage('Memulai ekspor gambar... Menyiapkan PDF di memori.', 'info');

        const pdfBlob = await exportAllToPdf(timeRange, customStartDate, customEndDate, 'blob');
        if (!pdfBlob) {
            throw new Error("Gagal menghasilkan data PDF di memori.");
        }

        showMessage('PDF berhasil dibuat. Merender halaman menjadi gambar...', 'info');

        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        const zip = new JSZip();

        const pdfData = await pdfBlob.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        const numPages = pdf.numPages;

        for (let i = 1; i <= numPages; i++) {
            showMessage(`Memproses halaman ${i} dari ${numPages}...`, 'info');
            const page = await pdf.getPage(i);
            
            const viewport = page.getViewport({ scale: 1 });
            const scale = 3840 / viewport.width;
            const scaledViewport = page.getViewport({ scale: scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = scaledViewport.width;
            canvas.height = scaledViewport.height;

            const renderContext = {
                canvasContext: context,
                viewport: scaledViewport
            };
            await page.render(renderContext).promise;

            const imageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1.0));
            zip.file(`Halaman_${i}.png`, imageBlob);
        }

        showMessage('Semua halaman diproses. Membuat file ZIP...', 'success');
        const zipBlob = await zip.generateAsync({ type: "blob" });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        const dateRangeLabel = timeRange === 'custom' ? `${customStartDate}_to_${customEndDate}` : timeRange;
        link.download = `Laporan_Gambar_Uranuspace_${dateRangeLabel}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        showMessage('File ZIP berhasil dibuat dan diunduh!', 'success');

    } catch (error) {
        console.error("Gagal mengekspor gambar:", error);
        showMessage(`Terjadi kesalahan saat mengekspor gambar: ${error.message}`, 'error');
    } finally {
        exportPdfBtn.disabled = false;
        exportImagesBtn.disabled = false;
    }
}

class MediaUploader {
    constructor(options) {
        this.file = options.file;
        this.token = options.token;
        this.metadata = options.metadata || { name: this.file.name, mimeType: this.file.type || 'application/octet-stream' };
        this.chunkSize = options.chunkSize || 5 * 1024 * 1024;
        this.onProgress = options.onProgress || (() => {});
        this.onComplete = options.onComplete || (() => {});
        this.onError = options.onError || (() => {});
        
        this.uploadUrl = null;
        this.offset = 0;
        this.paused = false;
        this.cancelled = false;
        this.lastChunkTime = null;
        this.lastChunkLoaded = 0;
    }

    async upload() {
        try {
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': `Bearer ${this.token}`,
                    'Content-Type': 'application/json'
                }),
                body: JSON.stringify(this.metadata)
            });

            if (!response.ok) throw new Error('Failed to initiate resumable upload.');
            
            this.uploadUrl = response.headers.get('Location');
            this.sendNextChunk();
        } catch (error) {
            this.onError(error);
        }
    }

    sendNextChunk() {
        if (this.paused || this.cancelled) return;
        if (this.offset >= this.file.size) {
            this.onComplete();
            return;
        }

        const chunk = this.file.slice(this.offset, this.offset + this.chunkSize);
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', this.uploadUrl, true);
        xhr.setRequestHeader('Content-Range', `bytes ${this.offset}-${this.offset + chunk.size - 1}/${this.file.size}`);
        
        xhr.upload.onprogress = (e) => {
            const currentTime = new Date().getTime();
            if (this.lastChunkTime) {
                const timeDiff = (currentTime - this.lastChunkTime) / 1000;
                const loadedDiff = e.loaded - this.lastChunkLoaded;
                const speed = timeDiff > 0 ? loadedDiff / timeDiff : 0;
                this.onProgress({ loaded: this.offset + e.loaded, total: this.file.size, speed: speed });
            }
            this.lastChunkTime = currentTime;
            this.lastChunkLoaded = e.loaded;
        };

        xhr.onload = () => {
            if (xhr.status === 200 || xhr.status === 201) {
                this.onComplete();
            } else if (xhr.status === 308) {
                this.offset += chunk.size;
                this.lastChunkLoaded = 0;
                this.sendNextChunk();
            } else {
                this.onError(new Error(`Upload failed with status: ${xhr.status}`));
            }
        };

        xhr.onerror = () => {
            this.onError(new Error('Network error during upload.'));
        };

        xhr.send(chunk);
        this.xhr = xhr;
    }
}

// ===================================================================================
// =================== [BARU] FITUR DOWNLOAD VIA LINK & PREVIEW FILE =================
// ===================================================================================

function showDownloadViaLinkModal(e) {
    if (!checkPremiumAccess(e)) return;
    if (!googleAccessToken) {
        showMessage("Hubungkan ke Google Drive terlebih dahulu.", "error");
        return;
    }
    const content = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-purple-300">Download File dari Link Google Drive</h3>
            <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
        </div>
        <p class="text-sm text-gray-400 mb-6">Tempelkan link berbagi Google Drive di bawah ini. File akan diunduh dan disimpan ke folder <strong>uranuspace_storage</strong> di Drive Anda.</p>
        <div class="space-y-4">
            <input type="url" id="gdrive-link-input" class="custom-input" placeholder="https://drive.google.com/file/d/...">
            <button id="start-gdrive-download-btn" class="custom-button w-full">Mulai Proses</button>
        </div>
    `;
    showModal(content);
    document.getElementById('start-gdrive-download-btn').addEventListener('click', processGdriveLink);
}

function extractFileIdFromUrl(url) {
    const regex = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]{28,})/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

async function getGdriveFileMetadata(fileId) {
    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?fields=id,name,size,mimeType,webContentLink,hasThumbnail,thumbnailLink`, {
        headers: new Headers({ 'Authorization': `Bearer ${googleAccessToken}` })
    });
    if (!response.ok) {
        throw new Error('Gagal mendapatkan metadata file. Pastikan link valid dan file dapat diakses.');
    }
    return await response.json();
}

async function downloadGdriveFileAsBlobWithAuth(fileId, onProgress) {
    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
        headers: new Headers({ 'Authorization': `Bearer ${googleAccessToken}` })
    });
    if (!response.ok) throw new Error(`Gagal mengunduh. Status: ${response.statusText}`);

    const contentLength = +response.headers.get('Content-Length');
    const reader = response.body.getReader();
    let receivedLength = 0;
    let chunks = [];
    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        receivedLength += value.length;
        if (onProgress && contentLength) {
            onProgress(receivedLength, contentLength);
        }
    }
    return new Blob(chunks);
}

async function processGdriveLink() {
    const url = document.getElementById('gdrive-link-input').value;
    closeModal();
    const fileId = extractFileIdFromUrl(url);

    if (!fileId) {
        showMessage('Link Google Drive tidak valid.', 'error');
        return;
    }

    const downloadId = `download-via-link-${fileId}`;

    try {
        showMessage("Mendapatkan info file dari link...", "info");
        const metadata = await getGdriveFileMetadata(fileId);
        
        showMessage(`File ditemukan: ${metadata.name} (${formatSize(metadata.size)}). Memulai proses...`, 'info');
        addUploadProgressUI(downloadId, metadata.name);
        
        const fileBlob = await downloadGdriveFileAsBlobWithAuth(fileId, (loaded, total) => {
            const percentage = Math.round((loaded / total) * 100);
            updateUploadProgressUI(downloadId, percentage, `Mengunduh: ${formatSize(loaded)} / ${formatSize(total)}`);
        });

        updateUploadProgressUI(downloadId, 100, "Selesai diunduh. Mengunggah ke Drive Anda...");
        
        const rootFolderId = await findOrCreateFolder(DRIVE_UPLOAD_FOLDER_NAME, 'root');
        const subfolderName = getUploadSubfolder({ name: metadata.name, type: metadata.mimeType });
        const subfolderId = await findOrCreateFolder(subfolderName, rootFolderId);
        
        uploadSingleFileWithProgress(new File([fileBlob], metadata.name, { type: metadata.mimeType }), subfolderId);
        removeUploadProgressUI(downloadId, true);

    } catch (error) {
        console.error("Gagal memproses link GDrive:", error);
        showMessage(`Proses gagal: ${error.message}`, 'error');
        removeUploadProgressUI(downloadId, false);
    }
}

async function showManageFilesModal(options = {}) {
    const { isPicker = false, onFilePicked = () => {} } = options;
    if (!googleAccessToken) {
        showMessage("Hubungkan ke Google Drive terlebih dahulu.", "error");
        return;
    }
    const modalTitle = isPicker ? "Pilih File dari Drive" : "Kelola File Drive (uranuspace_storage)";
    const modalInstruction = isPicker ? "Pilih file yang ingin dibuka di editor." : "Klik kanan atau klik tombol opsi (⋯) pada file untuk melihat tindakan yang tersedia.";

    const content = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-purple-300">${modalTitle}</h3>
            <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
        </div>
        <p class="text-sm text-gray-400 mb-6">${modalInstruction}</p>
        <div id="file-browser" class="bg-black/20 p-3 rounded-md max-h-[60vh] overflow-y-auto text-sm">
            Memuat daftar file...
        </div>
        <style>
            .context-menu { display: none; position: absolute; z-index: 1010; background: var(--sidebar-bg); border: 1px solid var(--card-border); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); padding: 0.5rem; min-width: 150px; }
            .context-menu button { display: flex; align-items: center; width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; color: var(--text-secondary); font-size: 0.8rem; border-radius: 4px; cursor: pointer; }
            .context-menu button:hover { background-color: var(--hover-nav-bg); color: var(--text-primary); }
            .context-menu button i { margin-right: 0.75rem; width: 1em; }
            .file-item.picker-mode { cursor: pointer; }
        </style>
    `;
    showModal(content);
    renderFileBrowser({ isPicker, onFilePicked });
}

async function renderFileBrowser(options = {}) {
    const { isPicker = false, onFilePicked = () => {} } = options;
    const browserDiv = document.getElementById('file-browser');
    if (!browserDiv) return;
    browserDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mencari folder utama...';
    try {
        const rootFolderId = await findFolderId('uranuspace_storage', 'root');
        if (!rootFolderId) {
            browserDiv.innerHTML = '<p class="text-red-400">Folder "uranuspace_storage" tidak ditemukan di Drive Anda.</p>';
            return;
        }
        browserDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengambil daftar file...';
        const fileTree = await listAllFilesAndFoldersRecursively(rootFolderId);
        browserDiv.innerHTML = generateFileTreeHTML(fileTree.children, isPicker);
        
        browserDiv.querySelectorAll('.folder-name, .file-item').forEach(item => {
            item.addEventListener('contextmenu', e => {
                e.preventDefault();
                if (isPicker) return; // Disable context menu in picker mode
                const fileId = e.currentTarget.dataset.id;
                const fileName = e.currentTarget.dataset.name;
                const mimeType = e.currentTarget.dataset.mime;
                const webContentLink = e.currentTarget.dataset.webcontentlink;
                showContextMenu(e.pageX, e.pageY, { id: fileId, name: fileName, mimeType, webContentLink });
            });
        });

        browserDiv.querySelectorAll('.folder-name').forEach(folder => {
            folder.addEventListener('click', (e) => {
                e.currentTarget.parentElement.querySelector('.sub-items').classList.toggle('hidden');
                e.currentTarget.querySelector('i').classList.toggle('fa-folder');
                e.currentTarget.querySelector('i').classList.toggle('fa-folder-open');
            });
        });

        browserDiv.querySelectorAll('.file-options-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const item = e.currentTarget.closest('.file-item');
                const fileId = item.dataset.id;
                const fileName = item.dataset.name;
                const mimeType = item.dataset.mime;
                const webContentLink = item.dataset.webcontentlink;
                const rect = e.currentTarget.getBoundingClientRect();
                showContextMenu(rect.left, rect.bottom, { id: fileId, name: fileName, mimeType, webContentLink });
            });
        });

        if (isPicker) {
            browserDiv.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const fileId = e.currentTarget.dataset.id;
                    const fileName = e.currentTarget.dataset.name;
                    const mimeType = e.currentTarget.dataset.mime;
                    onFilePicked({ id: fileId, name: fileName, mimeType });
                    closeModal();
                });
            });
        }

    } catch (error) {
        console.error("Error rendering file browser:", error);
        browserDiv.innerHTML = `<p class="text-red-400">Gagal memuat file: ${error.message}</p>`;
    }
}

function getFileIcon(mimeType) {
    if (!mimeType) return 'fa-file';
    if (mimeType.startsWith('image/')) return 'fa-file-image text-green-400';
    if (mimeType.startsWith('video/')) return 'fa-file-video text-purple-400';
    if (mimeType.startsWith('audio/')) return 'fa-file-audio text-blue-400';
    if (mimeType === 'application/pdf') return 'fa-file-pdf text-red-400';
    if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) return 'fa-file-excel text-green-500';
    if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'fa-file-powerpoint text-orange-400';
    if (mimeType.includes('document') || mimeType.includes('word')) return 'fa-file-word text-blue-500';
    if (mimeType.includes('zip') || mimeType.includes('archive')) return 'fa-file-archive text-yellow-500';
    return 'fa-file text-gray-300';
}

function generateFileTreeHTML(items, isPicker = false) {
    if (!items || items.length === 0) return '<p class="text-gray-500 pl-4">Folder ini kosong.</p>';
    return items.map(item => {
        if (item.mimeType === 'application/vnd.google-apps.folder') {
            return `
                <div class="folder-item ml-2">
                    <div class="folder-name flex items-center p-1 hover:bg-purple-500/20 rounded cursor-pointer" data-id="${item.id}" data-name="${item.name}" data-mime="${item.mimeType}">
                        <i class="fas fa-folder w-5 mr-2 text-yellow-400"></i>
                        <span>${item.name}</span>
                    </div>
                    <div class="sub-items hidden pl-4 border-l border-purple-500/30">
                        ${generateFileTreeHTML(item.children, isPicker)}
                    </div>
                </div>`;
        } else {
            const pickerClass = isPicker ? 'picker-mode' : '';
            const optionsButton = isPicker ? '' : `
                <button class="file-options-btn custom-button !p-1 !text-xs !bg-transparent hover:!bg-purple-500/20" title="Opsi">
                    <i class="fas fa-ellipsis-v"></i>
                </button>`;
            return `
                <div class="file-item ml-4 flex items-center justify-between p-1 hover:bg-purple-500/20 rounded ${pickerClass}" data-id="${item.id}" data-name="${item.name}" data-mime="${item.mimeType}" data-webcontentlink="${item.webContentLink || ''}">
                    <div class="flex items-center truncate">
                        <i class="fas ${getFileIcon(item.mimeType)} w-5 mr-2"></i>
                        <span class="truncate">${item.name}</span>
                    </div>
                    ${optionsButton}
                </div>`;
        }
    }).join('');
}

function showContextMenu(x, y, file) {
    let menu = document.getElementById('context-menu');
    if (menu) menu.remove();

    menu = document.createElement('div');
    menu.id = 'context-menu';
    menu.className = 'context-menu';
    
    menu.innerHTML = `
        <button data-action="preview"><i class="fas fa-eye"></i>Pratinjau</button>
        <button data-action="download"><i class="fas fa-download"></i>Unduh</button>
        <button data-action="share"><i class="fas fa-share-alt"></i>Bagikan & Salin Link</button>
        <button data-action="delete" style="color: var(--danger-brand);"><i class="fas fa-trash"></i>Hapus</button>
    `;

    document.body.appendChild(menu);
    menu.style.display = 'block';
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;

    const closeMenu = () => {
        if (menu) menu.remove();
        document.removeEventListener('click', closeMenu);
    };
    setTimeout(() => document.addEventListener('click', closeMenu), 0);

    menu.addEventListener('click', (e) => {
        const action = e.target.closest('button')?.dataset.action;
        if (action) {
            handleFileAction(action, file);
        }
    });
}

function handleFileAction(action, file) {
    switch(action) {
        case 'preview':
            showPreviewModal(file, { fromManageModal: true });
            break;
        case 'download':
            downloadSingleFileWithAuth(file.id, file.name);
            break;
        case 'share':
            shareAndCopyLink(file.id, file.name);
            break;
        case 'delete':
            confirmDeleteDriveFile(file.id, file.name);
            break;
    }
}

async function showPreviewModal(file, options = {}) {
    const { fromManageModal = false } = options;
    const modal = document.getElementById('filePreviewModal');
    const titleEl = document.getElementById('preview-title');
    const contentContainer = document.getElementById('preview-content-container');
    const backBtn = document.getElementById('preview-back-btn');

    // Sembunyikan modal manajemen file jika ada, agar pratinjau muncul di atas
    if (fromManageModal) {
        document.getElementById('mainModal').style.display = 'none';
        backBtn.classList.remove('hidden');
    } else {
        backBtn.classList.add('hidden');
    }
    
    titleEl.textContent = file.name;
    contentContainer.innerHTML = '<i class="fas fa-spinner fa-spin text-4xl text-purple-300"></i>';
    modal.classList.add('show');
    
    let objectUrl = null;

    const cleanup = () => {
        if (objectUrl) {
            URL.revokeObjectURL(objectUrl);
        }
        modal.classList.remove('show');
        // Tampilkan kembali modal manajemen file jika disembunyikan
        if (fromManageModal) {
            document.getElementById('mainModal').style.display = 'flex';
        }
        modal.querySelector('.closeModal').removeEventListener('click', cleanup);
        backBtn.removeEventListener('click', cleanup);
    };

    modal.querySelector('.closeModal').addEventListener('click', cleanup);
    backBtn.addEventListener('click', cleanup);

    try {
        const blob = await downloadGdriveFileAsBlobWithAuth(file.id, (loaded, total) => {
            const percentage = Math.round((loaded / total) * 100);
            contentContainer.innerHTML = `<i class="fas fa-spinner fa-spin text-4xl text-purple-300"></i><p class="text-sm mt-2 text-gray-400">Mengunduh... ${percentage}%</p>`;
        });
        objectUrl = URL.createObjectURL(blob);
        await renderPreviewContent(objectUrl, file.mimeType, file.webContentLink);
    } catch (error) {
        console.error("Preview error:", error);
        contentContainer.innerHTML = `<p class="text-red-400">Gagal memuat pratinjau: ${error.message}</p>`;
    }
}

async function renderPreviewContent(url, mimeType, webContentLink) {
    const contentContainer = document.getElementById('preview-content-container');
    contentContainer.innerHTML = '';

    if (mimeType.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = url;
        contentContainer.appendChild(img);
    } else if (mimeType.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = url;
        video.controls = true;
        contentContainer.appendChild(video);
    } else if (mimeType.startsWith('audio/')) {
        const audio = document.createElement('audio');
        audio.src = url;
        audio.controls = true;
        contentContainer.appendChild(audio);
    } else if (mimeType === 'application/pdf') {
        const canvas = document.createElement('canvas');
        contentContainer.appendChild(canvas);
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        const pdf = await pdfjsLib.getDocument(url).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport });
    } else if (mimeType.startsWith('text/')) {
        const response = await fetch(url);
        const text = await response.text();
        const pre = document.createElement('pre');
        pre.textContent = text;
        contentContainer.appendChild(pre);
    } else if (mimeType.includes('document') || mimeType.includes('spreadsheet') || mimeType.includes('presentation')) {
        const iframe = document.createElement('iframe');
        // Google Docs Viewer can be tricky with blob URLs, using webContentLink is more reliable
        if (webContentLink) {
            // The webContentLink needs to be embedded
            const embedUrl = webContentLink.replace('/uc?id=', '/embed?id=').replace('&export=download', '');
            iframe.src = `https://docs.google.com/gview?url=${encodeURIComponent(embedUrl)}&embedded=true`;
        } else {
             contentContainer.innerHTML = `<p class="text-center p-4">Pratinjau untuk tipe file ini memerlukan pembukaan di tab baru. <a href="${url}" target="_blank" class="text-purple-300 underline">Buka File</a></p>`;
        }
        contentContainer.appendChild(iframe);
    } else {
        contentContainer.innerHTML = `<p class="text-center p-4">Pratinjau tidak tersedia untuk tipe file ini. <a href="${url}" download target="_blank" class="text-purple-300 underline">Unduh File</a></p>`;
    }
}

async function downloadSingleFileWithAuth(fileId, fileName) {
    const downloadId = `download-${fileId}`;
    addUploadProgressUI(downloadId, fileName);
    try {
        const blob = await downloadGdriveFileAsBlobWithAuth(fileId, (loaded, total) => {
            const percentage = Math.round((loaded / total) * 100);
            updateUploadProgressUI(downloadId, percentage, `${formatSize(loaded)} / ${formatSize(total)}`);
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        removeUploadProgressUI(downloadId, true);
        showMessage(`"${fileName}" berhasil diunduh!`, 'success');
    } catch (error) {
        console.error("Download error:", error);
        showMessage(`Gagal mengunduh file: ${error.message}`, 'error');
        removeUploadProgressUI(downloadId, false);
    }
}

async function shareAndCopyLink(fileId, fileName) {
    try {
        // First, make the file public (anyone with the link can view)
        await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions`, {
            method: 'POST',
            headers: new Headers({
                'Authorization': `Bearer ${googleAccessToken}`,
                'Content-Type': 'application/json'
            }),
            body: JSON.stringify({
                'role': 'reader',
                'type': 'anyone'
            })
        });

        // Then, get the web link
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?fields=webViewLink`, {
            headers: new Headers({ 'Authorization': `Bearer ${googleAccessToken}` })
        });
        if (!response.ok) throw new Error('Gagal mendapatkan link file.');

        const data = await response.json();
        const link = data.webViewLink;

        // Copy to clipboard
        navigator.clipboard.writeText(link).then(() => {
            showMessage(`Link untuk "${fileName}" telah disalin!`, 'success');
        }, () => {
            showMessage('Gagal menyalin link.', 'error');
        });

    } catch (error) {
        console.error("Share error:", error);
        showMessage(`Gagal membagikan file: ${error.message}`, 'error');
    }
}

function confirmDeleteDriveFile(fileId, fileName) {
    showConfirm('Hapus File dari Drive?', `Anda yakin ingin menghapus "${fileName}" secara permanen dari Google Drive? Tindakan ini tidak dapat diurungkan.`, async () => {
        try {
            showMessage(`Menghapus "${fileName}"...`, 'info');
            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                method: 'DELETE',
                headers: new Headers({ 'Authorization': `Bearer ${googleAccessToken}` })
            });
            if (!response.ok && response.status !== 204) {
                throw new Error('Gagal menghapus file dari Google Drive.');
            }
            showMessage(`"${fileName}" berhasil dihapus.`, 'success');
            renderFileBrowser(); // Refresh file list
        } catch (error) {
            console.error("Delete error:", error);
            showMessage(`Gagal menghapus file: ${error.message}`, 'error');
        }
    });
}


async function listAllFilesAndFoldersRecursively(folderId) {
    const query = `'${folderId}' in parents and trashed=false`;
    const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id, name, mimeType, webContentLink, hasThumbnail, thumbnailLink)`, {
        headers: new Headers({ 'Authorization': `Bearer ${googleAccessToken}` })
    });
    if (!response.ok) throw new Error('Gagal mengambil daftar file.');
    
    const data = await response.json();
    const children = [];
    
    for (const file of data.files) {
        if (file.mimeType === 'application/vnd.google-apps.folder') {
            const subFolder = await listAllFilesAndFoldersRecursively(file.id);
            children.push(subFolder);
        } else {
            children.push(file);
        }
    }
    
    const folderInfoResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${folderId}?fields=name`, {
        headers: new Headers({ 'Authorization': `Bearer ${googleAccessToken}` })
    });
    const folderInfo = await folderInfoResponse.json();

    return { id: folderId, name: folderInfo.name, mimeType: 'application/vnd.google-apps.folder', children: children };
}

function formatSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ===================================================================================
// =================== [BARU] CLASS UNTUK FITUR EDITOR HTML =========================
// ===================================================================================
class HtmlEditorApp {
    constructor() {
        this.notes = [];
        this.currentNoteId = null;
        this.activeTab = 'html';
        this.autoRefreshEnabled = false;
        this.debounceTimeout = null;
        
        // [BARU] Properti untuk Undo/Redo
        this.history = {}; // { noteId: { stack: [], index: -1 } }
        this.isNavigatingHistory = false; // Flag untuk mencegah rekursi
        
        this.cursorHistory = [];
        this.currentCursorIndex = -1;
        this.isNavigatingCursorHistory = false;
    }

    init() {
        this.cacheDOMElements();
        this.bindEvents();
        this.loadNotesFromStorage();
    }

    cacheDOMElements() {
        this.dom = {
            // Main Containers
            editorContainer: document.getElementById('editor-container'),
            welcomeMessage: document.getElementById('welcome-message'),
            htmlEditor: document.getElementById('html-editor'),
            
            // Note Lists
            htmlNotesList: document.getElementById('htmlNotesList'),
            searchHtmlNotesInput: document.getElementById('searchHtmlNotes'),
            
            // Buttons
            addHtmlNoteBtn: document.getElementById('addHtmlNoteBtn'),
            runBtn: document.getElementById('runBtn'),
            saveHtmlNoteBtn: document.getElementById('saveHtmlNoteBtn'),
            exportBtn: document.getElementById('exportBtn'),
            exportMenu: document.getElementById('export-menu'),
            exportHtmlBtn: document.getElementById('exportHtmlBtn'),
            exportPdfBtn: document.getElementById('exportPdfBtn'),
            exportPdfCodeBtn: document.getElementById('exportPdfCodeBtn'),

            // Editor Fields
            htmlNoteTitle: document.getElementById('htmlNoteTitle'),
            htmlCode: document.getElementById('htmlCode'),
            cssCode: document.getElementById('cssCode'),
            jsCode: document.getElementById('jsCode'),
            
            // Tabs & Panels
            codeEditorTabs: document.querySelector('.code-editor-tabs'),
            codePanels: document.getElementById('code-panels'),
            
            // Preview
            previewPanel: document.getElementById('preview-panel'),
            htmlPreviewIframe: document.getElementById('html-preview-iframe'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            autoRefreshToggle: document.getElementById('auto-refresh-toggle'),

            // Toolbar
            toolbar: document.getElementById('html-editor-toolbar'),
            addFileBtn: document.getElementById('html-add-file-btn'),
            openDriveBtn: document.getElementById('html-open-drive-btn'), // [BARU]
            undoBtn: document.getElementById('html-undo-btn'),
            redoBtn: document.getElementById('html-redo-btn'),
            cursorPrevBtn: document.getElementById('html-cursor-prev-btn'),
            cursorNextBtn: document.getElementById('html-cursor-next-btn'),
            searchBtn: document.getElementById('html-search-btn'),
            searchWrapper: document.getElementById('html-search-wrapper'),
            searchInput: document.getElementById('html-search-input'),
        };
    }

    bindEvents() {
        this.dom.addHtmlNoteBtn.addEventListener('click', () => this.createNewHtmlNote());
        this.dom.runBtn.addEventListener('click', () => this.runCode());
        this.dom.saveHtmlNoteBtn.addEventListener('click', () => this.saveCurrentHtmlNote());
        this.dom.codeEditorTabs.addEventListener('click', (e) => this.switchTab(e));
        this.dom.searchHtmlNotesInput.addEventListener('input', () => this.renderHtmlNotesList());

        this.dom.exportBtn.addEventListener('click', (e) => this.toggleExportMenu(e));
        document.addEventListener('click', (e) => this.closeExportMenu(e));
        this.dom.exportHtmlBtn.addEventListener('click', () => this.exportToHtmlFile());
        this.dom.exportPdfBtn.addEventListener('click', () => this.exportPreviewToPdfFile());
        this.dom.exportPdfCodeBtn.addEventListener('click', () => this.exportCodeToPdfFile());

        this.dom.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
        this.dom.autoRefreshToggle.addEventListener('change', (e) => this.toggleAutoRefresh(e.target.checked));

        // Toolbar Events
        this.dom.addFileBtn.addEventListener('click', () => this.createNewHtmlNote());
        this.dom.openDriveBtn.addEventListener('click', () => this.openFileFromDrive());
        this.dom.undoBtn.addEventListener('click', () => this.undo());
        this.dom.redoBtn.addEventListener('click', () => this.redo());
        this.dom.cursorPrevBtn.addEventListener('click', () => this.navigateCursorHistory(false));
        this.dom.cursorNextBtn.addEventListener('click', () => this.navigateCursorHistory(true));
        this.dom.searchBtn.addEventListener('click', () => this.toggleSearchView());

        // Editor Events
        [this.dom.htmlCode, this.dom.cssCode, this.dom.jsCode].forEach(editor => {
            editor.addEventListener('input', () => this.handleEditorInput());
            editor.addEventListener('click', () => this.recordCursorPosition());
            editor.addEventListener('keyup', (e) => {
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'PageUp', 'PageDown', 'Home', 'End'].includes(e.key)) {
                    this.recordCursorPosition();
                }
            });
        });
    }

    showWelcomeOrLastNote() {
        const lastNoteId = localStorage.getItem('lifeHub_lastHtmlNoteId_v6.2.0');
        if (this.notes.length > 0 && lastNoteId && this.notes.some(n => n.id === lastNoteId)) {
            this.loadHtmlNoteIntoEditor(lastNoteId);
        } else {
            this.displayWelcomeMessage();
        }
    }

    switchTab(e) {
        if (e.target.tagName !== 'BUTTON') return;
        const tabName = e.target.dataset.tab;
        if (this.activeTab === tabName) return;
        this.dom.codeEditorTabs.querySelector('.active').classList.remove('active');
        e.target.classList.add('active');
        this.dom.codePanels.querySelectorAll('.code-panel').forEach(panel => {
            panel.classList.toggle('hidden', panel.dataset.panel !== tabName);
        });
        this.activeTab = tabName;
    }

    displayWelcomeMessage() {
        this.dom.welcomeMessage.classList.remove('hidden');
        this.dom.htmlEditor.classList.add('hidden');
        this.currentNoteId = null;
    }

    displayHtmlEditor() {
        this.dom.welcomeMessage.classList.add('hidden');
        this.dom.htmlEditor.classList.remove('hidden');
    }

    createNewHtmlNote() {
        this.currentNoteId = `note_${Date.now()}`;
        const newNote = {
            id: this.currentNoteId,
            title: 'Catatan HTML Baru',
            html: `<h1>Halo Dunia!</h1>\n<p>Ini adalah editor HTML Anda.</p>`,
            css: `body {\n    font-family: sans-serif;\n    padding: 20px;\n    background-color: #f0f0f0;\n}\nh1 {\n    color: #333;\n}`,
            js: `console.log("Selamat datang di konsol JavaScript!");`,
            lastEdited: new Date().toISOString()
        };
        this.notes.push(newNote);
        this.saveNotesToStorage();
        this.loadHtmlNoteIntoEditor(this.currentNoteId);
        this.dom.htmlNoteTitle.focus();
        this.dom.htmlNoteTitle.select();
    }

    loadHtmlNoteIntoEditor(noteId) {
        const note = this.notes.find(n => n.id === noteId);
        if (!note) {
            showMessage('Error: Catatan tidak ditemukan.', 'error');
            this.displayWelcomeMessage();
            return;
        }
        this.currentNoteId = note.id;
        localStorage.setItem('lifeHub_lastHtmlNoteId_v6.2.0', note.id);
        this.dom.htmlNoteTitle.value = note.title;
        this.dom.htmlCode.value = note.html;
        this.dom.cssCode.value = note.css;
        this.dom.jsCode.value = note.js;
        this.runCode();
        this.displayHtmlEditor();
        this.clearCursorHistory();
        this.initializeHistory(note.id); // [BARU] Inisialisasi riwayat untuk catatan ini
        this.renderHtmlNotesList();
    }

    runCode() {
        const html = this.dom.htmlCode.value;
        const css = this.dom.cssCode.value;
        const js = this.dom.jsCode.value;
        const jsWithErrorHandling = `
            window.addEventListener('error', function(event) {
                console.error('Caught error from user code:', event.error);
                let errorDiv = document.getElementById('runtime-error-overlay');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = 'runtime-error-overlay';
                    Object.assign(errorDiv.style, {
                        position: 'fixed', top: '10px', left: '10px', padding: '10px',
                        backgroundColor: 'rgba(255, 0, 0, 0.8)', color: 'white',
                        fontFamily: 'monospace', zIndex: '9999', borderRadius: '5px',
                        maxWidth: 'calc(100% - 20px)'
                    });
                    document.body.appendChild(errorDiv);
                }
                errorDiv.innerText = 'JS Error: ' + event.message;
                setTimeout(() => { if (errorDiv) errorDiv.remove(); }, 5000);
            });
            try { ${js} } catch (e) { console.error('Initial execution error:', e); }
        `;
        const combinedHtml = `<!DOCTYPE html><html><head><style>${css}</style></head><body>${html}<script>${jsWithErrorHandling}<\/script></body></html>`;
        this.dom.htmlPreviewIframe.srcdoc = combinedHtml;
    }

    saveCurrentHtmlNote() {
        if (!this.currentNoteId) {
            this.createNewHtmlNote();
        }
        const title = this.dom.htmlNoteTitle.value.trim();
        if (!title) {
            showMessage('Judul catatan tidak boleh kosong.', 'error');
            return;
        }
        const noteData = {
            title: title,
            html: this.dom.htmlCode.value,
            css: this.dom.cssCode.value,
            js: this.dom.jsCode.value,
            lastEdited: new Date().toISOString()
        };
        const index = this.notes.findIndex(n => n.id === this.currentNoteId);
        if (index !== -1) {
            this.notes[index] = { ...this.notes[index], ...noteData };
        } else {
             // Ini seharusnya tidak terjadi jika createNewHtmlNote dipanggil
             this.notes.push({ id: this.currentNoteId, ...noteData });
        }
        this.saveNotesToStorage();
        this.renderHtmlNotesList();
        showMessage(`Catatan "${title}" berhasil disimpan.`, 'success');
    }

    toggleExportMenu(e) {
        e.stopPropagation();
        if (!this.currentNoteId) {
            showMessage('Simpan catatan terlebih dahulu sebelum mengekspor.', 'error');
            return;
        }
        this.dom.exportMenu.classList.toggle('hidden');
    }
    
    closeExportMenu(e) {
        if (!this.dom.exportBtn.contains(e.target) && !this.dom.exportMenu.contains(e.target)) {
            this.dom.exportMenu.classList.add('hidden');
        }
    }

    exportToHtmlFile() {
        if (!this.currentNoteId) { showMessage('Tidak ada catatan untuk diekspor.', 'error'); return; }
        const note = this.notes.find(n => n.id === this.currentNoteId);
        const combinedHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${note.title}</title><style>${note.css}</style></head><body>${note.html}<script>${note.js}<\/script></body></html>`;
        const blob = new Blob([combinedHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${note.title.replace(/\s+/g, '_') || 'catatan'}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage('File .html berhasil diekspor.', 'success');
    }

    exportPreviewToPdfFile() {
        if (!this.currentNoteId) { showMessage('Tidak ada catatan untuk diekspor.', 'error'); return; }
        showMessage('Mempersiapkan PDF dari pratinjau...', 'info');
        const iframe = this.dom.htmlPreviewIframe;
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        html2canvas(iframeDoc.body, { useCORS: true, scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            const note = this.notes.find(n => n.id === this.currentNoteId);
            doc.save(`${note.title.replace(/\s+/g, '_') || 'catatan'}_pratinjau.pdf`);
            showMessage('File PDF dari pratinjau berhasil diekspor.', 'success');
        }).catch(err => {
            console.error("Gagal membuat PDF:", err);
            showMessage('Gagal membuat PDF. Lihat konsol untuk error.', 'error');
        });
    }

    exportCodeToPdfFile() {
        if (!this.currentNoteId) { showMessage('Tidak ada catatan untuk diekspor.', 'error'); return; }
        const note = this.notes.find(n => n.id === this.currentNoteId);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 15;
        const margin = 10;
        const maxWidth = doc.internal.pageSize.getWidth() - margin * 2;

        doc.setFontSize(16);
        doc.text(note.title, margin, y);
        y += 10;

        const addCodeSection = (title, code) => {
            if (y > 270) { doc.addPage(); y = 15; }
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(title, margin, y);
            y += 7;
            doc.setFontSize(8);
            doc.setFont('courier', 'normal');
            const lines = doc.splitTextToSize(code, maxWidth);
            lines.forEach(line => {
                if (y > 280) {
                    doc.addPage();
                    y = 15;
                }
                doc.text(line, margin, y);
                y += 4;
            });
            y += 5;
        };

        if (note.html) addCodeSection('HTML', note.html);
        if (note.css) addCodeSection('CSS', note.css);
        if (note.js) addCodeSection('JavaScript', note.js);

        doc.save(`${note.title.replace(/\s+/g, '_') || 'catatan'}_kode.pdf`);
        showMessage('File PDF dari kode berhasil diekspor.', 'success');
    }

    saveNotesToStorage() {
        localStorage.setItem('lifeHub_htmlNotes_v6.2.0', JSON.stringify(this.notes));
    }

    loadNotesFromStorage() {
        const savedNotes = localStorage.getItem('lifeHub_htmlNotes_v6.2.0');
        if (savedNotes) {
            this.notes = JSON.parse(savedNotes);
            this.renderHtmlNotesList();
        }
    }

    renderHtmlNotesList() {
        const searchQuery = this.dom.searchHtmlNotesInput.value.toLowerCase();
        const filteredNotes = this.notes.filter(note => note.title.toLowerCase().includes(searchQuery));
        
        if (filteredNotes.length === 0) {
            this.dom.htmlNotesList.innerHTML = '<p class="text-center text-gray-500">Tidak ada catatan yang cocok.</p>';
            return;
        }
        this.dom.htmlNotesList.innerHTML = filteredNotes
            .sort((a, b) => new Date(b.lastEdited) - new Date(a.lastEdited))
            .map(note => `
                <div class="html-note-item p-3 rounded-lg cursor-pointer ${note.id === this.currentNoteId ? 'active' : ''}" data-id="${note.id}">
                    <div class="flex justify-between items-start">
                        <div>
                            <strong class="text-md text-purple-300">${note.title}</strong>
                            <span class="block text-xs text-gray-400">${new Date(note.lastEdited).toLocaleString('id-ID')}</span>
                        </div>
                        <button class="delete-html-note-btn text-red-500 hover:text-red-400 text-xs" data-id="${note.id}" title="Hapus Catatan">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        this.dom.htmlNotesList.querySelectorAll('.html-note-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.closest('.delete-html-note-btn')) return;
                this.loadHtmlNoteIntoEditor(item.dataset.id);
            });
        });
        this.dom.htmlNotesList.querySelectorAll('.delete-html-note-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.deleteHtmlNote(btn.dataset.id);
            });
        });
    }

    deleteHtmlNote(noteId) {
        const noteToDelete = this.notes.find(n => n.id === noteId);
        if (!noteToDelete) return;
        showConfirm(`Hapus Catatan HTML?`, `Yakin ingin menghapus "${noteToDelete.title}"?`, () => {
            this.notes = this.notes.filter(note => note.id !== noteId);
            this.saveNotesToStorage();
            this.renderHtmlNotesList();
            if (this.currentNoteId === noteId) {
                this.currentNoteId = null;
                localStorage.removeItem('lifeHub_lastHtmlNoteId_v6.2.0');
                this.displayWelcomeMessage();
            }
            showMessage('Catatan HTML berhasil dihapus.', 'success');
        });
    }

    toggleFullscreen() {
        const elem = this.dom.previewPanel;
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
            this.dom.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            document.exitFullscreen();
            this.dom.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
    }

    toggleAutoRefresh(isEnabled) {
        this.autoRefreshEnabled = isEnabled;
        if (isEnabled) {
            this.runCode();
            showMessage('Auto-refresh diaktifkan.', 'success');
        } else {
            showMessage('Auto-refresh dinonaktifkan.', 'info');
        }
    }

    handleEditorInput() {
        if (this.autoRefreshEnabled) {
            clearTimeout(this.debounceTimeout);
            this.debounceTimeout = setTimeout(() => {
                this.runCode();
            }, 500); // 500ms debounce
        }
        this.recordHistory();
        this.recordCursorPosition();
    }

    getActiveEditor() {
        return this.dom.codePanels.querySelector(`.code-panel:not(.hidden) textarea`);
    }

    // [BARU] Fungsi untuk Undo/Redo
    initializeHistory(noteId) {
        if (!this.history[noteId]) {
            const initial_state = {
                html: this.dom.htmlCode.value,
                css: this.dom.cssCode.value,
                js: this.dom.jsCode.value,
                activeTab: this.activeTab,
                cursor: this.getActiveEditor().selectionStart
            };
            this.history[noteId] = {
                stack: [initial_state],
                index: 0
            };
        }
        this.updateUndoRedoButtons();
    }

    recordHistory() {
        if (this.isNavigatingHistory || !this.currentNoteId) return;
        
        const noteHistory = this.history[this.currentNoteId];
        if (!noteHistory) return;

        const currentState = {
            html: this.dom.htmlCode.value,
            css: this.dom.cssCode.value,
            js: this.dom.jsCode.value,
            activeTab: this.activeTab,
            cursor: this.getActiveEditor().selectionStart
        };

        // Hapus riwayat "masa depan" jika ada perubahan baru
        if (noteHistory.index < noteHistory.stack.length - 1) {
            noteHistory.stack = noteHistory.stack.slice(0, noteHistory.index + 1);
        }

        // Hindari duplikasi state yang sama persis
        const lastState = noteHistory.stack[noteHistory.stack.length - 1];
        if (lastState && lastState.html === currentState.html && lastState.css === currentState.css && lastState.js === currentState.js) {
            return;
        }

        noteHistory.stack.push(currentState);
        noteHistory.index = noteHistory.stack.length - 1;

        this.updateUndoRedoButtons();
    }

    applyHistoryState(state) {
        this.isNavigatingHistory = true;
        this.dom.htmlCode.value = state.html;
        this.dom.cssCode.value = state.css;
        this.dom.jsCode.value = state.js;

        if (this.activeTab !== state.activeTab) {
            this.dom.codeEditorTabs.querySelector(`[data-tab="${state.activeTab}"]`).click();
        }
        
        setTimeout(() => {
            const editor = this.getActiveEditor();
            editor.focus();
            editor.setSelectionRange(state.cursor, state.cursor);
            this.isNavigatingHistory = false;
        }, 0);
    }

    undo() {
        if (!this.currentNoteId) return;
        const noteHistory = this.history[this.currentNoteId];
        if (noteHistory && noteHistory.index > 0) {
            noteHistory.index--;
            this.applyHistoryState(noteHistory.stack[noteHistory.index]);
            this.updateUndoRedoButtons();
        }
    }

    redo() {
        if (!this.currentNoteId) return;
        const noteHistory = this.history[this.currentNoteId];
        if (noteHistory && noteHistory.index < noteHistory.stack.length - 1) {
            noteHistory.index++;
            this.applyHistoryState(noteHistory.stack[noteHistory.index]);
            this.updateUndoRedoButtons();
        }
    }

    updateUndoRedoButtons() {
        if (!this.currentNoteId) {
            this.dom.undoBtn.disabled = true;
            this.dom.redoBtn.disabled = true;
            return;
        }
        const noteHistory = this.history[this.currentNoteId];
        this.dom.undoBtn.disabled = !noteHistory || noteHistory.index <= 0;
        this.dom.redoBtn.disabled = !noteHistory || noteHistory.index >= noteHistory.stack.length - 1;
    }

    // [BARU] Fungsi untuk membuka file dari Drive
    openFileFromDrive() {
        if (!checkPremiumAccess()) return;
        showManageFilesModal({
            isPicker: true,
            onFilePicked: async (file) => {
                if (!file.mimeType.startsWith('text/')) {
                    showMessage('Hanya file teks (html, css, js, txt) yang dapat dibuka di editor.', 'error');
                    return;
                }
                showMessage(`Membuka file "${file.name}"...`, 'info');
                try {
                    const content = await getFileContent(file.id);
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    
                    this.createNewHtmlNote(); // Siapkan catatan baru
                    this.dom.htmlNoteTitle.value = file.name;

                    if (fileExt === 'html') {
                        this.dom.htmlCode.value = content;
                    } else if (fileExt === 'css') {
                        this.dom.cssCode.value = content;
                    } else if (fileExt === 'js') {
                        this.dom.jsCode.value = content;
                    } else {
                        // Untuk file teks lain, masukkan ke HTML sebagai default
                        this.dom.htmlCode.value = `<pre>${content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`;
                    }
                    this.saveCurrentHtmlNote();
                    this.runCode();

                } catch (error) {
                    showMessage(`Gagal membuka file: ${error.message}`, 'error');
                }
            }
        });
    }

    recordCursorPosition() {
        if (this.isNavigatingCursorHistory) return;
        const editor = this.getActiveEditor();
        const position = {
            tab: this.activeTab,
            pos: editor.selectionStart
        };
        
        if (this.currentCursorIndex < this.cursorHistory.length - 1) {
            this.cursorHistory = this.cursorHistory.slice(0, this.currentCursorIndex + 1);
        }

        const lastPos = this.cursorHistory[this.cursorHistory.length - 1];
        if (!lastPos || lastPos.tab !== position.tab || lastPos.pos !== position.pos) {
            this.cursorHistory.push(position);
            this.currentCursorIndex = this.cursorHistory.length - 1;
        }
        this.updateCursorNavButtons();
    }

    navigateCursorHistory(forward) {
        if (forward) {
            if (this.currentCursorIndex < this.cursorHistory.length - 1) {
                this.currentCursorIndex++;
            }
        } else {
            if (this.currentCursorIndex > 0) {
                this.currentCursorIndex--;
            }
        }

        const position = this.cursorHistory[this.currentCursorIndex];
        if (position) {
            this.isNavigatingCursorHistory = true;
            if (this.activeTab !== position.tab) {
                this.dom.codeEditorTabs.querySelector(`[data-tab="${position.tab}"]`).click();
            }
            
            setTimeout(() => {
                const editor = this.getActiveEditor();
                editor.focus();
                editor.setSelectionRange(position.pos, position.pos);
                this.isNavigatingCursorHistory = false;
            }, 0);
        }
        this.updateCursorNavButtons();
    }

    clearCursorHistory() {
        this.cursorHistory = [];
        this.currentCursorIndex = -1;
        this.updateCursorNavButtons();
    }

    updateCursorNavButtons() {
        this.dom.cursorPrevBtn.disabled = this.currentCursorIndex <= 0;
        this.dom.cursorNextBtn.disabled = this.currentCursorIndex >= this.cursorHistory.length - 1;
    }

    toggleSearchView() {
        const wrapper = this.dom.searchWrapper;
        const isVisible = wrapper.style.display === 'block';
        wrapper.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) {
            this.dom.searchInput.focus();
        }
    }
}

// --- WATERMARK SCRIPT START ---
(function() {
    function initializeWatermark() {
        const watermarkHTML = `
          <div id="futuristic-watermark" title="Design by ©URANUSFAZRY">
            <canvas id="particle-canvas"></canvas>
            <div class="f-content-wrapper">
              <div id="f-main-content" class="f-content">
                <div class="f-logo-container">
                  <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20 20 L80 20 L80 80 L20 80 Z" stroke-opacity="0.5"/>
                      <path d="M50 5 L95 50 L50 95 L5 50 Z"/>
                  </svg>
                </div>
                <span id="f-watermark-text">©URANUSFAZRY</span>
              </div>
              <div id="f-follow-content" class="f-content hidden">
                  <span id="f-follow-message"></span>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', watermarkHTML);

        const watermarkEl = document.getElementById('futuristic-watermark');
        const textEl = document.getElementById('f-watermark-text');
        const logoEl = watermarkEl.querySelector('.f-logo-container');
        const mainContentEl = document.getElementById('f-main-content');
        const followContentEl = document.getElementById('f-follow-content');
        const followMessageEl = document.getElementById('f-follow-message');
        
        let isAnimating = false;
        let autoPlayInterval = null;
        let currentSequence = 0;
        const sequenceActions = ['scramble', 'logo', 'youtube', 'tiktok', 'reset'];

        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        const resizeCanvas = () => { if (watermarkEl) { canvas.width = watermarkEl.offsetWidth; canvas.height = watermarkEl.offsetHeight; } };
        class Particle {
            constructor() { this.reset(); this.baseSpeedX = (Math.random() - 0.5) * 0.5; this.baseSpeedY = (Math.random() - 0.5) * 0.5; this.speedX = this.baseSpeedX; this.speedY = this.baseSpeedY; }
            update() {
                this.x += this.speedX; this.y += this.speedY; this.opacity -= this.fadeSpeed;
                if (this.opacity <= 0 || this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) { this.reset(); }
            }
            draw() {
                const style = getComputedStyle(watermarkEl);
                const hue = style.getPropertyValue('--particle-base-hue').trim();
                const lightness = parseFloat(style.getPropertyValue('--particle-base-lightness').trim());
                ctx.globalAlpha = this.opacity;
                ctx.fillStyle = `hsl(${hue}, 100%, ${lightness + this.opacity * 40}%)`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
            reset() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.opacity = Math.random() * 0.5 + 0.2; this.size = Math.random() * 1.5 + 0.5; this.fadeSpeed = Math.random() * 0.015 + 0.005; }
        }
        const animateParticles = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); ctx.globalAlpha = 1.0; requestAnimationFrame(animateParticles); };
        
        const textScramble = (el) => {
            const originalText = "©URANUSFAZRY";
            const chars = '!<>*#{}[]'; let frame = 0; isAnimating = true;
            const interval = setInterval(() => {
                el.innerText = originalText.split('').map((char, i) => { const p = (frame - i * 2) / 15; if (p < 0) return ' '; if (p > 1) return char; return chars[Math.floor(Math.random() * chars.length)]; }).join('');
                if (frame >= originalText.length * 2 + 15) { clearInterval(interval); el.innerText = originalText; isAnimating = false; } frame++;
            }, 30);
        };

        const typewriter = (el, text) => {
            let i = 0; el.innerHTML = ""; isAnimating = true;
            const interval = setInterval(() => {
                if (i < text.length) { el.innerHTML += text.charAt(i); i++; } 
                else { clearInterval(interval); isAnimating = false; }
            }, 50);
        };

        const runAutoSequence = () => {
            if (isAnimating) return;
            const action = sequenceActions[currentSequence];
            switch (action) {
                case 'scramble': textScramble(textEl); break;
                case 'logo':
                    isAnimating = true;
                    logoEl.classList.add('reacting');
                    logoEl.addEventListener('animationend', () => { logoEl.classList.remove('reacting'); isAnimating = false; }, { once: true });
                    break;
                case 'youtube':
                    isAnimating = true;
                    mainContentEl.classList.add('hidden');
                    setTimeout(() => {
                        followContentEl.classList.remove('hidden');
                        typewriter(followMessageEl, "Follow uranusfazry YouTube");
                    }, 400);
                    break;
                case 'tiktok': 
                    typewriter(followMessageEl, "Follow uranusfazry TikTok"); 
                    break;
                case 'reset':
                    isAnimating = true;
                    followContentEl.classList.add('hidden');
                    setTimeout(() => {
                        mainContentEl.classList.remove('hidden');
                        isAnimating = false;
                    }, 400);
                    break;
            }
            currentSequence = (currentSequence + 1) % sequenceActions.length;
        };

        const startAutoPlay = () => {
            if (autoPlayInterval) clearInterval(autoPlayInterval);
            runAutoSequence();
            autoPlayInterval = setInterval(runAutoSequence, 3500);
        };
        
        // Sync watermark theme with main theme
        const syncTheme = () => {
            if (document.body.classList.contains('light-mode')) {
                watermarkEl.classList.add('light-mode');
            } else {
                watermarkEl.classList.remove('light-mode');
            }
        };
        
        // Observe body class changes to sync theme
        const observer = new MutationObserver(syncTheme);
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

        const init = () => {
            resizeCanvas();
            for (let i = 0; i < 40; i++) particles.push(new Particle());
            animateParticles();
            window.addEventListener('resize', resizeCanvas);
            startAutoPlay();
            syncTheme(); // Initial sync
        };
        init();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWatermark);
    } else {
        initializeWatermark();
    }
})();
// --- WATERMARK SCRIPT END ---
</script>
</body>
</html>
